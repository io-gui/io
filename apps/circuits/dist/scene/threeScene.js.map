{"version":3,"file":"threeScene.js","sourceRoot":"","sources":["../../src/scene/threeScene.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n  AmbientLight,\n  BoxGeometry,\n  CapsuleGeometry,\n  Color,\n  Group,\n  InstancedMesh,\n  Matrix4,\n  MeshPhongMaterial,\n  Object3D,\n  PerspectiveCamera,\n  PointLight,\n  Quaternion,\n  SphereGeometry,\n  Vector2,\n  Vector3,\n} from 'three/webgpu'\nimport { Register } from '@io-gui/core'\nimport { ThreeApplet, ThreeAppletProps } from '@io-gui/three'\nimport { Pad } from '../game/items/pad'\nimport { Line } from '../game/items/line'\nimport { Terminal, TERMINAL_COLORS } from '../game/items/terminal'\nimport type { TerminalColor } from '../game/items/terminal'\nimport { Grid } from '../objects/grid'\n\nconst PAD_SPHERE_RADIUS = 0.25\nconst TERMINAL_BOX_SIZE = 0.5\nconst LINE_CAPSULE_RADIUS = 0.12\nconst LINE_CAPSULE_AXIS_LENGTH = 1\nconst LINE_DIAGONAL_INSET = 0.035\nconst LINE_LAYER_BEHIND_Z = -0.25\nconst LINE_LAYER_MINUS_ONE_WIDTH_FACTOR = 1.5\nconst LINE_LAYER_MINUS_ONE_COLOR_FACTOR = 0.25\n\nconst _yAxis = new Vector3(0, 1, 0)\nconst _targetVector = new Vector3()\nconst _segmentDir = new Vector3()\nconst _segmentQuat = new Quaternion()\nconst _segmentScale = new Vector3()\nconst _segmentPosition = new Vector3()\n\n@Register\nexport class ThreeScene extends ThreeApplet {\n\n  public camera: PerspectiveCamera = new PerspectiveCamera( 25, 1, 0.1, 1000 )\n  public cameraRig: Group = new Group()\n  public cameraTarget: Object3D = new Object3D()\n  public grid: Grid = new Grid()\n  public pads: InstancedMesh\n  public terminals: InstancedMesh\n  public lines: InstancedMesh\n\n  static padGeometry: SphereGeometry = new SphereGeometry(PAD_SPHERE_RADIUS, 16, 12)\n  static padMaterial: MeshPhongMaterial = new MeshPhongMaterial({ vertexColors: true })\n  static terminalGeometry: BoxGeometry = new BoxGeometry(TERMINAL_BOX_SIZE, TERMINAL_BOX_SIZE, TERMINAL_BOX_SIZE * 0.6)\n  static terminalMaterial: MeshPhongMaterial = new MeshPhongMaterial({ vertexColors: true })\n  static lineGeometry: CapsuleGeometry = new CapsuleGeometry(LINE_CAPSULE_RADIUS, LINE_CAPSULE_AXIS_LENGTH, 4, 8)\n  static lineMaterial: MeshPhongMaterial = new MeshPhongMaterial({ vertexColors: true })\n\n  public _drag: Vector3 = new Vector3()\n\n  private static instanceColor(terminalColor: TerminalColor): Color {\n    return new Color(TERMINAL_COLORS[terminalColor] ?? TERMINAL_COLORS.white)\n  }\n\n  constructor(args: ThreeAppletProps) {\n    super(args)\n\n    this.scene.add(this.cameraRig)\n    this.cameraRig.add(this.camera)\n    this.cameraRig.add(this.cameraTarget)\n\n    this.scene.add(this.grid)\n\n    this.pads = new InstancedMesh(ThreeScene.padGeometry, ThreeScene.padMaterial, 0)\n    this.terminals = new InstancedMesh(ThreeScene.terminalGeometry, ThreeScene.terminalMaterial, 0)\n    this.lines = new InstancedMesh(ThreeScene.lineGeometry, ThreeScene.lineMaterial, 0)\n\n    const ambientLight = new AmbientLight( 0xcccccc, 1.5 )\n    this.scene.add( ambientLight )\n\n    const pointLight = new PointLight( 0xffffff, 2.5, 0, 0 )\n    pointLight.position.set( 0, 0, 500 )\n    this.scene.add( pointLight )\n  }\n\n  updateDrag(screen: Vector2, screenStart: Vector2) {\n    this._drag.set(screen.x - screenStart.x, screen.y - screenStart.y, 0)\n  }\n\n  initGrid(width: number, height: number) {\n    this.camera.aspect = width / height\n    // calculate distance to contain grid in view\n    const halfFovRad = this.camera.fov * Math.PI / 360\n    const gridDistance = height / (2 * Math.tan(halfFovRad))\n    this.cameraRig.position.set(width / 2, height / 2, 0)\n    this.camera.position.set(0, 0, gridDistance)\n  }\n  updateGrid(width: number, height: number, lines: Line[], pads: Pad[], terminals: Terminal[]) {\n    this.grid.update(width, height, lines, pads, terminals)\n  }\n\n  // TODO: Consider empty instanced arrays\n\n  updatePads(pads: Pad[]) {\n    if (this.pads.parent) {\n      this.scene.remove(this.pads)\n      if (pads.length === 0) return\n    }\n\n    this.pads = new InstancedMesh(ThreeScene.padGeometry, ThreeScene.padMaterial, pads.length)\n    const matrix = new Matrix4()\n    const padColor = new Color()\n    for (let i = 0; i < pads.length; i++) {\n      matrix.makeTranslation(pads[i].pos[0], pads[i].pos[1], 0)\n      this.pads.setMatrixAt(i, matrix)\n      padColor.copy(ThreeScene.instanceColor(pads[i].color))\n      this.pads.setColorAt(i, padColor)\n    }\n    this.pads.instanceMatrix.needsUpdate = true\n    if (this.pads.instanceColor) this.pads.instanceColor.needsUpdate = true\n    this.scene.add(this.pads)\n  }\n\n  updateTerminals(terminals: Terminal[]) {\n    if (this.terminals.parent) {\n      this.scene.remove(this.terminals)\n    }\n    this.terminals = new InstancedMesh(\n      ThreeScene.terminalGeometry,\n      ThreeScene.terminalMaterial,\n      terminals.length\n    )\n    const matrix = new Matrix4()\n    const terminalColor = new Color()\n    for (let i = 0; i < terminals.length; i++) {\n      matrix.makeTranslation(terminals[i].pos[0], terminals[i].pos[1], 0)\n      this.terminals.setMatrixAt(i, matrix)\n      terminalColor.copy(ThreeScene.instanceColor(terminals[i].color))\n      this.terminals.setColorAt(i, terminalColor)\n    }\n    this.terminals.instanceMatrix.needsUpdate = true\n    if (this.terminals.instanceColor) this.terminals.instanceColor.needsUpdate = true\n    this.scene.add(this.terminals)\n  }\n  updateLines(lines: Line[]) {\n    if (this.lines.parent) {\n      this.scene.remove(this.lines)\n    }\n    const segmentCount = lines.reduce((n, line) => n + Math.max(0, line.pos.length - 1), 0)\n    this.lines = new InstancedMesh(\n      ThreeScene.lineGeometry,\n      ThreeScene.lineMaterial,\n      segmentCount\n    )\n    const matrix = new Matrix4()\n    const lineColor = new Color()\n    let idx = 0\n    for (const line of lines) {\n      lineColor.copy(ThreeScene.instanceColor(line.color))\n      if (line.layer === -1) {\n        lineColor.multiplyScalar(LINE_LAYER_MINUS_ONE_COLOR_FACTOR)\n      }\n      const pos = line.pos\n      const isBehind = line.layer === -1\n      const widthScale = isBehind ? LINE_LAYER_MINUS_ONE_WIDTH_FACTOR : 1\n      const segmentZ = isBehind ? LINE_LAYER_BEHIND_Z : 0\n      for (let j = 0; j < pos.length - 1; j++) {\n        const ax = pos[j][0]\n        const ay = pos[j][1]\n        const bx = pos[j + 1][0]\n        const by = pos[j + 1][1]\n        _segmentPosition.set((ax + bx) / 2, (ay + by) / 2, segmentZ)\n        const dx = bx - ax\n        const dy = by - ay\n        const segmentLength = Math.sqrt(dx * dx + dy * dy) || 1\n        const isDiagonal = segmentLength > 1.01\n        const effectiveLength = isDiagonal ? segmentLength - 2 * LINE_DIAGONAL_INSET : segmentLength\n        _segmentDir.set(dx / segmentLength, dy / segmentLength, 0)\n        _segmentQuat.setFromUnitVectors(_yAxis, _segmentDir)\n        _segmentScale.set(widthScale, effectiveLength / LINE_CAPSULE_AXIS_LENGTH, widthScale)\n        matrix.compose(\n          _segmentPosition,\n          _segmentQuat,\n          _segmentScale\n        )\n        this.lines.setMatrixAt(idx, matrix)\n        this.lines.setColorAt(idx, lineColor)\n        idx++\n      }\n    }\n    this.lines.instanceMatrix.needsUpdate = true\n    if (this.lines.instanceColor) this.lines.instanceColor.needsUpdate = true\n    this.scene.add(this.lines)\n  }\n\n  // eslint-disable-next-line @typescript-eslint/no-unused-vars\n  onAnimate(delta: number, time: number) {\n    this.camera.position.x = ((this.camera.position.x * 9) + this._drag.x * 0.25 * this.grid.width) / 10\n    this.camera.position.y = ((this.camera.position.y * 9) + this._drag.y * 0.25 * this.grid.height) / 10\n\n    this.cameraTarget.position.x = ((this.cameraTarget.position.x * 9) + this._drag.x * 0.02 * this.grid.width) / 10\n    this.cameraTarget.position.y = ((this.cameraTarget.position.y * 9) + this._drag.y * 0.02 * this.grid.height) / 10\n\n    this.camera.lookAt(_targetVector.setFromMatrixPosition(this.cameraTarget.matrixWorld))\n  }\n\n}\n"]}