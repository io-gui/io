{"version":3,"file":"StateTextureMaterialBase.js","sourceRoot":"","sources":["../../../src/scene/materials/StateTextureMaterialBase.ts"],"names":[],"mappings":"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","sourcesContent":["import { InstancedBufferAttribute, MeshBasicNodeMaterial, type Texture } from 'three/webgpu'\nimport { instancedBufferAttribute, texture, uniform, vec4 } from 'three/tsl'\n\nexport type StateTextureIndex = 0 | 1 | 2\n\nexport class StateTextureMaterialBase extends MeshBasicNodeMaterial {\n  private _padsTexture: Texture\n  private _layer0Texture: Texture\n  private _layer1Texture: Texture\n  private _instanceUVAttribute: InstancedBufferAttribute\n\n  public readonly textureIndex = uniform(0)\n  public readonly brightness = uniform(1)\n\n  constructor(\n    padsTexture: Texture,\n    layer0Texture: Texture,\n    layer1Texture: Texture,\n    textureIndex: StateTextureIndex,\n    brightness = 1\n  ) {\n    super({toneMapped: false, transparent: false})\n    this.vertexColors = false\n    this._padsTexture = padsTexture\n    this._layer0Texture = layer0Texture\n    this._layer1Texture = layer1Texture\n    this._instanceUVAttribute = new InstancedBufferAttribute(new Float32Array([0.5, 0.5, 0]), 3)\n    this.textureIndex.value = textureIndex\n    this.brightness.value = brightness\n    this._rebuildColorNode()\n  }\n\n  setTextures(padsTexture: Texture, layer0Texture: Texture, layer1Texture: Texture) {\n    const changed = this._padsTexture !== padsTexture\n      || this._layer0Texture !== layer0Texture\n      || this._layer1Texture !== layer1Texture\n    if (!changed) return\n    this._padsTexture = padsTexture\n    this._layer0Texture = layer0Texture\n    this._layer1Texture = layer1Texture\n    this._rebuildColorNode()\n  }\n\n  setInstanceUVAttribute(instanceUVAttribute: InstancedBufferAttribute) {\n    if (this._instanceUVAttribute === instanceUVAttribute) return\n    this._instanceUVAttribute = instanceUVAttribute\n    this._rebuildColorNode()\n  }\n\n  setTextureIndex(index: StateTextureIndex) {\n    this.textureIndex.value = index\n  }\n\n  private _rebuildColorNode() {\n    const instanceUV = instancedBufferAttribute(this._instanceUVAttribute).xy\n    const padsNode = texture(this._padsTexture, instanceUV)\n    const layer0Node = texture(this._layer0Texture, instanceUV)\n    const layer1Node = texture(this._layer1Texture, instanceUV)\n    const selector = this.textureIndex.clamp(0, 2)\n\n    const padsWeight = selector.sub(0).abs().oneMinus().clamp()\n    const layer0Weight = selector.sub(1).abs().oneMinus().clamp()\n    const layer1Weight = selector.sub(2).abs().oneMinus().clamp()\n\n    const stateColor = padsNode.mul(padsWeight)\n      .add(layer0Node.mul(layer0Weight))\n      .add(layer1Node.mul(layer1Weight))\n\n    this.outputNode = vec4(stateColor.rgb.mul(this.brightness), 1)\n    this.needsUpdate = true\n  }\n}\n\n"]}