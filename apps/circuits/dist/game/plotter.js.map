{"version":3,"file":"plotter.js","sourceRoot":"","sources":["../../src/game/plotter.ts"],"names":[],"mappings":"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","sourcesContent":["import { ReactiveNode, Register } from '@io-gui/core'\nimport { Pad } from './items/pad.js'\nimport { Terminal, type TerminalColor } from './items/terminal.js'\nimport { Line } from './items/line.js'\n\nexport interface PointAt {\n  id: number\n  isTerminal: boolean\n}\n\n/**\n * Plotter â€” position and geometry only.\n * Intersection checks, adding/removing pads, terminals, and lines.\n * No color, propagation, or completion.\n */\n@Register\nexport class Plotter extends ReactiveNode {\n  width = 0\n  height = 0\n  pads: Pad[] = []\n  terminals: Terminal[] = []\n  lines: Line[] = []\n\n  connect(pads: Pad[], terminals: Terminal[], lines: Line[], width: number, height: number) {\n    this.width = width\n    this.height = height\n    this.pads = pads\n    this.terminals = terminals\n    this.lines = lines\n  }\n\n  getPointAt(x: number, y: number): Pad | Terminal | undefined {\n    for (const pad of this.pads) {\n      if (pad.pos[0] === x && pad.pos[1] === y)\n        return pad\n    }\n    for (const term of this.terminals) {\n      if (term.pos[0] === x && term.pos[1] === y)\n        return term\n    }\n  }\n\n  getLinesAtPoint(x: number, y: number, filter?: (line: Line) => boolean): Line[] {\n    const lines = []\n    for (const line of this.lines) {\n      if (line.pos.some(([px, py]) => px === x && py === y) && (filter?.(line) ?? true)) {\n        lines.push(line)\n      }\n    }\n    return lines\n  }\n\n  getLineById(id: number): Line | undefined {\n    return this.lines.find((l) => l.id === id)\n  }\n\n  checkDiagonalCrossing(line: Line, x: number, y: number): boolean {\n    const last = line.pos[line.pos.length - 1]\n    const mx = (x + last[0]) / 2\n    const my = (y + last[1]) / 2\n    for (const other of this.lines) {\n      if (other.layer !== line.layer) continue\n      if (other.hasDiagonalSegmentAt(mx, my)) return false\n    }\n    return true\n  }\n\n  addPad(id: number, x: number, y: number): boolean {\n    if (this.getPointAt(x, y)) return false\n    this.pads.push(new Pad(id, [x, y]))\n    this.dispatch('game-update', undefined, true)\n    return true\n  }\n\n  addTerminal(id: number, x: number, y: number, color: TerminalColor): boolean {\n    if (this.getPointAt(x, y)) return false\n    this.terminals.push(new Terminal(id, [x, y], color))\n    this.dispatch('game-update', undefined, true)\n    return true\n  }\n\n  delete(x: number, y: number) {\n    const padIdx = this.pads.findIndex((p) => p.pos[0] === x && p.pos[1] === y)\n    if (padIdx !== -1) {\n      this.pads.splice(padIdx, 1)\n    }\n    const termIdx = this.terminals.findIndex(\n      (t) => t.pos[0] === x && t.pos[1] === y,\n    )\n    if (termIdx !== -1) {\n      this.terminals.splice(termIdx, 1)\n    }\n    const lineIdx = this.lines.findIndex((l) =>\n      l.pos.some(([px, py]) => px === x && py === y),\n    )\n    if (lineIdx !== -1) {\n      this.lines.splice(lineIdx, 1)\n    }\n    this.dispatch('game-update', undefined, true)\n  }\n\n  verifyLineLegality(id: number): boolean {\n    const line = this.getLineById(id)\n    if (line) {\n      const first = line.pos[0]\n      const last = line.pos[line.pos.length - 1]\n      const p1 = this.getPointAt(first[0], first[1])\n      const p2 = this.getPointAt(last[0], last[1])\n      if (!p1 || !p2 || (first[0] === last[0] && first[1] === last[1])) {\n        const idx = this.lines.findIndex((l) => l.id === id)\n        if (idx !== -1) this.lines.splice(idx, 1)\n        return false\n      }\n      return true\n    }\n    return false\n  }\n\n  isInBounds(x: number, y: number): boolean {\n    return x >= 0 && x <= this.width && y >= 0 && y <= this.height\n  }\n\n  addLineSegment(id: number, x: number, y: number, layer: number): { added: boolean; endDrag: boolean } {\n    if (!this.isInBounds(x, y)) return { added: false, endDrag: false }\n\n    // Lookup what's at target cell\n    const point = this.getPointAt(x, y)\n    const linesAtPoint = this.getLinesAtPoint(x, y, (line) => (line.layer === 0))\n    const underlineLinesAtPoint = this.getLinesAtPoint(x, y, (line) => line.layer === -1)\n    // Terminals accept 1 connection, pads accept 2, empty cells accept 0\n    const connectionLimit = point ? (point instanceof Terminal ? 1 : 2) : 0\n\n    let added = false\n    let endDrag = false\n\n    // Reject if point is already at connection capacity\n    if (point && (linesAtPoint.length + underlineLinesAtPoint.length) >= connectionLimit) {\n      return { added, endDrag }\n    }\n\n    const line = this.getLineById(id)\n\n    if (line) {\n      // --- Extending existing line ---\n\n      // Reject if diagonal would cross another diagonal on same layer\n      if (!this.checkDiagonalCrossing(line, x, y)) {\n        return { added, endDrag }\n      }\n\n      // Reject self-intersection (exclude last 2 points to preserve backtracking)\n      const posCount = line.pos.length\n      if (line.pos.some(([px, py], i) => px === x && py === y && i < posCount - 2)) {\n        return { added, endDrag }\n      }\n\n      const sameLineAtPoint = this.getLinesAtPoint(x, y, (line) => (line.id === id && line.layer === 0))?.[0] || null\n\n      // Empty cell: allow if no foreign line occupies it (or underline layer bypasses)\n      if (!point && ((!linesAtPoint.length || sameLineAtPoint) || layer === -1)) {\n        added = line.plotSegment(x, y)\n      }\n\n      // Reached a pad/terminal: snap to it and end drag (color must be compatible)\n      if (point) {\n        if (point.color !== 'white' && line.color !== 'white' && point.color !== line.color) {\n          return { added: false, endDrag: false }\n        }\n        added = line.plotSegment(x, y)\n        endDrag = true\n      }\n\n    } else {\n      // --- Starting new line: must begin on a pad or terminal ---\n\n      if (!point) return { added: false, endDrag: false }\n      const newLine = new Line(id, [[x, y]], layer)\n      newLine.color = point.color\n      this.lines.push(newLine)\n      added = true\n\n    }\n\n    if (endDrag) {\n      this.dispatch('line-end-drag', {id}, true)\n    }\n\n    this.dispatch('game-update', undefined, true)\n    return { added, endDrag }\n  }\n}\n"]}