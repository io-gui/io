{"version":3,"file":"plotter.js","sourceRoot":"","sources":["../../src/game/plotter.ts"],"names":[],"mappings":"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","sourcesContent":["import { ReactiveNode, Register } from '@io-gui/core'\nimport { Vector2 } from 'three/webgpu'\nimport { COLORS } from './items/colors.js'\nimport { Line } from './items/line.js'\nimport { Pads } from './pads.js'\nimport { Layer } from './layer.js'\n\nconst SQRT_2 = Math.sqrt(2)\n\n/**\n * Plotter â€” position and geometry only.\n * Intersection checks, adding/removing pads, terminals, and lines.\n * No color, propagation, or completion.\n */\n@Register\nexport class Plotter extends ReactiveNode {\n  width = 0\n  height = 0\n  pads: Pads = new Pads()\n  layer0: Layer = new Layer()\n  layer1: Layer = new Layer()\n\n  declare private _activeLayer: Layer\n\n  connect(pads: Pads, layer0: Layer, layer1: Layer) {\n    this.pads = pads\n    this.layer0 = layer0\n    this.layer1 = layer1\n  }\n\n  finalizeLine(): boolean {\n    const lastLine = this._activeLayer.lastLine\n    if (!lastLine) return false\n    if (lastLine.isFinalized)return false\n\n    const connected = this.isLineCompleated(lastLine)\n    if (!connected) this._activeLayer.delete(lastLine)\n    else lastLine.finalize()\n    return connected\n  }\n\n  private isLineCompleated(line: Line): boolean {\n    const first = line.pos[0]\n    const last = line.lastPt\n    const p1 = this.pads.getAt(first.x, first.y)\n    const p2 = this.pads.getAt(last.x, last.y)\n    return Boolean(p1 && p2 && (first.x !== last.x || first.y !== last.y))\n  }\n\n  plotLineTo(point: Vector2, layer: number) {\n    this._activeLayer = layer === 0 ? this.layer0 : this.layer1\n    let line = this._activeLayer.lastLine\n    if (!line) return false\n    if (line.isFinalized)return false\n\n    let extended = false\n\n    while (!line.lastPt.equals(point) && !line.isFinalized) {\n      const nextPoint = this.getNextStepToward(line.lastPt, point)\n      const added = this.extendLineTo(nextPoint, layer)\n      if (!added) break\n      extended = true\n      line = this._activeLayer.lastLine\n      if (!line) break\n    }\n\n    return extended\n  }\n\n  private getNextStepToward(from: Vector2, target: Vector2): Vector2 {\n    const dx = Math.sign(target.x - from.x)\n    const dy = Math.sign(target.y - from.y)\n    return new Vector2(from.x + dx, from.y + dy)\n  }\n\n  startLineAt(point: Vector2, layer: number): boolean {\n    this._activeLayer = layer === 0 ? this.layer0 : this.layer1\n\n    const {x, y} = point\n\n    // Lookup what's at target cell\n    const padAtPoint = this.pads.getAt(x, y)\n    const lineAtPointLayer0 = this.layer0.getLinesAt(x, y)\n    const lineAtPointLayer1 = this.layer1.getLinesAt(x, y)\n    const lineCountAtPointLayer0 = lineAtPointLayer0.length\n    const lineCountAtPointLayer1 = lineAtPointLayer1.length\n\n    if (!padAtPoint) return false\n\n    const  lineCountAtPoint = lineCountAtPointLayer1 + lineCountAtPointLayer0\n\n    // Terminal pads accept 1 connection, normal pads accept 2, empty cells accept 0\n    const connectionLimit = padAtPoint ? (padAtPoint.isTerminal ? 1 : 2) : 0\n\n    if (lineCountAtPoint >= connectionLimit) return false\n\n    return this._activeLayer.addAt(x, y, padAtPoint.renderColor)\n  }\n\n  extendLineTo(point: Vector2, layer: number): boolean {\n    this._activeLayer = layer === 0 ? this.layer0 : this.layer1\n    const line = this._activeLayer.lastLine\n    if (!line) return false\n    if (line.isFinalized) return false\n\n    const {x, y} = point\n\n    // Lookup what's at target cell\n    const padAtPoint = this.pads.getAt(x, y)\n    const lineAtPointLayer0 = this.layer0.getLinesAt(x, y)\n    const lineAtPointLayer1 = this.layer1.getLinesAt(x, y)\n    const lineCountAtPointLayer0 = lineAtPointLayer0.length\n    const lineCountAtPointLayer1 = lineAtPointLayer1.length\n    const lineAtPoint = layer === 0 ? lineAtPointLayer0[0] : lineAtPointLayer1[0]\n\n    const  lineCountAtPoint = lineCountAtPointLayer1 + lineCountAtPointLayer0\n\n    // Terminal pads accept 1 connection, normal pads accept 2, empty cells accept 0\n    const connectionLimit = padAtPoint ? (padAtPoint.isTerminal ? 1 : 2) : 0\n\n    // Reject if point is already at connection capacity\n    if (padAtPoint && lineCountAtPoint >= connectionLimit) return false\n\n\n    // Reject if diagonal would cross another diagonal on same layer\n    const lastPoint = line.lastPt\n    if (point.distanceTo(lastPoint) === SQRT_2) {\n      if (this._activeLayer.hasDiagonalCrossing(x, y, lastPoint.x, lastPoint.y)) {\n        console.log('diagonal crossing rejected')\n        return false\n      }\n    }\n\n    // Reject intersection with other line\n    if (!padAtPoint) {\n      if (lineAtPoint) {\n        if (lineAtPoint !== line) {\n          return false\n        } else {\n          return this._activeLayer.extendAt(x, y)\n        }\n      } else {\n        return this._activeLayer.extendAt(x, y)\n      }\n    }\n\n    // Reached a pad/terminal: snap to it and end drag (color must be compatible)\n    if (padAtPoint) {\n      if (padAtPoint.renderColor !== COLORS.white && line.renderColor !== COLORS.white && padAtPoint.renderColor !== line.renderColor) {\n        console.log('color mismatch rejected')\n        return false\n      }\n      const added = this._activeLayer.extendAt(x, y)\n      if (added) {\n        this.dispatch('line-end-drag', undefined, true)\n        return true\n      } else {\n        return false\n      }\n    }\n\n    return false\n  }\n}\n"]}