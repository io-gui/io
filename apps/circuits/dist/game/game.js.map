{"version":3,"file":"game.js","sourceRoot":"","sources":["../../src/game/game.ts"],"names":[],"mappings":"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","sourcesContent":["import { Register, ReactiveNode, ReactiveProperty, Property, Storage as $, Binding } from '@io-gui/core'\nimport { Pad, type PadData, type PadColor } from './items/pad.js'\nimport { Line, type LineData } from './items/line.js'\nimport { Plotter } from './plotter.js'\n\nexport type DrawMode = 'pad' | 'terminal' | 'line' | 'delete'\n\ninterface LevelData {\n  width: number\n  height: number\n  pads: PadData[]\n  lines: LineData[]\n}\n\n/**\n * Game â€” central state machine.\n * Manages pads, lines, load/save, undo/redo, colour propagation,\n * and completion checking.\n */\n@Register\nexport class Game extends ReactiveNode {\n  @ReactiveProperty({value: '', type: String})\n  declare level: string\n\n  @ReactiveProperty({type: Array})\n  declare pads: Pad[]\n  \n  @ReactiveProperty({type: Array})\n  declare lines: Line[]\n\n  @ReactiveProperty({type: Number})\n  declare width: number\n\n  @ReactiveProperty({type: Number})\n  declare height: number\n\n  drawMode: DrawMode = 'line'\n  drawColor: PadColor = 'white'\n  drawLayer = 0\n\n  undoStack: string[] = []\n  redoStack: string[] = []\n\n  @ReactiveProperty({type: Plotter, init: null})\n  declare plotter: Plotter\n\n  @Property($({key: 'null-level-state', value: {}, storage: 'local'}))\n  declare storedState: Binding\n\n  clear() {\n    this.width = 4\n    this.height = 5\n    this.pads = []\n    this.lines = []\n    this.plotter.connect(this.pads, this.lines, this.width, this.height)\n    this.drawMode = 'line'\n    this.drawColor = 'white'\n    this.drawLayer = 0\n    this.redoStack = []\n    this.undoStack = []\n  }\n\n  async initialize() {\n    this.clear()\n    this.storedState = $({key: `${this.level}-level-state`, value: {}, storage: 'local'})\n\n    if (this.level) {\n      if (Object.keys(this.storedState.value).length === 0) {\n        await this.load(this.level)\n      } else {\n        this.clear()\n        this.fromJSON(JSON.stringify(this.storedState.value))\n        this.propagateColors()\n      }\n    }\n\n    this.undoStack = [this.toJSON()]\n    this.redoStack = []\n    this.dispatch('game-update', undefined, true)\n  }\n\n  levelChanged() {\n    void this.initialize().then(() => {\n      this.dispatch('game-init-scene', undefined, true)\n    })\n  }\n\n  reload() {\n    this.storedState.value = {}\n    void this.initialize()\n  }\n\n  async load(level: string): Promise<void> {\n    try {\n      const resp = await fetch('./public/levels/' + level + '.json')\n      if (!resp.ok) console.error('Level not found')\n      const text = await resp.text()\n      this.clear()\n      this.fromJSON(text)\n      this.propagateColors()\n      this.save()\n    } catch (e) {\n      console.warn('Could not load level:', level, e)\n    }\n  }\n\n  save(): void {\n    this.storedState.value = {\n      width: this.width,\n      height: this.height,\n      pads: this.pads.map((p) => p.toJSON()),\n      lines: this.lines.map((l) => l.toJSON()),\n    }\n  }\n\n  fromJSON(jsonText: string): void {\n    const state: LevelData = JSON.parse(jsonText)\n    this.width = state.width\n    this.height = state.height\n    this.pads = state.pads.map((p) => Pad.fromJSON(p))\n    this.lines = state.lines.map((l) => Line.fromJSON(l as LineData))\n    this.plotter.connect(this.pads, this.lines, this.width, this.height)\n  }\n\n  toJSON(): string {\n    return JSON.stringify({\n      width: this.width,\n      height: this.height,\n      pads: this.pads.map((p) => p.toJSON()),\n      lines: this.lines.map((l) => l.toJSON()),\n    })\n  }\n\n  updateUndoStack(): void {\n    const state = this.toJSON()\n    if (state !== this.undoStack[this.undoStack.length - 1]) {\n      this.undoStack.push(state)\n    }\n  }\n\n  undo(): void {\n    if (this.undoStack.length >= 2) {\n      const currentState = this.undoStack.pop()!\n      this.fromJSON(this.undoStack[this.undoStack.length - 1])\n      this.redoStack.push(currentState)\n      this.propagateColors()\n      this.save()\n      this.dispatch('game-update', undefined, true)\n    }\n  }\n\n  redo(): void {\n    if (this.redoStack.length > 0) {\n      const state = this.redoStack.pop()!\n      this.fromJSON(state)\n      this.undoStack.push(state)\n      this.propagateColors()\n      this.save()\n      this.dispatch('game-update', undefined, true)\n    }\n  }\n\n  resetColors(): void {\n    for (const line of this.lines) line.color = 'white'\n    for (const pad of this.pads) {\n      pad.renderColor = pad.isTerminal ? (pad.color ?? 'red') : 'white'\n    }\n  }\n\n  propagateColors(): void {\n    this.resetColors()\n\n    for (let iter = 0; iter < 16; iter++) {\n      for (const line of this.lines) {\n        const first = line.pos[0]\n        const last = line.pos[line.pos.length - 1]\n\n        const p1 = this.plotter.getPointAt(first)\n        const p2 = this.plotter.getPointAt(last)\n        if (!p1 || !p2) continue\n\n        const c1 = p1.renderColor\n        const c2 = p2.renderColor\n\n        if (c1 !== 'white' && c2 !== 'white') {\n          if (c1 === c2) line.color = c1\n        } else if (c1 === 'white' && c2 === 'white') {\n          line.color = 'white'\n        } else {\n          if (c1 !== 'white') {\n            line.color = c1\n            if (p2 instanceof Pad) p2.renderColor = c1\n          } else if (c2 !== 'white') {\n            line.color = c2\n            if (p1 instanceof Pad) p1.renderColor = c2\n          }\n        }\n      }\n    }\n\n    this.dispatch('game-update', undefined, true)\n\n    let completed = true\n\n    // TODO: Check for completeness correctly\n\n    for (const pad of this.pads) {\n      const nConn = this.plotter.getLinesAtPoint(pad.pos).length\n      if (pad.isTerminal) {\n        if (nConn !== 1) completed = false\n      } else if (nConn !== 2 && pad.renderColor !== 'white') {\n        completed = false\n      }\n    }\n\n    if (completed) console.log('game-complete', this.level, completed)\n    this.dispatch('game-complete', { level: this.level, completed }, true)\n  }\n\n  finalizeMove(lineID: number): void {\n    if (this.plotter.verifyLineComplete(lineID)) {\n      this.updateUndoStack()\n      this.propagateColors()\n      this.save()\n    }\n    this.dispatch('game-update', undefined, true)\n  }\n}\n"]}