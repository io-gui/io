{"version":3,"file":"game.js","sourceRoot":"","sources":["../../src/game/game.ts"],"names":[],"mappings":"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","sourcesContent":["import { Pad } from './pad.js'\nimport { Terminal } from './terminal.js'\nimport { Line } from './line.js'\nimport type { PadData } from './pad.js'\nimport type { TerminalData } from './terminal.js'\nimport type { LineData } from './line.js'\n\nexport type DrawMode = 'pad' | 'terminal' | 'line' | 'delete'\n\ninterface LegacyPadData {\n  ID: number\n  pos: [number, number]\n  color?: string\n}\n\ninterface LevelData {\n  width: number\n  height: number\n  pads: PadData[]\n  terminals?: TerminalData[]\n  lines: LineData[]\n}\n\n/**\n * Game — central state machine.\n * Manages pads, lines, load/save, undo/redo, colour propagation,\n * and completion checking.\n */\nexport class Game {\n  width = 4\n  height = 5\n  pads: Pad[] = []\n  terminals: Terminal[] = []\n  lines: Line[] = []\n  padColors: Record<number, string> = {}\n  terminalColors: Record<number, string> = {}\n  lineColors: Record<number, string> = {}\n  drawMode: DrawMode = 'line'\n  drawColor = 'white'\n  drawLayer = 0\n  undoStack: string[] = []\n  redoStack: string[] = []\n  currentLevel = ''\n\n  /** Callback invoked after save — host element persists state. */\n  onSave: ((level: string, json: string) => void) | null = null\n  /** Callback invoked on completion change. */\n  onComplete: ((level: string, completed: boolean) => void) | null = null\n  /** Callback invoked when grid dimensions change and scene needs re-init. */\n  onInitScene: (() => void) | null = null\n  /** Callback invoked when game state changes and scene needs re-render. */\n  onRender: (() => void) | null = null\n\n  init(): void {\n    this.width = 4\n    this.height = 5\n    this.pads = []\n    this.terminals = []\n    this.lines = []\n    this.drawMode = 'line'\n    this.drawColor = 'white'\n    this.drawLayer = 0\n    this._renderScene()\n  }\n\n  // -- Level loading --\n\n  load(level: string, savedState?: string): void {\n    this.init()\n    this.redoStack = []\n    this.undoStack = []\n    this.currentLevel = level\n\n    if (savedState) {\n      this.fromJSON(savedState)\n      this.save()\n      this.updateUndoStack()\n      this.propagateColors()\n    } else {\n      void this.reset(level)\n    }\n  }\n\n  clear() {\n    this.init()\n  }\n\n  async reset(level: string): Promise<void> {\n    try {\n      const resp = await fetch('./public/levels/' + level + '.json')\n      if (!resp.ok) throw new Error('Level not found')\n      const text = await resp.text()\n      this.fromJSON(text)\n      for (const line of this.lines) line.readonly = true\n      this.save()\n      this.updateUndoStack()\n      this.propagateColors()\n    } catch (e) {\n      console.warn('Could not load level:', level, e)\n    }\n  }\n\n  // -- Serialisation --\n\n  fromJSON(jsonText: string): void {\n    const state: LevelData = JSON.parse(jsonText)\n    this.width = state.width\n    this.height = state.height\n    this.pads = []\n    this.terminals = []\n    const legacyPads = state.pads as LegacyPadData[]\n    const terminalIds = new Set<number>()\n    for (const p of legacyPads) {\n      if ('color' in p && p.color !== undefined) {\n        if (p.color === 'white') {\n          this.pads.push(new Pad(p.ID, p.pos))\n        } else {\n          this.terminals.push(new Terminal(p.ID, p.pos, p.color))\n          terminalIds.add(p.ID)\n        }\n      } else {\n        this.pads.push(Pad.fromJSON(p as PadData))\n      }\n    }\n    if (state.terminals) {\n      for (const t of state.terminals) {\n        if (!terminalIds.has(t.ID)) {\n          this.terminals.push(Terminal.fromJSON(t))\n        }\n      }\n    }\n    this.lines = state.lines.map((l) => Line.fromJSON(l as LineData))\n    this.initScene()\n  }\n\n  toJSON(): string {\n    return JSON.stringify({\n      width: this.width,\n      height: this.height,\n      pads: this._cleanPads(),\n      terminals: this._cleanTerminals(),\n      lines: this._cleanLines(),\n    })\n  }\n\n  private _cleanPads(): PadData[] {\n    return this.pads.map((p) => p.toJSON())\n  }\n\n  private _cleanTerminals(): TerminalData[] {\n    return this.terminals.map((t) => t.toJSON())\n  }\n\n  private _cleanLines(): LineData[] {\n    return this.lines.map((l) => l.toJSON())\n  }\n\n  private _getLineById(id: number): Line | undefined {\n    return this.lines.find((l) => l.ID === id)\n  }\n\n  private _getTerminalById(id: number): Terminal | undefined {\n    return this.terminals.find((t) => t.ID === id)\n  }\n\n  save(): void {\n    if (this.currentLevel && this.onSave) {\n      this.onSave(this.currentLevel, this.toJSON())\n    }\n  }\n\n  // -- Undo / Redo --\n\n  updateUndoStack(): void {\n    const state = this.toJSON()\n    if (state !== this.undoStack[this.undoStack.length - 1]) {\n      this.undoStack.push(state)\n    }\n  }\n\n  undo(): void {\n    if (this.undoStack.length > 1) {\n      this.fromJSON(this.undoStack[this.undoStack.length - 2])\n      this.redoStack.push(this.undoStack.pop()!)\n      this.save()\n      this.propagateColors()\n      this.checkCompletion()\n    }\n  }\n\n  redo(): void {\n    if (this.redoStack.length > 0) {\n      const state = this.redoStack.pop()!\n      this.fromJSON(state)\n      this.undoStack.push(state)\n      this.save()\n      this.propagateColors()\n      this.checkCompletion()\n    }\n  }\n\n  getPointAt(\n    x: number,\n    y: number\n  ): { id: number; color: string; isTerminal: boolean } | false {\n    for (const pad of this.pads) {\n      if (pad.pos[0] === x && pad.pos[1] === y)\n        return {\n          id: pad.ID,\n          color: this.padColors[pad.ID] ?? 'white',\n          isTerminal: false,\n        }\n    }\n    for (const term of this.terminals) {\n      if (term.pos[0] === x && term.pos[1] === y)\n        return {\n          id: term.ID,\n          color: this.terminalColors[term.ID] ?? term.color,\n          isTerminal: true,\n        }\n    }\n    return false\n  }\n\n  // -- Pad operations --\n\n  addPad(ID: number, x: number, y: number): void {\n    if (!this.getPointAt(x, y)) {\n      this.pads.push(new Pad(ID, [x, y]))\n      this._renderScene()\n    }\n  }\n\n  addTerminal(ID: number, x: number, y: number, color: string): void {\n    if (!this.getPointAt(x, y)) {\n      this.terminals.push(new Terminal(ID, [x, y], color))\n      this._renderScene()\n    }\n  }\n\n  deletePad(x: number, y: number): void {\n    const idx = this.pads.findIndex(\n      (p) => p.pos[0] === x && p.pos[1] === y\n    )\n    if (idx !== -1) {\n      this.pads.splice(idx, 1)\n      this._renderScene()\n    }\n  }\n\n  deleteTerminal(x: number, y: number): void {\n    const idx = this.terminals.findIndex(\n      (t) => t.pos[0] === x && t.pos[1] === y\n    )\n    if (idx !== -1) {\n      this.terminals.splice(idx, 1)\n      this._renderScene()\n    }\n  }\n\n  // -- Line operations --\n\n  /**\n   * Add / extend a line.\n   * Returns true if the line reached a destination pad or terminal (drag should stop).\n   */\n  addLine(ID: number, x: number, y: number, layer: number): boolean {\n    const point = this.getPointAt(x, y)\n    const pointColor = point ? point.color : false\n    const lineCount = this.getLineCount(x, y)\n\n    const connectionLimit = point ? (point.isTerminal ? 1 : 2) : 0\n    if (point && lineCount >= connectionLimit) {\n      this._renderScene()\n      return false\n    }\n\n    const line = this._getLineById(ID)\n    if (!line) {\n      if (!pointColor) {\n        this._renderScene()\n        return false\n      }\n      this.lines.push(new Line(ID, [x, y], layer))\n      this.lineColors[ID] = layer === 0 ? pointColor : 'grey'\n      this._renderScene()\n      return false\n    }\n\n    if (!this._checkCrossing(line, x, y)) {\n      this._renderScene()\n      return false\n    }\n\n    const lineColor =\n      this.lineColors[ID] ?? (line.layer === 0 ? 'white' : 'grey')\n    let endDrag = false\n\n    if (!pointColor && (!lineCount || layer === -1)) {\n      line.addSegment(x, y)\n    } else if (\n      pointColor === 'white' ||\n      pointColor === lineColor ||\n      ((lineColor === 'white' || lineColor === 'grey') && pointColor)\n    ) {\n      line.addSegment(x, y)\n      endDrag = true\n    }\n\n    this._renderScene()\n    return endDrag\n  }\n\n  getLineColor(x: number, y: number): string | false {\n    for (const line of this.lines) {\n      for (const pos of line.pos) {\n        if (pos[0] === x && pos[1] === y)\n          return this.lineColors[line.ID] ?? (line.layer === 0 ? 'white' : 'grey')\n      }\n    }\n    return false\n  }\n\n  getLineCount(x: number, y: number): number {\n    let count = 0\n    for (const line of this.lines) {\n      for (const pos of line.pos) {\n        if (pos[0] === x && pos[1] === y && line.layer === 0) count++\n      }\n    }\n    return count\n  }\n\n  getUnderlineCount(x: number, y: number): number {\n    let count = 0\n    for (const line of this.lines) {\n      for (const pos of line.pos) {\n        if (pos[0] === x && pos[1] === y && line.layer === -1) count++\n      }\n    }\n    return count\n  }\n\n  checkLine(ID: number): void {\n    const line = this._getLineById(ID)\n    if (line) {\n      const first = line.pos[0]\n      const last = line.pos[line.pos.length - 1]\n      const p1 = this.getPointAt(first[0], first[1])\n      const p2 = this.getPointAt(last[0], last[1])\n      if (\n        !p1 ||\n        !p2 ||\n        (first[0] === last[0] && first[1] === last[1])\n      ) {\n        this.undo()\n      }\n      this.redoStack = []\n    }\n  }\n\n  deleteLine(x: number, y: number): void {\n    const idx = this.lines.findIndex((l) =>\n      l.pos.some(([px, py]) => px === x && py === y)\n    )\n    if (idx !== -1) {\n      this.lines.splice(idx, 1)\n      this._renderScene()\n    }\n  }\n\n  /** Prevent diagonal lines from crossing other diagonals on the same layer. */\n  private _checkCrossing(line: Line, x: number, y: number): boolean {\n    const last = line.pos[line.pos.length - 1]\n    const mx = (x + last[0]) / 2\n    const my = (y + last[1]) / 2\n\n    for (const other of this.lines) {\n      if (other.layer !== line.layer) continue\n      const pos = other.pos\n      for (let i = 1; i < pos.length; i++) {\n        if (\n          Math.abs(pos[i][0] - pos[i - 1][0]) === 1 &&\n          Math.abs(pos[i][1] - pos[i - 1][1]) === 1 &&\n          (pos[i][0] + pos[i - 1][0]) / 2 === mx &&\n          (pos[i][1] + pos[i - 1][1]) / 2 === my\n        ) {\n          return false\n        }\n      }\n    }\n    return true\n  }\n\n  // -- Colour propagation --\n\n  resetColors(): void {\n    this.lineColors = {}\n    for (const line of this.lines)\n      this.lineColors[line.ID] = line.layer === 0 ? 'white' : 'grey'\n    this.padColors = {}\n    for (const pad of this.pads) this.padColors[pad.ID] = 'white'\n    this.terminalColors = {}\n    for (const term of this.terminals)\n      this.terminalColors[term.ID] = term.color\n  }\n\n  propagateColors(): void {\n    this.resetColors()\n\n    for (let iter = 0; iter < 16; iter++) {\n      for (const line of this.lines) {\n        const first = line.pos[0]\n        const last = line.pos[line.pos.length - 1]\n\n        const p1 = this.getPointAt(first[0], first[1])\n        const p2 = this.getPointAt(last[0], last[1])\n        if (!p1 || !p2) continue\n\n        const c1 = p1.isTerminal\n          ? (this.terminalColors[p1.id] ?? this._getTerminalById(p1.id)?.color)\n          : this.padColors[p1.id]\n        const c2 = p2.isTerminal\n          ? (this.terminalColors[p2.id] ?? this._getTerminalById(p2.id)?.color)\n          : this.padColors[p2.id]\n\n        if (c1 !== 'white' && c2 !== 'white') {\n          if (c1 === c2) this.lineColors[line.ID] = c1\n        } else {\n          if (c1 !== 'white') {\n            this.lineColors[line.ID] = c1\n            if (!p1.isTerminal) this.padColors[p1.id] = c1\n            if (!p2.isTerminal) this.padColors[p2.id] = c1\n          } else {\n            this.lineColors[line.ID] = c2\n            if (!p1.isTerminal) this.padColors[p1.id] = c2\n            if (!p2.isTerminal) this.padColors[p2.id] = c2\n          }\n        }\n      }\n    }\n\n    this._renderScene()\n  }\n\n  // -- Completion check --\n\n  checkCompletion(): void {\n    let completed = true\n\n    for (const term of this.terminals) {\n      const nConn = this.getLineCount(term.pos[0], term.pos[1])\n      if (nConn !== 1) completed = false\n    }\n\n    for (const pad of this.pads) {\n      const nConn = this.getLineCount(pad.pos[0], pad.pos[1])\n      const nUnder = this.getUnderlineCount(pad.pos[0], pad.pos[1])\n      const pc = this.padColors[pad.ID] ?? 'white'\n      if (nConn !== 2 && pc !== 'white') completed = false\n      if (nConn !== 1 && nUnder !== 1 && pc !== 'white') completed = false\n    }\n\n    if (this.onComplete) {\n      this.onComplete(this.currentLevel, completed)\n    }\n  }\n\n  // -- Move finalisation --\n\n  finalizeMove(lineID: number): void {\n    this.save()\n    this.updateUndoStack()\n    this.checkLine(lineID)\n    this.propagateColors()\n    this.checkCompletion()\n  }\n\n  // -- Internal --\n\n  initScene(): void {\n    this.onInitScene?.()\n  }\n\n  private _renderScene(): void {\n    this.onRender?.()\n  }\n}\n"]}