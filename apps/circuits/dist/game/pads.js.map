{"version":3,"file":"pads.js","sourceRoot":"","sources":["../../src/game/pads.ts"],"names":[],"mappings":"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","sourcesContent":["import { Pad, type PadData } from './items/pad.js'\nimport { type ColorName } from './items/colors.js'\nimport { Register, ReactiveNode } from '@io-gui/core'\nimport { DataTexture, NearestFilter, RGBAFormat, UnsignedByteType } from 'three'\n\nexport type PadsData = Record<string, PadData>\n\n@Register\nexport class Pads extends ReactiveNode {\n  private _width = 0\n  private _height = 0\n  private _stride = 0\n  private _cells: (Pad | undefined)[] = []\n\n  private _texture: DataTexture\n\n  get texture() {\n    return this._texture\n  }\n\n  constructor(width: number = 2, height: number = 2, data: PadsData = {}) {\n    super()\n    this.clear(width, height)\n    this.load(data)\n\n    this._texture = this._createTexture(new Uint8Array(width * height * 4), width, height)\n  }\n\n  private _createTexture(data: Uint8Array, width: number, height: number) {\n    const texture = new DataTexture(data, width, height, RGBAFormat, UnsignedByteType)\n    texture.magFilter = NearestFilter\n    texture.minFilter = NearestFilter\n    texture.generateMipmaps = false\n    texture.needsUpdate = true\n    return texture\n  }\n\n  updateTexture(width: number, height: number) {\n\n    let data = this._texture.image!.data!\n    const textureSize = width * height * 4\n    if (this._texture.image!.data!.length !== textureSize) {\n      this._texture.dispose()\n      this._texture = this._createTexture(new Uint8Array(textureSize), width, height)\n    }\n\n    data = this._texture.image!.data!\n    data.fill(0)\n\n    this.forEach((pad, x, y) => {\n      if (x < 0 || x >= width || y < 0 || y >= height) return\n      const color = pad.renderColor\n      const index = (x + y * width) * 4\n      data[index] = Math.max(0, Math.min(255, Math.round(color.r * 255)))\n      data[index + 1] = Math.max(0, Math.min(255, Math.round(color.g * 255)))\n      data[index + 2] = Math.max(0, Math.min(255, Math.round(color.b * 255)))\n      data[index + 3] = pad.isTerminal ? 255 : 0\n    })\n\n    this._texture.needsUpdate = true\n  }\n\n  clear(width: number, height: number) {\n    this._width = width\n    this._height = height\n    this._stride = width\n    this._cells = new Array(width * height)\n    this.dispatch('game-update', undefined, true)\n  }\n\n  load(data: PadsData = {}) {\n    for (const key in data) {\n      const index = Number.parseInt(key, 10)\n      if (!Number.isFinite(index)) {\n        debug: console.error('Invalid pad index key', key)\n        continue\n      }\n      const y = Math.floor(index / this._stride)\n      const x = index - y * this._stride\n      const item = data[key]\n      this.addAt(x, y, item.color)\n    }\n    this.dispatch('game-update', undefined, true)\n  }\n\n  forEach(callback: (pad: Pad, x: number, y: number) => void) {\n    for (let y = 0; y < this._height; y++) {\n      for (let x = 0; x < this._width; x++) {\n        const pad = this._cells[this._index(x, y)]\n        if (pad) callback(pad, x, y)\n      }\n    }\n  }\n\n  getAt(x: number, y: number) {\n    if (!this._inBounds(x, y)) return undefined\n    return this._cells[this._index(x, y)]\n  }\n\n  addAt(x: number, y: number, color?: ColorName) {\n    if (!this._areIntegers(x, y)) return false\n    if (!this._inBounds(x, y)) return false\n    const index = this._index(x, y)\n    if (this._cells[index]) {\n      console.log('Pad already exists', x, y)\n      return false\n    }\n    this._cells[index] = new Pad(color)\n    this.dispatch('game-update', undefined, true)\n    return true\n  }\n\n  deleteAt(x: number, y: number) {\n    if (!this._inBounds(x, y)) return false\n    const index = this._index(x, y)\n    if (!this._cells[index]) return false\n    this._cells[index] = undefined\n    this.dispatch('game-update', undefined, true)\n    return true\n  }\n\n  toJSON(): PadsData {\n    const data: PadsData = {}\n    this.forEach((pad, x, y) => {\n      const key = String(this._index(x, y))\n      data[key] = pad.toJSON()\n    })\n    return data\n  }\n\n  static fromJSON(width: number, height: number, data: PadsData) {\n    return new Pads(width, height, data)\n  }\n\n  private _index(x: number, y: number) {\n    return x + y * this._stride\n  }\n\n  private _inBounds(x: number, y: number) {\n    const inBounds = x >= 0 && x < this._width && y >= 0 && y < this._height\n    if (!inBounds) console.log('Pad out of bounds', x, y)\n    return inBounds\n  }\n\n  private _areIntegers(x: number, y: number) {\n    if (!Number.isInteger(x) || !Number.isInteger(y)) {\n      console.log('Pad position must be integer', x, y)\n      return false\n    }\n    return true\n  }\n}\n"]}