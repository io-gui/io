{"version":3,"file":"CircuitsBoard.js","sourceRoot":"","sources":["../src/CircuitsBoard.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n  Register,\n  IoElement,\n  IoElementProps,\n  ReactiveProperty,\n  div,\n} from '@io-gui/core'\nimport { ioButton } from '@io-gui/inputs'\nimport { Vector2 } from 'three/webgpu'\nimport { Game } from './game/game.js'\nimport { ThreeScene } from './scene/threeScene.js'\nimport { ioThreeViewport, Pointer3D } from '@io-gui/three'\nimport { PointerTool } from './tools/pointerTool.js'\n\nlet _posRaw = new Vector2()\nconst _posHitOld = new Vector2()\nconst _posHit = new Vector2()\n\n/** Intersect pointer ray with the z=0 game plane, write rounded grid coords into `out`. */\nfunction pointerToGrid(pointer: Pointer3D): Vector2 {\n  const ray = pointer.ray\n  const t = -ray.origin.z / ray.direction.z\n  return new Vector2().copy(ray.origin).addScaledVector(ray.direction, t)\n}\n\ntype CircuitsBoardProps = IoElementProps & {\n  game: Game\n}\n\n/**\n * CircuitsBoard â€” 3D game board IoElement.\n * Owns the ThreeScene, hosts io-three-viewport, handles pointer events,\n * and maps viewport coordinates to grid via camera unproject (plotter logic).\n */\n@Register\nexport class CircuitsBoard extends IoElement {\n\n  static get Style() {\n    return /* css */`\n      :host {\n        display: flex;\n        flex: 1 1 auto;\n        flex-direction: column;\n        height: 100%;\n        max-width: 100%;\n        max-height: 100%;\n      }\n      :host > .game-toolbar {\n        display: flex;\n        gap: 2px;\n        padding: 2px;\n        flex-shrink: 0;\n      }\n      :host > .game-toolbar > io-button {\n        flex: 1 1 auto;\n        height: calc(var(--io_fieldHeight) * 1.5);\n        display: flex;\n        align-items: center;\n      }\n      :host > .game-toolbar > io-button > io-icon {\n        margin-left: auto;\n      }\n      :host > .game-toolbar > io-button > span {\n        margin-right: auto;\n      }\n    `\n  }\n\n  static get Listeners(): Record<string, string> {\n    return {\n      '3dpointer-down': 'on3DPointerDown',\n      '3dpointer-move': 'on3DPointerMove',\n      '3dpointer-up': 'on3DPointerUp',\n\n      'game-init-scene': 'onGameInit',\n      'game-update': 'onGameUpdate',\n      'line-end-drag': 'onEndDrag',\n    }\n  }\n\n  // TODO: Move applet to CircuitsApp\n  @ReactiveProperty({type: ThreeScene, init: {isPlaying: true}})\n  declare applet: ThreeScene\n\n  @ReactiveProperty({ type: Game })\n  declare game: Game\n\n  private _currentID: number = 0\n  private _dragging: boolean = false\n\n  constructor(args: CircuitsBoardProps) {\n    super(args)\n  }\n\n  onGameInit() {\n    this.onGameUpdate()\n    this.applet.initGrid(this.game.width, this.game.height)\n  };\n  onGameUpdate() {\n    this.applet.updateGrid(this.game.width, this.game.height, this.game.lines, this.game.pads)\n    this.applet.updatePads(this.game.pads)\n    this.applet.updateTerminals(this.game.pads)\n    this.applet.updateLines(this.game.lines)\n    // TODO: hmm?\n    this.applet.dispatch('three-applet-needs-render', undefined, true)\n  };\n\n  gameChanged() {\n    this.onGameInit()\n  }\n\n  ready() {\n    this.onGameUpdate()\n    this.applet.initGrid(this.game.width, this.game.height)\n    this.render([\n      ioThreeViewport({applet: this.applet, tool: new PointerTool({}), cameraSelect: 'scene', overscan: 1.2}),\n      div({class: 'game-toolbar'}, [\n        ioButton({label: 'Undo', icon: 'io:undo', action: this.onUndo}),\n        ioButton({label: 'Reset', icon: 'io:reload', action: this.onReset}),\n        ioButton({label: 'Redo', icon: 'io:redo', action: this.onRedo}),\n      ]),\n    ])\n  }\n\n  on3DPointerDown(event: CustomEvent<Pointer3D[]>) {\n    if (event.detail.length !== 1) return\n\n    this._dragging = true\n    _posRaw = pointerToGrid(event.detail[0])\n\n    _posHit.copy(_posRaw).round()\n    _posHitOld.copy(_posHit)\n\n    this.applet.updateDrag(event.detail[0].screen, event.detail[0].screenStart)\n\n    this._currentID = Math.floor(Math.random() * 100000)\n\n    if (this.game.drawMode === 'pad') {\n      this.game.plotter.addPad(this._currentID, [_posHit.x, _posHit.y])\n    }\n    if (this.game.drawMode === 'terminal') {\n      this.game.plotter.addPad(this._currentID, [_posHit.x, _posHit.y], this.game.drawColor, true)\n    }\n    if (this.game.drawMode === 'line') {\n      this.game.plotter.addLineSegment(this._currentID, [_posHit.x, _posHit.y], this.game.drawLayer)\n    }\n    if (this.game.drawMode === 'delete') {\n      this.game.plotter.delete([_posHit.x, _posHit.y])\n    }\n  }\n\n  on3DPointerMove(event: CustomEvent<Pointer3D[]>) {\n    if (event.detail.length !== 1 || !this._dragging) return\n    this.applet.updateDrag(event.detail[0].screen, event.detail[0].screenStart)\n\n    _posRaw = pointerToGrid(event.detail[0])\n    _posHit.copy(_posRaw).round()\n    if (_posRaw.distanceTo(_posHitOld) < .95) {\n      return\n    }\n    _posHitOld.copy(_posHit)\n\n    if (this.game.drawMode === 'line' && _posRaw.distanceTo(_posHitOld) > 0) {\n      this.game.plotter.addLineSegment(this._currentID, [_posHit.x, _posHit.y], this.game.drawLayer)\n    }\n  }\n\n  on3DPointerUp(event: PointerEvent) {\n    event.preventDefault()\n    this.onEndDrag()\n    this.applet.updateDrag(new Vector2(0, 0), new Vector2(0, 0))\n  }\n\n  onEndDrag() {\n    this._dragging = false\n    if (this.game) this.game.finalizeMove(this._currentID)\n    this.applet.updateGrid(this.game.width, this.game.height, this.game.lines, this.game.pads)\n  }\n\n  onUndo() {\n    this.game.undo()\n  }\n\n  onRedo() {\n    this.game.redo()\n  }\n\n  onReset() {\n    this.game.reload()\n  }\n\n  onEdit() {\n    this.changed()\n  }\n\n  dispose() {\n    this.applet.dispose()\n    super.dispose()\n  }\n\n}\n\nexport const circuitsBoard = function(arg0: CircuitsBoardProps) {\n  return CircuitsBoard.vConstructor(arg0)\n}"]}