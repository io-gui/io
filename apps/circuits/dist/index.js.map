{"version":3,"file":"index.js","sources":["../src/game/items/terminal.ts","../src/CircuitsLevels.ts","../src/game/items/pad.ts","../src/game/items/line.ts","../src/game/plotter.ts","../src/game/game.ts","../src/objects/grid.ts","../src/scene/threeScene.ts","../src/tools/pointerTool.ts","../src/CircuitsBoard.ts","../src/CircuitsGame.ts","../src/CircuitsApp.ts"],"sourcesContent":["export const TERMINAL_COLORS = {\n  white: '#ffffff',\n  red: '#e52800',\n  green: '#005923',\n  blue: '#06afff',\n  pink: '#ef47cc',\n  yellow: '#fec41a',\n  orange: '#ff6910',\n  purple: '#760281',\n  brown: '#820419',\n  grey: '#555555',\n  black: '#222222',\n}\n\nexport type TerminalColor = keyof typeof TERMINAL_COLORS\n\nexport interface TerminalData {\n  id: number\n  pos: [number, number]\n  color: TerminalColor\n}\n\nexport class Terminal {\n  id: number\n  pos: [number, number]\n  color: TerminalColor\n\n  constructor(id: number, pos: [number, number], color: TerminalColor) {\n    this.id = id\n    this.pos = pos\n    this.color = color\n  }\n\n  toJSON(): TerminalData {\n    return { id: this.id, pos: this.pos, color: this.color }\n  }\n\n  static fromJSON(data: TerminalData): Terminal {\n    return new Terminal(data.id, data.pos, data.color)\n  }\n}\n","import { IoElement, Register, ReactiveProperty } from '@io-gui/core'\nimport { MenuOption, ioMenuTree } from '@io-gui/menus'\n\n@Register\nexport class CircuitsLevels extends IoElement {\n  static get Style() {\n    return /* css */ `\n      :host > .app-title {\n        margin-left: 1rem;\n        font-size: 2rem;\n        font-weight: bold;\n        letter-spacing: 2px;\n        text-transform: uppercase;\n      }\n    `\n  }\n\n  @ReactiveProperty({ type: Array, value: [] })\n  declare completedLevels: string[]\n\n  private _option = new MenuOption({ id: 'levels', options: [] })\n  private _levelIds: string[] = []\n\n  async ready() {\n    await this._loadLevels()\n    this.changed()\n  }\n\n  private _buildLevelOptions(levelIds: string[], completedIds: string[]) {\n    return levelIds.map(\n      (id) =>\n        new MenuOption({\n          id,\n          label: id,\n          disabled: completedIds.includes(id),\n          action: () => this.dispatch('level-select', { level: id }, true),\n        }),\n    )\n  }\n\n  private async _loadLevels() {\n    const response = await fetch('./public/levels/index.json')\n    this._levelIds = await response.json()\n    const completed = this.completedLevels ?? []\n    this._option = new MenuOption({\n      id: 'levels',\n      options: this._buildLevelOptions(this._levelIds, completed),\n    })\n  }\n\n  refreshCompleted(completedIds: string[]) {\n    this.completedLevels = completedIds\n    this._option = new MenuOption({\n      id: 'levels',\n      options: this._buildLevelOptions(this._levelIds, completedIds),\n    })\n    this.changed()\n  }\n\n  changed() {\n    this.render([ioMenuTree({ option: this._option })])\n  }\n}\n\nexport const circuitsLevels = CircuitsLevels.vConstructor\n","import { TerminalColor } from './terminal.js'\n\nexport interface PadData {\n  id: number\n  pos: [number, number]\n}\n\nexport class Pad {\n  id: number\n  pos: [number, number]\n  _color: TerminalColor = 'white'\n\n  get color(): TerminalColor {\n    return this._color\n  }\n\n  set color(color: TerminalColor) {\n    this._color = color\n  }\n\n  constructor(id: number, pos: [number, number]) {\n    this.id = id\n    this.pos = pos\n  }\n\n  toJSON(): PadData {\n    return { pos: this.pos, id: this.id }\n  }\n\n  static fromJSON(data: PadData): Pad {\n    return new Pad(data.id, data.pos)\n  }\n}\n","import { TerminalColor } from './terminal.js'\n\nexport interface LineData {\n  id: number\n  pos: [number, number][]\n  layer: number\n}\n\nexport class Line {\n  id: number\n  pos: [number, number][]\n  layer: number\n  _color: TerminalColor = 'white'\n\n  get color(): TerminalColor {\n    return this._color\n  }\n\n  set color(color: TerminalColor) {\n    this._color = color\n  }\n\n  constructor(id: number, pos: [number, number], layer: number) {\n    this.id = id\n    this.pos = [pos]\n    this.layer = layer\n  }\n\n  hasDiagonalSegmentAt(mx: number, my: number): boolean {\n    const pos = this.pos\n    for (let i = 1; i < pos.length; i++) {\n      const ax = pos[i - 1][0]\n      const ay = pos[i - 1][1]\n      const bx = pos[i][0]\n      const by = pos[i][1]\n      if (\n        Math.abs(bx - ax) === 1 &&\n        Math.abs(by - ay) === 1 &&\n        (ax + bx) / 2 === mx &&\n        (ay + by) / 2 === my\n      ) {\n        return true\n      }\n    }\n    return false\n  }\n\n  /**\n   * Plot a new segment on the line if direction is valid.\n   * Erase last segment if user drags back to prev node.\n   * Return true if segment was added, false otherwise.\n   */\n  plotSegment(x: number, y: number): boolean {\n    if (this._tryEraseLastSegment(x, y)) return true\n    if (this._tryAddNewSegment(x, y)) return true\n    return false\n  }\n\n  toJSON(): LineData {\n    return {\n      id: this.id,\n      pos: this.pos,\n      layer: this.layer,\n    }\n  }\n\n  static fromJSON(data: LineData): Line {\n    const line = new Line(data.id, data.pos[0], data.layer)\n    for (let j = 1; j < data.pos.length; j++) {\n      line.plotSegment(data.pos[j][0], data.pos[j][1])\n    }\n    return line\n  }\n\n  /**\n   * Add segment or, if user went 45° backwards, remove one segment and add a 90° turn.\n   * Returns true if nothing was done, false if path was updated.\n   */\n  private _tryAddNewSegment(x: number, y: number): boolean {\n    const ln = this.pos.length\n    if (ln > 1) {\n      if (y === this.pos[ln - 2][1] && Math.abs(x - this.pos[ln - 2][0]) === 1) {\n        this.pos.pop()\n        this.pos.push([x, y])\n        return false\n      }\n      if (x === this.pos[ln - 2][0] && Math.abs(y - this.pos[ln - 2][1]) === 1) {\n        this.pos.pop()\n        this.pos.push([x, y])\n        return false\n      }\n    }\n    const last = this.pos[ln - 1]\n    if (Math.abs(last[0] - x) > 1) return true\n    if (Math.abs(last[1] - y) > 1) return true\n\n    this.pos.push([x, y])\n    return false\n  }\n\n  /** Erase last segment if user drags back to prev node. */\n  private _tryEraseLastSegment(x: number, y: number): boolean {\n    const ln = this.pos.length\n    if (ln < 2) return false\n    if (x === this.pos[ln - 2][0] && y === this.pos[ln - 2][1]) {\n      this.pos.pop()\n      return true\n    }\n    return false\n  }\n}\n","import { ReactiveNode, Register } from '@io-gui/core'\nimport { Pad } from './items/pad.js'\nimport { Terminal, type TerminalColor } from './items/terminal.js'\nimport { Line } from './items/line.js'\n\nexport interface PointAt {\n  id: number\n  isTerminal: boolean\n}\n\n/**\n * Plotter — position and geometry only.\n * Intersection checks, adding/removing pads, terminals, and lines.\n * No color, propagation, or completion.\n */\n@Register\nexport class Plotter extends ReactiveNode {\n  width = 0\n  height = 0\n  pads: Pad[] = []\n  terminals: Terminal[] = []\n  lines: Line[] = []\n\n  connect(pads: Pad[], terminals: Terminal[], lines: Line[], width: number, height: number) {\n    this.width = width\n    this.height = height\n    this.pads = pads\n    this.terminals = terminals\n    this.lines = lines\n  }\n\n  getPointAt(x: number, y: number): Pad | Terminal | undefined {\n    for (const pad of this.pads) {\n      if (pad.pos[0] === x && pad.pos[1] === y)\n        return pad\n    }\n    for (const term of this.terminals) {\n      if (term.pos[0] === x && term.pos[1] === y)\n        return term\n    }\n  }\n\n  getLinesAtPoint(x: number, y: number, filter?: (line: Line) => boolean): Line[] {\n    const lines = []\n    for (const line of this.lines) {\n      if (line.pos.some(([px, py]) => px === x && py === y) && (filter?.(line) ?? true)) {\n        lines.push(line)\n      }\n    }\n    return lines\n  }\n\n  getLineById(id: number): Line | undefined {\n    return this.lines.find((l) => l.id === id)\n  }\n\n  checkDiagonalCrossing(line: Line, x: number, y: number): boolean {\n    const last = line.pos[line.pos.length - 1]\n    const mx = (x + last[0]) / 2\n    const my = (y + last[1]) / 2\n    for (const other of this.lines) {\n      if (other.layer !== line.layer) continue\n      if (other.hasDiagonalSegmentAt(mx, my)) return false\n    }\n    return true\n  }\n\n  addPad(id: number, x: number, y: number): boolean {\n    if (this.getPointAt(x, y)) return false\n    this.pads.push(new Pad(id, [x, y]))\n    this.dispatch('game-update', undefined, true)\n    return true\n  }\n\n  addTerminal(id: number, x: number, y: number, color: TerminalColor): boolean {\n    if (this.getPointAt(x, y)) return false\n    this.terminals.push(new Terminal(id, [x, y], color))\n    this.dispatch('game-update', undefined, true)\n    return true\n  }\n\n  delete(x: number, y: number) {\n    const padIdx = this.pads.findIndex((p) => p.pos[0] === x && p.pos[1] === y)\n    if (padIdx !== -1) {\n      this.pads.splice(padIdx, 1)\n    }\n    const termIdx = this.terminals.findIndex(\n      (t) => t.pos[0] === x && t.pos[1] === y,\n    )\n    if (termIdx !== -1) {\n      this.terminals.splice(termIdx, 1)\n    }\n    const lineIdx = this.lines.findIndex((l) =>\n      l.pos.some(([px, py]) => px === x && py === y),\n    )\n    if (lineIdx !== -1) {\n      this.lines.splice(lineIdx, 1)\n    }\n    this.dispatch('game-update', undefined, true)\n  }\n\n  verifyLineLegality(id: number): boolean {\n    const line = this.getLineById(id)\n    if (line) {\n      const first = line.pos[0]\n      const last = line.pos[line.pos.length - 1]\n      const p1 = this.getPointAt(first[0], first[1])\n      const p2 = this.getPointAt(last[0], last[1])\n      if (!p1 || !p2 || (first[0] === last[0] && first[1] === last[1])) {\n        const idx = this.lines.findIndex((l) => l.id === id)\n        if (idx !== -1) this.lines.splice(idx, 1)\n        return false\n      }\n      return true\n    }\n    return false\n  }\n\n  addLineSegment(id: number, x: number, y: number, layer: number): { added: boolean; endDrag: boolean } {\n    const point = this.getPointAt(x, y)\n    const linesAtPoint = this.getLinesAtPoint(x, y, (line) => (line.layer === 0))\n    const underlineLinesAtPoint = this.getLinesAtPoint(x, y, (line) => line.layer === -1)\n    const connectionLimit = point ? (point instanceof Terminal ? 1 : 2) : 0\n\n    let added = false\n    let endDrag = false\n\n    if (point && (linesAtPoint.length + underlineLinesAtPoint.length) >= connectionLimit) {\n      return { added, endDrag }\n    }\n\n    const line = this.getLineById(id)\n\n    if (line) {\n\n      if (!this.checkDiagonalCrossing(line, x, y)) {\n        return { added, endDrag }\n      }\n\n      const sameLineAtPoint = this.getLinesAtPoint(x, y, (line) => (line.id === id && line.layer === 0))?.[0] || null\n\n      if (!point && ((!linesAtPoint.length || sameLineAtPoint) || layer === -1)) {\n        added = line.plotSegment(x, y)\n      }\n\n      if (point) {\n        if (point.color !== 'white' && line.color !== 'white' && point.color !== line.color) {\n          return { added: false, endDrag: false }\n        }\n        added = line.plotSegment(x, y)\n        endDrag = true\n      }\n\n    } else {\n\n      if (!point) return { added: false, endDrag: false }\n      const newLine = new Line(id, [x, y], layer)\n      newLine.color = point.color\n      this.lines.push(newLine)\n      added = true\n\n    }\n\n    if (endDrag) {\n      this.dispatch('line-end-drag', {id}, true)\n    }\n\n    this.dispatch('game-update', undefined, true)\n    return { added, endDrag }\n  }\n}\n","import { Register, ReactiveNode, ReactiveProperty, Property, Storage as $, Binding } from '@io-gui/core'\nimport { Pad, type PadData } from './items/pad.js'\nimport {\n  Terminal,\n  type TerminalData,\n  type TerminalColor,\n} from './items/terminal.js'\nimport { Line, type LineData } from './items/line.js'\nimport { Plotter } from './plotter.js'\n\nexport type DrawMode = 'pad' | 'terminal' | 'line' | 'delete'\n\ninterface LevelData {\n  width: number\n  height: number\n  pads: PadData[]\n  terminals: TerminalData[]\n  lines: LineData[]\n}\n\n/**\n * Game — central state machine.\n * Manages pads, lines, load/save, undo/redo, colour propagation,\n * and completion checking.\n */\n@Register\nexport class Game extends ReactiveNode {\n  width = 4\n  height = 5\n  pads: Pad[] = []\n  terminals: Terminal[] = []\n  lines: Line[] = []\n\n  drawMode: DrawMode = 'line'\n  drawColor: TerminalColor = 'white'\n  drawLayer = 0\n\n  undoStack: string[] = []\n  redoStack: string[] = []\n\n  @ReactiveProperty({value: '', type: String})\n  declare currentLevel: string\n\n  @ReactiveProperty({type: Plotter, init: null})\n  declare plotter: Plotter\n\n  @Property($({key: 'null-level-state', value: {}, storage: 'local'}))\n  declare storedState: Binding\n\n  clear() {\n    this.width = 4\n    this.height = 5\n    this.pads = []\n    this.terminals = []\n    this.lines = []\n    this.plotter.connect(this.pads, this.terminals, this.lines, this.width, this.height)\n    this.drawMode = 'line'\n    this.drawColor = 'white'\n    this.drawLayer = 0\n    this.redoStack = []\n    this.undoStack = []\n  }\n\n  async initialize() {\n    this.clear()\n    this.storedState = $({key: `${this.currentLevel}-level-state`, value: {}, storage: 'local'})\n\n    if (this.currentLevel) {\n      if (Object.keys(this.storedState.value).length === 0) {\n        await this.load(this.currentLevel)\n      } else {\n        this.clear()\n        this.fromJSON(JSON.stringify(this.storedState.value))\n        this.propagateColors()\n      }\n    }\n\n    this.undoStack = [this.toJSON()]\n    this.redoStack = []\n    this.dispatch('game-update', undefined, true)\n  }\n\n  currentLevelChanged() {\n    void this.initialize().then(() => {\n      this.dispatch('game-init-scene', undefined, true)\n    })\n  }\n\n  reload() {\n    this.storedState.value = {}\n    void this.initialize()\n  }\n\n  async load(level: string): Promise<void> {\n    try {\n      const resp = await fetch('./public/levels/' + level + '.json')\n      if (!resp.ok) console.error('Level not found')\n      const text = await resp.text()\n      this.clear()\n      this.fromJSON(text)\n      this.propagateColors()\n      this.save()\n    } catch (e) {\n      console.warn('Could not load level:', level, e)\n    }\n  }\n\n  save(): void {\n    this.storedState.value = {\n      width: this.width,\n      height: this.height,\n      pads: this.pads.map((p) => p.toJSON()),\n      terminals: this.terminals.map((t) => t.toJSON()),\n      lines: this.lines.map((l) => l.toJSON()),\n    }\n  }\n\n  fromJSON(jsonText: string): void {\n    const state: LevelData = JSON.parse(jsonText)\n    this.width = state.width\n    this.height = state.height\n    this.pads = state.pads.map((p) => Pad.fromJSON(p))\n    this.terminals = state.terminals.map((t) => Terminal.fromJSON(t))\n    this.lines = state.lines.map((l) => Line.fromJSON(l as LineData))\n    this.plotter.connect(this.pads, this.terminals, this.lines, this.width, this.height)\n  }\n\n  toJSON(): string {\n    return JSON.stringify({\n      width: this.width,\n      height: this.height,\n      pads: this.pads.map((p) => p.toJSON()),\n      terminals: this.terminals.map((t) => t.toJSON()),\n      lines: this.lines.map((l) => l.toJSON()),\n    })\n  }\n\n  updateUndoStack(): void {\n    const state = this.toJSON()\n    if (state !== this.undoStack[this.undoStack.length - 1]) {\n      this.undoStack.push(state)\n    }\n  }\n\n  undo(): void {\n    if (this.undoStack.length >= 2) {\n      const currentState = this.undoStack.pop()!\n      this.fromJSON(this.undoStack[this.undoStack.length - 1])\n      this.redoStack.push(currentState)\n      this.propagateColors()\n      this.save()\n      this.dispatch('game-update', undefined, true)\n    }\n  }\n\n  redo(): void {\n    if (this.redoStack.length > 0) {\n      const state = this.redoStack.pop()!\n      this.fromJSON(state)\n      this.undoStack.push(state)\n      this.propagateColors()\n      this.save()\n      this.dispatch('game-update', undefined, true)\n    }\n  }\n\n  resetColors(): void {\n    for (const line of this.lines) line._color = 'white'\n    for (const pad of this.pads) pad._color = 'white'\n  }\n\n  propagateColors(): void {\n    this.resetColors()\n\n    for (let iter = 0; iter < 16; iter++) {\n      for (const line of this.lines) {\n        const first = line.pos[0]\n        const last = line.pos[line.pos.length - 1]\n\n        const p1 = this.plotter.getPointAt(first[0], first[1])\n        const p2 = this.plotter.getPointAt(last[0], last[1])\n        if (!p1 || !p2) continue\n\n        const c1 = p1.color\n        const c2 = p2.color\n\n        if (c1 !== 'white' && c2 !== 'white') {\n          if (c1 === c2) line._color = c1\n        } else if (c1 === 'white' && c2 === 'white') {\n          line._color = 'white'\n        } else {\n          if (c1 !== 'white') {\n            line._color = c1\n            if (p2 instanceof Pad) p2.color = c1\n          } else if (c2 !== 'white') {\n            line._color = c2\n            if (p1 instanceof Pad) p1.color = c2\n          }\n        }\n      }\n    }\n\n    this.dispatch('game-update', undefined, true)\n\n    let completed = true\n\n    // TODO: Check for completeness correctly\n\n    for (const term of this.terminals) {\n      const nConn = this.plotter.getLinesAtPoint(term.pos[0], term.pos[1]).length\n      if (nConn !== 1) completed = false\n    }\n\n    for (const pad of this.pads) {\n      const nConn = this.plotter.getLinesAtPoint(pad.pos[0], pad.pos[1]).length\n      if (nConn !== 2 && pad._color !== 'white') completed = false\n    }\n\n    console.log('game-complete', this.currentLevel, completed)\n    this.dispatch('game-complete', { level: this.currentLevel, completed }, true)\n  }\n\n  finalizeMove(lineID: number): void {\n    if (this.plotter.verifyLineLegality(lineID)) {\n      this.updateUndoStack()\n      this.propagateColors()\n      this.save()\n    }\n    this.dispatch('game-update', undefined, true)\n  }\n}\n","import { LineSegments, LineBasicMaterial, Float32BufferAttribute, BufferGeometry, Color, AdditiveBlending } from 'three/webgpu'\n\nclass Grid extends LineSegments {\n\n  declare public geometry: BufferGeometry\n  declare public material: LineBasicMaterial\n\n  constructor() {\n\n\t\tconst geometry = new BufferGeometry()\n\t\tconst material = new LineBasicMaterial( { transparent: true, vertexColors: true, toneMapped: false, blending: AdditiveBlending } )\n\t\tsuper( geometry, material )\n\n\t}\n\n\tupdate( width: number, height: number ) {\n\n\t\tif ( width === 0 || height === 0 ) {\n\t\t\tthis.geometry.setAttribute( 'position', new Float32BufferAttribute( [], 3 ) )\n\t\t\tthis.geometry.setAttribute( 'color', new Float32BufferAttribute( [], 4 ) )\n\t\t\treturn\n\t\t}\n\n\t\tconst color = new Color( 0x666666 )\n\t\tconst color2 = new Color( 0x333333 )\n\n    const hSegments = width * ( height + 1 )\n\t\tconst vSegments = height * ( width + 1 )\n\t\tconst dSegments = width * height * 4\n\t\tconst totalSegments = hSegments + vSegments + dSegments\n\t\tconst totalVertices = totalSegments * 2\n\n\t\tconst positions = new Float32Array( totalVertices * 3 )\n\t\tconst colors = new Float32Array( totalVertices * 4 )\n\n\t\tlet vi = 0\n\n\t\tconst pushVertex = ( x: number, y: number, c: Color ) => {\n\n\t\t\tconst pi = vi * 3\n\t\t\tconst ci = vi * 4\n\t\t\tpositions[ pi ] = x\n\t\t\tpositions[ pi + 1 ] = y\n\t\t\tpositions[ pi + 2 ] = 0\n\t\t\tc.toArray( colors, ci )\n\t\t\tcolors[ ci + 3 ] = 1\n\t\t\tvi ++\n\n\t\t}\n\n\t\t// Horizontal segments\n\t\tfor ( let iz = 0; iz <= height; iz ++ ) {\n\t\t\tfor ( let ix = 0; ix < width; ix ++ ) {\n\t\t\t\tpushVertex( ix, iz, color )\n\t\t\t\tpushVertex( ix + 1, iz, color )\n\t\t\t}\n\t\t}\n\n\t\t// Vertical segments\n\t\tfor ( let ix = 0; ix <= width; ix ++ ) {\n\t\t\tfor ( let iz = 0; iz < height; iz ++ ) {\n\t\t\t\tpushVertex( ix, iz, color )\n\t\t\t\tpushVertex( ix, iz + 1, color )\n\t\t\t}\n\t\t}\n\n\t\t// Diagonal segments (4 per cell: center to each corner)\n\t\tfor ( let cz = 0; cz < height; cz ++ ) {\n\t\t\tfor ( let cx = 0; cx < width; cx ++ ) {\n\t\t\t\tconst centerX = cx + 0.5\n\t\t\t\tconst centerZ = cz + 0.5\n\t\t\t\tpushVertex( centerX, centerZ, color2 )\n\t\t\t\tpushVertex( cx, cz, color )\n\t\t\t\tpushVertex( centerX, centerZ, color2 )\n\t\t\t\tpushVertex( cx + 1, cz, color )\n\t\t\t\tpushVertex( centerX, centerZ, color2 )\n\t\t\t\tpushVertex( cx, cz + 1, color )\n\t\t\t\tpushVertex( centerX, centerZ, color2 )\n\t\t\t\tpushVertex( cx + 1, cz + 1, color )\n\t\t\t}\n\n\t\t}\n\n\t\tthis.geometry.setAttribute( 'position', new Float32BufferAttribute( positions, 3 ) )\n\t\tthis.geometry.setAttribute( 'color', new Float32BufferAttribute( colors, 4 ) )\n\t}\n\n\tdispose() {\n\t\tthis.geometry.dispose()\n\t\tthis.material.dispose()\n\t}\n\n}\n\n\nexport { Grid }\n","import {\n  AmbientLight,\n  BoxGeometry,\n  CapsuleGeometry,\n  Color,\n  InstancedMesh,\n  Matrix4,\n  MeshPhongMaterial,\n  OrthographicCamera,\n  PointLight,\n  Quaternion,\n  SphereGeometry,\n  Vector3,\n} from 'three/webgpu'\nimport { Register } from '@io-gui/core'\nimport { ThreeApplet, ThreeAppletProps } from '@io-gui/three'\nimport { Pad } from '../game/items/pad'\nimport { Line } from '../game/items/line'\nimport { Terminal, TERMINAL_COLORS } from '../game/items/terminal'\nimport type { TerminalColor } from '../game/items/terminal'\nimport { Grid } from '../objects/grid'\n\nconst PAD_SPHERE_RADIUS = 0.25\nconst TERMINAL_BOX_SIZE = 0.5\nconst LINE_CAPSULE_RADIUS = 0.12\nconst LINE_CAPSULE_AXIS_LENGTH = 1\nconst LINE_DIAGONAL_INSET = 0.035\nconst LINE_LAYER_BEHIND_Z = -0.25\nconst LINE_LAYER_MINUS_ONE_WIDTH_FACTOR = 1.5\nconst LINE_LAYER_MINUS_ONE_COLOR_FACTOR = 0.25\n\nconst _yAxis = new Vector3(0, 1, 0)\nconst _segmentDir = new Vector3()\nconst _segmentQuat = new Quaternion()\nconst _segmentScale = new Vector3()\nconst _segmentPosition = new Vector3()\n\n@Register\nexport class ThreeScene extends ThreeApplet {\n\n  public camera: OrthographicCamera\n  public grid: Grid = new Grid()\n  public pads: InstancedMesh\n  public terminals: InstancedMesh\n  public lines: InstancedMesh\n\n  static padGeometry: SphereGeometry = new SphereGeometry(PAD_SPHERE_RADIUS, 16, 12)\n  static padMaterial: MeshPhongMaterial = new MeshPhongMaterial({ vertexColors: true })\n  static terminalGeometry: BoxGeometry = new BoxGeometry(TERMINAL_BOX_SIZE, TERMINAL_BOX_SIZE, TERMINAL_BOX_SIZE * 0.6)\n  static terminalMaterial: MeshPhongMaterial = new MeshPhongMaterial({ vertexColors: true })\n  static lineGeometry: CapsuleGeometry = new CapsuleGeometry(LINE_CAPSULE_RADIUS, LINE_CAPSULE_AXIS_LENGTH, 4, 8)\n  static lineMaterial: MeshPhongMaterial = new MeshPhongMaterial({ vertexColors: true })\n\n  private static instanceColor(terminalColor: TerminalColor): Color {\n    return new Color(TERMINAL_COLORS[terminalColor] ?? TERMINAL_COLORS.white)\n  }\n\n  constructor(args: ThreeAppletProps) {\n    super(args)\n\n    this.camera = new OrthographicCamera(-1, 1, 1, -1, 0.1, 1000)\n    this.scene.add(this.camera)\n\n    this.scene.add(this.grid)\n\n    this.pads = new InstancedMesh(ThreeScene.padGeometry, ThreeScene.padMaterial, 0)\n    this.terminals = new InstancedMesh(ThreeScene.terminalGeometry, ThreeScene.terminalMaterial, 0)\n    this.lines = new InstancedMesh(ThreeScene.lineGeometry, ThreeScene.lineMaterial, 0)\n\n    const ambientLight = new AmbientLight( 0xcccccc, 1.5 )\n    this.scene.add( ambientLight )\n\n    const pointLight = new PointLight( 0xffffff, 2.5, 0, 0 )\n    pointLight.position.set( 0, 0, 500 )\n    this.scene.add( pointLight )\n  }\n\n  updateGrid(width: number, height: number) {\n    this.grid.update(width, height)\n\n    const size = Math.max(width, height)\n    this.camera.left = -size / 2\n    this.camera.right = size / 2\n    this.camera.top = size / 2\n    this.camera.bottom = -size / 2\n    this.camera.position.set(width / 2, height / 2, 10)\n\n    this.camera.updateProjectionMatrix()\n  }\n\n  updatePads(pads: Pad[]) {\n    if (this.pads.parent) {\n      this.scene.remove(this.pads)\n      if (pads.length === 0) return\n    }\n\n    this.pads = new InstancedMesh(ThreeScene.padGeometry, ThreeScene.padMaterial, pads.length)\n    const matrix = new Matrix4()\n    const padColor = new Color()\n    for (let i = 0; i < pads.length; i++) {\n      matrix.makeTranslation(pads[i].pos[0], pads[i].pos[1], 0)\n      this.pads.setMatrixAt(i, matrix)\n      padColor.copy(ThreeScene.instanceColor(pads[i].color))\n      this.pads.setColorAt(i, padColor)\n    }\n    this.pads.instanceMatrix.needsUpdate = true\n    if (this.pads.instanceColor) this.pads.instanceColor.needsUpdate = true\n    this.scene.add(this.pads)\n  }\n\n  updateTerminals(terminals: Terminal[]) {\n    if (this.terminals.parent) {\n      this.scene.remove(this.terminals)\n    }\n    this.terminals = new InstancedMesh(\n      ThreeScene.terminalGeometry,\n      ThreeScene.terminalMaterial,\n      terminals.length\n    )\n    const matrix = new Matrix4()\n    const terminalColor = new Color()\n    for (let i = 0; i < terminals.length; i++) {\n      matrix.makeTranslation(terminals[i].pos[0], terminals[i].pos[1], 0)\n      this.terminals.setMatrixAt(i, matrix)\n      terminalColor.copy(ThreeScene.instanceColor(terminals[i].color))\n      this.terminals.setColorAt(i, terminalColor)\n    }\n    this.terminals.instanceMatrix.needsUpdate = true\n    if (this.terminals.instanceColor) this.terminals.instanceColor.needsUpdate = true\n    this.scene.add(this.terminals)\n  }\n  updateLines(lines: Line[]) {\n    if (this.lines.parent) {\n      this.scene.remove(this.lines)\n    }\n    const segmentCount = lines.reduce((n, line) => n + Math.max(0, line.pos.length - 1), 0)\n    this.lines = new InstancedMesh(\n      ThreeScene.lineGeometry,\n      ThreeScene.lineMaterial,\n      segmentCount\n    )\n    const matrix = new Matrix4()\n    const lineColor = new Color()\n    let idx = 0\n    for (const line of lines) {\n      lineColor.copy(ThreeScene.instanceColor(line.color))\n      if (line.layer === -1) {\n        lineColor.multiplyScalar(LINE_LAYER_MINUS_ONE_COLOR_FACTOR)\n      }\n      const pos = line.pos\n      const isBehind = line.layer === -1\n      const widthScale = isBehind ? LINE_LAYER_MINUS_ONE_WIDTH_FACTOR : 1\n      const segmentZ = isBehind ? LINE_LAYER_BEHIND_Z : 0\n      for (let j = 0; j < pos.length - 1; j++) {\n        const ax = pos[j][0]\n        const ay = pos[j][1]\n        const bx = pos[j + 1][0]\n        const by = pos[j + 1][1]\n        _segmentPosition.set((ax + bx) / 2, (ay + by) / 2, segmentZ)\n        const dx = bx - ax\n        const dy = by - ay\n        const segmentLength = Math.sqrt(dx * dx + dy * dy) || 1\n        const isDiagonal = segmentLength > 1.01\n        const effectiveLength = isDiagonal ? segmentLength - 2 * LINE_DIAGONAL_INSET : segmentLength\n        _segmentDir.set(dx / segmentLength, dy / segmentLength, 0)\n        _segmentQuat.setFromUnitVectors(_yAxis, _segmentDir)\n        _segmentScale.set(widthScale, effectiveLength / LINE_CAPSULE_AXIS_LENGTH, widthScale)\n        matrix.compose(\n          _segmentPosition,\n          _segmentQuat,\n          _segmentScale\n        )\n        this.lines.setMatrixAt(idx, matrix)\n        this.lines.setColorAt(idx, lineColor)\n        idx++\n      }\n    }\n    this.lines.instanceMatrix.needsUpdate = true\n    if (this.lines.instanceColor) this.lines.instanceColor.needsUpdate = true\n    this.scene.add(this.lines)\n  }\n\n  // onAnimate(delta: number, time: number) {}\n\n}\n","import { Register } from '@io-gui/core'\nimport { Pointer3D, ToolBase } from '@io-gui/three'\n\n@Register\nexport class PointerTool extends ToolBase {\n  on3DPointerDown(pointers: Pointer3D[]) {\n    this.dispatch('3dpointer-down', pointers, true)\n  }\n  on3DPointerMove(pointers: Pointer3D[]) {\n    this.dispatch('3dpointer-move', pointers, true)\n  }\n  on3DPointerUp(pointers: Pointer3D[]) {\n    this.dispatch('3dpointer-up', pointers, true)\n  }\n  on3DPointerCancel(pointers: Pointer3D[]) {\n    this.dispatch('3dpointer-cancel', pointers, true)\n  }\n}","import {\n  Register,\n  IoElement,\n  IoElementProps,\n  ReactiveProperty,\n} from '@io-gui/core'\nimport { Vector2 } from 'three'\nimport { Game } from './game/game.js'\nimport { ThreeScene } from './scene/threeScene.js'\nimport { ioThreeViewport, Pointer3D } from '@io-gui/three'\nimport { PointerTool } from './tools/pointerTool.js'\n\nconst _pos = new Vector2()\nconst _posOld = new Vector2()\n\ntype CircuitsBoardProps = IoElementProps & {\n  game: Game\n}\n\n/**\n * CircuitsBoard — 3D game board IoElement.\n * Owns the ThreeScene, hosts io-three-viewport, handles pointer events,\n * and maps viewport coordinates to grid via camera unproject (plotter logic).\n */\n@Register\nexport class CircuitsBoard extends IoElement {\n\n  static get Style() {\n    return /* css */`\n      :host {\n        display: flex;\n        flex: 1 1 auto;\n        flex-direction: column;\n        max-width: 100%;\n        max-height: 100%;\n      }\n    `\n  }\n\n  static get Listeners(): Record<string, string> {\n    return {\n      '3dpointer-down': 'on3DPointerDown',\n      '3dpointer-move': 'on3DPointerMove',\n      '3dpointer-up': 'on3DPointerUp',\n\n      'game-init-scene': 'onGameInit',\n      'game-update': 'onGameUpdate',\n      'line-end-drag': 'onEndDrag',\n    }\n  }\n\n  @ReactiveProperty({type: ThreeScene, init: null})\n  declare applet: ThreeScene\n\n  @ReactiveProperty({ type: Game })\n  declare game: Game\n\n  private _currentID: number = 0\n\n  constructor(args: CircuitsBoardProps) {\n    super(args)\n  }\n\n  onGameInit() {\n    this.applet.updateGrid(this.game.width, this.game.height)\n    this.onGameUpdate()\n  };\n  onGameUpdate() {\n    this.applet.updatePads(this.game.pads)\n    this.applet.updateTerminals(this.game.terminals)\n    this.applet.updateLines(this.game.lines)\n    // TODO: hmm?\n    this.applet.dispatch('three-applet-needs-render', undefined, true)\n  };\n\n  ready() {\n    this.render([\n      ioThreeViewport({applet: this.applet, tool: new PointerTool({}), cameraSelect: 'scene', overscan: 1.2}),\n    ])\n  }\n\n  on3DPointerDown(event: CustomEvent<Pointer3D[]>) {\n    if (event.detail.length !== 1) return\n    _pos.set(\n      Math.round(event.detail[0].origin.x),\n      Math.round(event.detail[0].origin.y),\n    )\n    _posOld.copy(_pos)\n\n    this._currentID = Math.floor(Math.random() * 100000)\n\n    if (this.game.drawMode === 'pad') {\n      console.log( _pos.x, _pos.y)\n      this.game.plotter.addPad(this._currentID, _pos.x, _pos.y)\n    }\n    if (this.game.drawMode === 'terminal') {\n      this.game.plotter.addTerminal(this._currentID, _pos.x, _pos.y, this.game.drawColor)\n    }\n    if (this.game.drawMode === 'line') {\n      this.game.plotter.addLineSegment(this._currentID, _pos.x, _pos.y, this.game.drawLayer)\n    }\n    if (this.game.drawMode === 'delete') {\n      this.game.plotter.delete(_pos.x, _pos.y)\n    }\n  }\n\n  on3DPointerMove(event: CustomEvent<Pointer3D[]>) {\n    if (event.detail.length !== 1) return\n    _pos.set(\n      Math.round(event.detail[0].origin.x),\n      Math.round(event.detail[0].origin.y),\n    )\n    if (this.game.drawMode === 'line' && _pos.distanceTo(_posOld) > 0) {\n      this.game.plotter.addLineSegment(this._currentID, _pos.x, _pos.y, this.game.drawLayer)\n    }\n  }\n\n  on3DPointerUp(event: PointerEvent) {\n    event.preventDefault()\n    this.onEndDrag()\n  }\n\n  onEndDrag() {\n    if (this.game) this.game.finalizeMove(this._currentID)\n  }\n\n  dispose() {\n    this.applet.dispose()\n    super.dispose()\n  }\n\n}\n\nexport const circuitsBoard = function(arg0: CircuitsBoardProps) {\n  return CircuitsBoard.vConstructor(arg0)\n}","import { IoElement, Register, ReactiveProperty, IoElementProps, div, WithBinding, ListenerDefinitions } from '@io-gui/core'\nimport { ioButton } from '@io-gui/inputs'\nimport { Game } from './game/game.js'\nimport { circuitsBoard } from './CircuitsBoard.js'\n\ntype CircuitsGameProps = IoElementProps & {\n  level: WithBinding<string>\n  game: Game\n}\n\nexport class CircuitsGame extends IoElement {\n  static get Style() {\n    return /* css */`\n      :host {\n        display: flex;\n        flex-direction: column;\n        height: 100%;\n      }\n      :host > .game-toolbar {\n        display: flex;\n        gap: 2px;\n        padding: 2px;\n        flex-shrink: 0;\n      }\n      :host > .game-toolbar > io-button {\n        flex: 1 1 auto;\n        height: calc(var(--io_fieldHeight) * 1.5);\n        display: flex;\n        align-items: center;\n      }\n      :host > .game-toolbar > io-button > io-icon {\n        margin-left: auto;\n      }\n      :host > .game-toolbar > io-button > span {\n        margin-right: auto;\n      }\n    `\n  }\n\n  static get Listeners(): ListenerDefinitions {\n    return {\n      'game-complete': 'onGameComplete',\n    }\n  }\n\n  @ReactiveProperty({value: '', type: String})\n  declare level: string\n\n  @ReactiveProperty({type: Game, init: null})\n  declare game: Game\n\n  completeFn: ((level: string, completed: boolean) => void) | null = null\n\n  constructor(args: CircuitsGameProps) { super(args) }\n\n  ready() {\n    this.changed()\n  }\n\n  onGameComplete(event: CustomEvent<{ level: string; completed: boolean }>) {\n    if (this.completeFn) this.completeFn(event.detail.level, event.detail.completed)\n  }\n\n  changed() {\n    this.render([\n      circuitsBoard({id: 'board', game: this.game}),\n      div({class: 'game-toolbar'}, [\n        ioButton({label: 'Undo', icon: 'io:undo', action: this.onUndo}),\n        ioButton({label: 'Reset', icon: 'io:reload', action: this.onReset}),\n        ioButton({label: 'Redo', icon: 'io:redo', action: this.onRedo}),\n      ]),\n    ])\n  }\n\n  levelChanged() {\n    this.game.currentLevel = this.level\n  }\n\n  onUndo() {\n    this.game.undo()\n  }\n\n  onRedo() {\n    this.game.redo()\n  }\n\n  onReset() {\n    this.game.reload()\n  }\n\n  onEdit() {\n    this.changed()\n  }\n\n}\n\nRegister(CircuitsGame)\n\nexport const circuitsGame = function(arg0: CircuitsGameProps) {\n  return CircuitsGame.vConstructor(arg0)\n}\n","import {\n  Register,\n  IoElement,\n  ReactiveProperty,\n  Storage as $,\n  ListenerDefinitions,\n  div\n} from '@io-gui/core'\nimport { ioSplit, Split } from '@io-gui/layout'\nimport { ioButton } from '@io-gui/inputs'\nimport { TERMINAL_COLORS } from './game/items/terminal.js'\nimport { circuitsLevels, CircuitsLevels } from './CircuitsLevels.js'\nimport { circuitsGame } from './CircuitsGame.js'\nimport { DrawMode, Game } from './game/game.js'\n\n$.permit()\nconst $level = $({ key: 'level', storage: 'hash', value: '' })\nconst $completed = $({\n  key: 'circuits-completed',\n  storage: 'local',\n  value: '[]',\n})\n\n@Register\nexport class CircuitsApp extends IoElement {\n  static get Style() {\n    return /* css */ `\n      :host {\n        display: flex;\n        position: fixed;\n        inset: 0;\n        background-color: var(--io_bgColor);\n        color: var(--io_color);\n        user-select: none;\n        -webkit-user-select: none;\n        -webkit-text-size-adjust: none;\n        -webkit-touch-callout: none;\n      }\n    `\n  }\n\n  @ReactiveProperty({ type: Game, init: null })\n  declare game: Game\n\n  static get Listeners(): ListenerDefinitions {\n    return {\n      'level-select': 'onLevelSelect',\n      'editor-select': 'onEditorSelect',\n    }\n  }\n\n  ready() {\n    const completedIds = this._getCompletedIds()\n    this.render([\n      ioSplit({\n        split: new Split({\n          type: 'split',\n          children: [\n            { type: 'panel', flex: '0 0 110px', tabs: [{ id: 'levels' }] },\n            { type: 'panel', flex: '1 1 auto', tabs: [{ id: 'game' }] },\n            { type: 'panel', flex: '0 0 120px', tabs: [{ id: 'editor' }] },\n          ],\n        }),\n        elements: [\n          circuitsLevels({ id: 'levels', completedLevels: completedIds } as {\n            id: string\n            completedLevels: string[]\n          }),\n          circuitsGame({ id: 'game', level: $level, game: this.game }),\n          div({id: 'editor'}, [\n            ioButton({ label: 'Pad', action: () => this._select('pad', '') }),\n            ...Object.keys(TERMINAL_COLORS).map((c) =>\n              ioButton({ label: c, action: () => this._select('terminal', c) }),\n            ),\n            ioButton({\n              label: 'Line (top)',\n              action: () => this.dispatch('editor-select', { mode: 'line', layer: 0 }, true),\n            }),\n            ioButton({\n              label: 'Line (bottom)',\n              action: () => this.dispatch('editor-select', { mode: 'line', layer: -1 }, true),\n            }),\n            ioButton({ label: 'Delete', action: () => this._select('delete', 'red') }),\n          ])\n        ],\n      }),\n    ])\n    const gameEl = this.querySelector('#game') as {\n      completeFn?: (level: string, completed: boolean) => void\n    } | null\n    if (gameEl) {\n      gameEl.completeFn = (level: string, completed: boolean) =>\n        this.onLevelComplete(level, completed)\n    }\n  }\n\n  private _getCompletedIds(): string[] {\n    try {\n      return JSON.parse($completed.value || '[]') as string[]\n    } catch {\n      return []\n    }\n  }\n\n  private _select(mode: DrawMode, color: string) {\n    this.dispatch('editor-select', { mode, color }, true)\n  }\n\n  private _setCompletedIds(ids: string[]) {\n    $completed.value = JSON.stringify(ids)\n  }\n\n  onLevelComplete(level: string, completed: boolean) {\n    if (!completed) return\n    const ids = this._getCompletedIds()\n    if (ids.includes(level)) return\n    this._setCompletedIds([...ids, level])\n    const levelsEl = this.querySelector('#levels') as CircuitsLevels | null\n    if (levelsEl?.refreshCompleted)\n      levelsEl.refreshCompleted(this._getCompletedIds())\n  }\n\n  onEditorSelect(event: CustomEvent) {\n    event.stopPropagation()\n    const { mode, color, layer } = event.detail\n    this.game.drawMode = mode\n    console.log(mode)\n    if (mode === 'line' && layer !== undefined) {\n      this.game.drawLayer = layer\n    } else if (color !== undefined) {\n      this.game.drawColor = color\n    }\n    this.changed()\n  }\n\n  onLevelSelect(event: CustomEvent) {\n    event.stopPropagation()\n    const { level } = event.detail\n    $level.value = level\n  }\n}\n"],"names":["TERMINAL_COLORS","white","red","green","blue","pink","yellow","orange","purple","brown","grey","black","Terminal","id","pos","color","constructor","this","toJSON","fromJSON","data","CircuitsLevels","IoElement","Style","_option","MenuOption","options","_levelIds","ready","_loadLevels","changed","_buildLevelOptions","levelIds","completedIds","map","label","disabled","includes","action","dispatch","level","response","fetch","json","completed","completedLevels","refreshCompleted","render","ioMenuTree","option","__decorateClass","ReactiveProperty","type","Array","value","prototype","Register","circuitsLevels","vConstructor","Pad","_color","Line","layer","hasDiagonalSegmentAt","mx","my","i","length","ax","ay","bx","by","Math","abs","plotSegment","x","y","_tryEraseLastSegment","_tryAddNewSegment","line","j","ln","pop","push","last","Plotter","ReactiveNode","width","height","pads","terminals","lines","connect","getPointAt","pad","term","getLinesAtPoint","filter","some","px","py","getLineById","find","l","checkDiagonalCrossing","other","addPad","addTerminal","padIdx","findIndex","p","splice","termIdx","t","lineIdx","verifyLineLegality","first","p1","p2","idx","addLineSegment","point","linesAtPoint","underlineLinesAtPoint","connectionLimit","added","endDrag","sameLineAtPoint","newLine","Game","drawMode","drawColor","drawLayer","undoStack","redoStack","clear","plotter","initialize","storedState","$","key","currentLevel","storage","Object","keys","load","JSON","stringify","propagateColors","currentLevelChanged","then","reload","resp","ok","console","error","text","save","e","warn","jsonText","state","parse","updateUndoStack","undo","currentState","redo","resetColors","iter","c1","c2","log","finalizeMove","lineID","String","init","Property","Grid","LineSegments","super","BufferGeometry","LineBasicMaterial","transparent","vertexColors","toneMapped","blending","AdditiveBlending","update","geometry","setAttribute","Float32BufferAttribute","Color","color2","totalVertices","positions","Float32Array","colors","vi","pushVertex","c","pi","ci","toArray","iz","ix","cz","cx","centerX","centerZ","dispose","material","_yAxis","Vector3","_segmentDir","_segmentQuat","Quaternion","_segmentScale","_segmentPosition","ThreeScene","ThreeApplet","camera","grid","instanceColor","terminalColor","args","OrthographicCamera","scene","add","InstancedMesh","padGeometry","padMaterial","terminalGeometry","terminalMaterial","lineGeometry","lineMaterial","ambientLight","AmbientLight","pointLight","PointLight","position","set","updateGrid","size","max","left","right","top","bottom","updateProjectionMatrix","updatePads","parent","remove","matrix","Matrix4","padColor","makeTranslation","setMatrixAt","copy","setColorAt","instanceMatrix","needsUpdate","updateTerminals","updateLines","segmentCount","reduce","n","lineColor","multiplyScalar","isBehind","widthScale","segmentZ","dx","dy","segmentLength","sqrt","effectiveLength","setFromUnitVectors","compose","__publicField","SphereGeometry","MeshPhongMaterial","BoxGeometry","TERMINAL_BOX_SIZE","CapsuleGeometry","PointerTool","ToolBase","on3DPointerDown","pointers","on3DPointerMove","on3DPointerUp","on3DPointerCancel","_pos","Vector2","_posOld","CircuitsBoard","Listeners","_currentID","onGameInit","applet","game","onGameUpdate","ioThreeViewport","tool","cameraSelect","overscan","event","detail","round","origin","floor","random","delete","distanceTo","preventDefault","onEndDrag","CircuitsGame","completeFn","onGameComplete","arg0","div","class","ioButton","icon","onUndo","onReset","onRedo","levelChanged","onEdit","permit","$level","$completed","CircuitsApp","_getCompletedIds","ioSplit","split","Split","children","flex","tabs","elements","_select","mode","gameEl","querySelector","onLevelComplete","_setCompletedIds","ids","levelsEl","onEditorSelect","stopPropagation","onLevelSelect"],"mappings":"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"}