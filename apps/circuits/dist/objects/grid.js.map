{"version":3,"file":"grid.js","sourceRoot":"","sources":["../../src/objects/grid.ts"],"names":[],"mappings":"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","sourcesContent":["import { LineSegments, LineBasicMaterial, Float32BufferAttribute, BufferGeometry, Color, AdditiveBlending } from 'three/webgpu'\nimport type { Line } from '../game/items/line.js'\nimport type { Pad } from '../game/items/pad.js'\n\nclass Grid extends LineSegments {\n\n  declare public geometry: BufferGeometry\n  declare public material: LineBasicMaterial\n\n  public width: number = 0\n  public height: number = 0\n\n  constructor() {\n\n\t\tconst geometry = new BufferGeometry()\n\t\tconst material = new LineBasicMaterial( { transparent: true, vertexColors: true, toneMapped: false, blending: AdditiveBlending } )\n\t\tsuper( geometry, material )\n\n\t}\n\n\tupdate( width: number, height: number, lines: Line[], pads: Pad[] ) {\n\n    this.width = width\n    this.height = height\n\n    if ( width === 0 || height === 0 ) {\n\t\t\tthis.geometry.setAttribute( 'position', new Float32BufferAttribute( [], 3 ) )\n\t\t\tthis.geometry.setAttribute( 'color', new Float32BufferAttribute( [], 4 ) )\n\t\t\treturn\n\t\t}\n\n\t\t/*\n\t\t * Grid segment visibility algorithm\n\t\t *\n\t\t * A grid segment (horizontal, vertical, or diagonal) is hidden (alpha = 0)\n\t\t * when any of the following rules apply:\n\t\t *\n\t\t * 1. Vertex on layer-0 line without a pad:\n\t\t *    If either vertex of the segment touches a position occupied by a\n\t\t *    game line on layer 0, the segment is hidden â€” unless a pad exists\n\t\t *    at that contact point (pads keep the grid visible).\n\t\t *\n\t\t * 2. Vertex on a fully-connected pad:\n\t\t *    If either vertex coincides with a pad that has 2 or more line\n\t\t *    connections (regardless of layer), the segment is hidden.\n\t\t *\n\t\t * 3. Vertex on a connected terminal pad:\n\t\t *    If either vertex coincides with a terminal pad that has at least 1\n\t\t *    line connection, the segment is hidden.\n\t\t *\n\t\t * 4. Perpendicular diagonal crossing:\n\t\t *    A diagonal grid segment is hidden if a layer-0 game line has a\n\t\t *    diagonal segment crossing the same cell in the perpendicular\n\t\t *    direction (e.g. a \"\\\" game line hides the \"/\" grid diagonal).\n\t\t */\n\n\t\t// Build lookup structures for visibility checks\n\t\tconst linePointsL0 = new Set<string>()\n\t\tconst padPositions = new Set<string>()\n\t\tconst padConnectionCounts = new Map<string, number>()\n\t\tconst terminalPadPositions = new Set<string>()\n\t\t// Cells with layer-0 diagonal game lines: backslash \"\\\" and slash \"/\"\n\t\tconst cellDiagBackslash = new Set<string>()\n\t\tconst cellDiagSlash = new Set<string>()\n\n\t\tfor ( const pad of pads ) {\n\t\t\tconst key = pad.pos[ 0 ] + ',' + pad.pos[ 1 ]\n\t\t\tpadPositions.add( key )\n\t\t\tpadConnectionCounts.set( key, 0 )\n\t\t\tif ( pad.isTerminal ) terminalPadPositions.add( key )\n\t\t}\n\n\t\tfor ( const line of lines ) {\n\t\t\tif ( line.layer === 0 ) {\n\t\t\t\tconst lastIdx = line.pos.length - 1\n        if ( line.pos.length === 1) continue\n\t\t\t\tfor ( let i = 0; i <= lastIdx; i ++ ) {\n\t\t\t\t\tconst pos = line.pos[ i ]\n\t\t\t\t\tconst key = pos[ 0 ] + ',' + pos[ 1 ]\n\t\t\t\t\t// Skip dangling endpoints (first/last with no terminal pad)\n\t\t\t\t\tif ( ( i === 0 || i === lastIdx ) && !terminalPadPositions.has( key ) ) continue\n\t\t\t\t\tlinePointsL0.add( key )\n\t\t\t\t}\n\t\t\t\tfor ( let i = 1; i < line.pos.length; i ++ ) {\n\t\t\t\t\tconst ax = line.pos[ i - 1 ][ 0 ]\n\t\t\t\t\tconst ay = line.pos[ i - 1 ][ 1 ]\n\t\t\t\t\tconst bx = line.pos[ i ][ 0 ]\n\t\t\t\t\tconst by = line.pos[ i ][ 1 ]\n\t\t\t\t\tconst dx = bx - ax\n\t\t\t\t\tconst dy = by - ay\n\t\t\t\t\tif ( Math.abs( dx ) === 1 && Math.abs( dy ) === 1 ) {\n\t\t\t\t\t\tconst cellKey = Math.min( ax, bx ) + ',' + Math.min( ay, by )\n\t\t\t\t\t\tif ( ( dx > 0 ) === ( dy > 0 ) ) {\n\t\t\t\t\t\t\tcellDiagBackslash.add( cellKey )\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tcellDiagSlash.add( cellKey )\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tconst first = line.pos[ 0 ]\n\t\t\tconst last = line.pos[ line.pos.length - 1 ]\n\t\t\tconst firstKey = first[ 0 ] + ',' + first[ 1 ]\n\t\t\tconst lastKey = last[ 0 ] + ',' + last[ 1 ]\n\t\t\tif ( padConnectionCounts.has( firstKey ) ) {\n\t\t\t\tpadConnectionCounts.set( firstKey, padConnectionCounts.get( firstKey )! + 1 )\n\t\t\t}\n\t\t\tif ( padConnectionCounts.has( lastKey ) ) {\n\t\t\t\tpadConnectionCounts.set( lastKey, padConnectionCounts.get( lastKey )! + 1 )\n\t\t\t}\n\t\t}\n\n\t\tconst isHidden = ( [x, y]: [number, number] ): boolean => {\n\t\t\tconst key = x + ',' + y\n\t\t\t// Rule 1: On a layer-0 line and no pad at this position\n\t\t\tif ( linePointsL0.has( key ) && !padPositions.has( key ) ) return true\n\t\t\t// Rule 2: Pad with 2+ line connections\n\t\t\tconst padConns = padConnectionCounts.get( key )\n\t\t\tif ( padConns !== undefined ) {\n\t\t\t\tif ( terminalPadPositions.has( key ) ) {\n\t\t\t\t\tif ( padConns >= 1 ) return true\n\t\t\t\t} else if ( padConns >= 2 ) {\n\t\t\t\t\treturn true\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn false\n\t\t}\n\n\t\tconst color = new Color( 0x666666 )\n\t\tconst color2 = new Color( 0x666666 )\n\n    const hSegments = width * ( height + 1 )\n\t\tconst vSegments = height * ( width + 1 )\n\t\tconst dSegments = width * height * 2\n\t\tconst totalSegments = hSegments + vSegments + dSegments\n\t\tconst totalVertices = totalSegments * 2\n\n\t\tconst positions = new Float32Array( totalVertices * 3 )\n\t\tconst colors = new Float32Array( totalVertices * 4 )\n\n\t\tlet vi = 0\n\n\t\tconst pushVertex = ( [x, y]: [number, number], c: Color, alpha: number ) => {\n\n\t\t\tconst pi = vi * 3\n\t\t\tconst ci = vi * 4\n\t\t\tpositions[ pi ] = x\n\t\t\tpositions[ pi + 1 ] = y\n\t\t\tpositions[ pi + 2 ] = 0\n\t\t\tc.toArray( colors, ci )\n\t\t\tcolors[ ci + 3 ] = alpha\n\t\t\tvi ++\n\n\t\t}\n\n\t\t// Horizontal segments\n\t\tfor ( let iz = 0; iz <= height; iz ++ ) {\n\t\t\tfor ( let ix = 0; ix < width; ix ++ ) {\n\t\t\t\tconst alpha = ( isHidden( [ix, iz] ) || isHidden( [ix + 1, iz] ) ) ? 0.15 : 1\n\t\t\t\tpushVertex( [ix, iz], color, alpha )\n\t\t\t\tpushVertex( [ix + 1, iz], color, alpha )\n\t\t\t}\n\t\t}\n\n\t\t// Vertical segments\n\t\tfor ( let ix = 0; ix <= width; ix ++ ) {\n\t\t\tfor ( let iz = 0; iz < height; iz ++ ) {\n\t\t\t\tconst alpha = ( isHidden( [ix, iz] ) || isHidden( [ix, iz + 1] ) ) ? 0.15 : 1\n\t\t\t\tpushVertex( [ix, iz], color, alpha )\n\t\t\t\tpushVertex( [ix, iz + 1], color, alpha )\n\t\t\t}\n\t\t}\n\n\t\t// Diagonal segments (2 per cell: corner to corner)\n\t\tfor ( let cz = 0; cz < height; cz ++ ) {\n\t\t\tfor ( let cx = 0; cx < width; cx ++ ) {\n\t\t\t\tconst cellKey = cx + ',' + cz\n\t\t\t\t// \"\\\" grid diagonal: hidden if perpendicular \"/\" game line crosses this cell\n\t\t\t\tconst a1 = ( isHidden( [cx, cz] ) || isHidden( [cx + 1, cz + 1] ) || cellDiagSlash.has( cellKey ) ) ? 0 : 1\n\t\t\t\tpushVertex( [cx, cz], color2, a1 )\n\t\t\t\tpushVertex( [cx + 1, cz + 1], color2, a1 )\n\t\t\t\t// \"/\" grid diagonal: hidden if perpendicular \"\\\" game line crosses this cell\n\t\t\t\tconst a2 = ( isHidden( [cx + 1, cz] ) || isHidden( [cx, cz + 1] ) || cellDiagBackslash.has( cellKey ) ) ? 0 : 1\n\t\t\t\tpushVertex( [cx + 1, cz], color2, a2 )\n\t\t\t\tpushVertex( [cx, cz + 1], color2, a2 )\n\t\t\t}\n\t\t}\n\n\t\tthis.geometry.setAttribute( 'position', new Float32BufferAttribute( positions, 3 ) )\n\t\tthis.geometry.setAttribute( 'color', new Float32BufferAttribute( colors, 4 ) )\n\t}\n\n\tdispose() {\n\t\tthis.geometry.dispose()\n\t\tthis.material.dispose()\n\t}\n\n}\n\n\nexport { Grid }\n"]}