import"mocha";import"chai";import{IoNode as e,RegisterIoNode as t,ProtoChain as o,Binding as p,RegisterIoElement as n,IoElement as a}from"./iogui.js";var __decorate$2=function(e,t,o,p){var n,a=arguments.length,r=a<3?t:null===p?p=Object.getOwnPropertyDescriptor(t,o):p;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(e,t,o,p);else for(var c=e.length-1;c>=0;c--)(n=e[c])&&(r=(a<3?n(r):a>3?n(t,o,r):n(t,o))||r);return a>3&&r&&Object.defineProperty(t,o,r),r};class Node{run(){describe("IoNode",(()=>{describe("Registration",(()=>{it("Should have core API functions defined",(()=>{const t=new e;chai.expect(t.setProperty).to.be.a("function"),chai.expect(t.applyProperties).to.be.a("function"),chai.expect(t.setProperties).to.be.a("function"),chai.expect(t.setValue).to.be.a("function"),chai.expect(t.changed).to.be.a("function"),chai.expect(t.queue).to.be.a("function"),chai.expect(t.dispatchQueue).to.be.a("function"),chai.expect(t.dispatchQueueSync).to.be.a("function"),chai.expect(t.throttle).to.be.a("function"),chai.expect(t.onObjectMutated).to.be.a("function"),chai.expect(t.objectMutated).to.be.a("function"),chai.expect(t.bind).to.be.a("function"),chai.expect(t.unbind).to.be.a("function"),chai.expect(t.addEventListener).to.be.a("function"),chai.expect(t.removeEventListener).to.be.a("function"),chai.expect(t.dispatchEvent).to.be.a("function"),chai.expect(t.dispose).to.be.a("function"),t.dispose()})),it("Should register property definitions correctly",(()=>{let o=class TestNode extends e{static get Properties(){return{prop0:{type:String},prop1:{value:!1},prop2:-1,prop3:Number,prop4:Object,prop5:[0,1,2]}}};o=__decorate$2([t],o);const p=new o;chai.expect(p.prop0).to.be.equal(""),chai.expect(p.prop1).to.be.equal(!1),chai.expect(p.prop2).to.be.equal(-1),chai.expect(p.prop3).to.be.equal(0),chai.expect(p.prop4).to.be.deep.equal({}),chai.expect(p.prop5).to.be.deep.equal([0,1,2]),p.dispose()})),it("Should aggregate property definitions from protochain",(()=>{let o=class Object1 extends e{static get Properties(){return{prop1:{value:0},prop2:null}}};o=__decorate$2([t],o);let p=class Object2 extends o{static get Properties(){return{prop1:{value:{},notify:!1,observe:!0},prop2:{notify:!0},prop3:""}}};p=__decorate$2([t],p);const n=new o,a=new p,r=n._protochain.properties,c=a._protochain.properties,i=n._properties,l=a._properties;chai.expect(Object.keys(i)).to.be.eql(["lazy","prop1","prop2"]),chai.expect(Object.keys(l)).to.be.eql(["lazy","prop1","prop2","prop3"]),chai.expect(r.prop1.value).to.be.equal(0),chai.expect(i.prop1.value).to.be.equal(0),chai.expect(i.prop1.type).to.be.equal(Number),chai.expect(i.prop1.notify).to.be.equal(!0),chai.expect(i.prop1.reflect).to.be.equal(0),chai.expect(i.prop1.observe).to.be.equal(!1),chai.expect(c.prop1.value).to.be.eql({}),chai.expect(l.prop1.value).to.be.eql({}),chai.expect(l.prop1.type).to.be.equal(Object),chai.expect(l.prop1.notify).to.be.equal(!1),chai.expect(l.prop1.reflect).to.be.equal(0),chai.expect(l.prop1.observe).to.be.equal(!0),chai.expect(l.prop2.value).to.be.equal(null),chai.expect(l.prop2.type).to.be.equal(void 0),chai.expect(l.prop2.notify).to.be.equal(!0),chai.expect(l.prop2.observe).to.be.equal(!1)})),it("Should favor explicit property definitions over implicit",(()=>{const e=new o(class Object2 extends class Object1{static get Properties(){return{prop1:{value:{},notify:!1,reflect:2,observe:!0}}}}{static get Properties(){return{prop1:[1,2,3]}}}).properties;chai.expect(e.prop1.value).to.be.eql([1,2,3]),chai.expect(e.prop1.type).to.be.equal(Array),chai.expect(e.prop1.notify).to.be.equal(!1),chai.expect(e.prop1.reflect).to.be.equal(2),chai.expect(e.prop1.observe).to.be.equal(!0)})),it("Should correctly register properties with bindigs",(()=>{let o=class TestNode extends e{static get Properties(){return{label:""}}};o=__decorate$2([t],o);const n=new p(new o({label:"binding1"}),"label"),a=new p(new o({label:"binding2"}),"label"),r=new p(new o({label:"binding3"}),"label");let c=class Object1 extends e{static get Properties(){return{prop1:n}}};c=__decorate$2([t],c);let i=class Object2 extends c{static get Properties(){return{prop1:{binding:a},prop3:r}}};i=__decorate$2([t],i);const l=new c,s=new i,h=l._properties,u=s._properties;chai.expect(h.prop1.binding).to.be.equal(n),chai.expect(u.prop1.binding).to.be.equal(a),chai.expect(u.prop3.binding).to.be.equal(r),chai.expect(n.targets[0]).to.be.equal(l),chai.expect(a.targets[0]).to.be.equal(s),chai.expect(r.targets[0]).to.be.equal(s),chai.expect(h.prop1.value).to.be.equal("binding1"),chai.expect(u.prop1.value).to.be.equal("binding2"),chai.expect(u.prop3.value).to.be.equal("binding3")}))})),describe("Construction",(()=>{})),describe("Properties",(()=>{it("Should correctly get/set properties",(()=>{let o=class TestNode extends e{static get Properties(){return{prop1:{value:1}}}};o=__decorate$2([t],o);const p=new o,n=p._properties;chai.expect(n.prop1.value).to.be.equal(1),chai.expect(p.prop1).to.be.equal(1),p.setProperty("prop1",0),chai.expect(n.prop1.value).to.be.equal(0),chai.expect(p.prop1).to.be.equal(0)})),it("Should correctly get/set bound properties",(()=>{let o=class TestNode extends e{static get Properties(){return{label:""}}};o=__decorate$2([t],o);const n=new p(new o({label:"binding1"}),"label"),a=new p(new o({label:"binding2"}),"label");let r=class TestNode2 extends e{static get Properties(){return{prop1:n}}};r=__decorate$2([t],r);const c=new r,i=c._properties;chai.expect(i.prop1.value).to.be.equal("binding1"),chai.expect(c.prop1).to.be.equal("binding1"),chai.expect(i.prop1.binding).to.be.equal(n),chai.expect(n.targets[0]).to.be.equal(c),c.setProperty("prop1",a),chai.expect(i.prop1.value).to.be.equal("binding2"),chai.expect(c.prop1).to.be.equal("binding2"),chai.expect(n.targets[0]).to.be.equal(void 0),chai.expect(a.targets[0]).to.be.equal(c)})),it("Should execute attribute reflection on IoElement",(()=>{let e=class TestElementReflection extends a{static get Properties(){return{label:{value:"label1",reflect:1}}}};e=__decorate$2([n],e);const t=new e;chai.expect(t.getAttribute("label")).to.be.equal("label1"),t.label="label2",chai.expect(t.getAttribute("label")).to.be.equal("label2"),t.setProperty("label","label3"),chai.expect(t.getAttribute("label")).to.be.equal("label3")})),it("Should dipatch queue on object value initialization and value set",(()=>{let o=class TestNode extends e{static get Properties(){return{prop:Object}}};o=__decorate$2([t],o);const p=new o;p.addEventListener("prop-changed",(e=>{const t=e.detail.value,o=e.detail.oldValue;chai.expect(t).to.be.eql({}),chai.expect(o).to.be.equal(void 0)})),p.removeEventListener("prop-changed"),p.addEventListener("prop-changed",(e=>{const t=e.detail.value,o=e.detail.oldValue;chai.expect(t).to.be.eql({}),chai.expect(o).to.be.eql({})})),p.prop={},p.removeEventListener("prop-changed"),p.addEventListener("prop-changed",(()=>{chai.expect("This should never happen!").to.be.equal(!0)})),p.setProperty("prop",{},!0)})),it("Should connect/disconnect IoNode-property-values on construction and value set",(()=>{let o=class TestNodeValue extends e{static get Properties(){return{prop:Object,propChangeCounter:0}}propChanged(){this.propChangeCounter++}};o=__decorate$2([t],o);let p=class TestNode extends e{static get Properties(){return{prop:o}}};p=__decorate$2([t],p);const n=new p,a=n.prop;chai.expect(a.propChangeCounter).to.be.equal(1),a.prop={},a.prop={},chai.expect(a.propChangeCounter).to.be.equal(3),a.prop={},chai.expect(a.propChangeCounter).to.be.equal(4),n.prop=new o;const r=n.prop;a.prop={},chai.expect(a.propChangeCounter).to.be.equal(5),chai.expect(r.propChangeCounter).to.be.equal(1)}))})),describe("Reactivity",(()=>{it("Should corectly invoke handler functions on change",(()=>{let o=class TestNode extends e{_changedCounter=0;_prop1ChangedCounter=0;_prop1Change=null;_prop2ChangedCounter=0;_prop2Change=null;static get Properties(){return{prop1:String,prop2:String}}changed(){this._changedCounter++}prop1Changed(e){this._prop1ChangedCounter++,this._prop1Change=e}prop2Changed(e){this._prop2ChangedCounter++,this._prop2Change=e}};o=__decorate$2([t],o);const p=new o;chai.expect(p._changedCounter).to.equal(0),chai.expect(p._prop1ChangedCounter).to.equal(0),chai.expect(p._prop2ChangedCounter).to.equal(0),chai.expect(p._prop1Change?.property).to.equal(void 0),chai.expect(p._prop1Change?.oldValue).to.equal(void 0),chai.expect(p._prop1Change?.value).to.equal(void 0),chai.expect(p._prop2ChangedCounter).to.equal(0),chai.expect(p._prop2Change?.property).to.equal(void 0),chai.expect(p._prop2Change?.oldValue).to.equal(void 0),chai.expect(p._prop2Change?.value).to.equal(void 0),p.prop1="one",chai.expect(p._changedCounter).to.equal(1),chai.expect(p._prop1ChangedCounter).to.equal(1),chai.expect(p._prop2ChangedCounter).to.equal(0),chai.expect(p._prop1Change?.property).to.equal("prop1"),chai.expect(p._prop1Change?.oldValue).to.equal(""),chai.expect(p._prop1Change?.value).to.equal("one"),p.prop1="two",p.prop2="test",chai.expect(p._changedCounter).to.equal(3),chai.expect(p._prop1ChangedCounter).to.equal(2),chai.expect(p._prop1Change?.property).to.equal("prop1"),chai.expect(p._prop1Change?.oldValue).to.equal("one"),chai.expect(p._prop1Change?.value).to.equal("two"),chai.expect(p._prop2ChangedCounter).to.equal(1),chai.expect(p._prop2Change?.property).to.equal("prop2"),chai.expect(p._prop2Change?.oldValue).to.equal(""),chai.expect(p._prop2Change?.value).to.equal("test"),p.setProperties({prop1:"three",prop2:""}),chai.expect(p._changedCounter).to.equal(4),chai.expect(p._prop1ChangedCounter).to.equal(3),chai.expect(p._prop1Change?.property).to.equal("prop1"),chai.expect(p._prop1Change?.oldValue).to.equal("two"),chai.expect(p._prop1Change?.value).to.equal("three"),chai.expect(p._prop2ChangedCounter).to.equal(2),chai.expect(p._prop2Change?.property).to.equal("prop2"),chai.expect(p._prop2Change?.oldValue).to.equal("test"),chai.expect(p._prop2Change?.value).to.equal(""),p.dispose()})),it("should invoke property mutation handler functions on mutation event",(async()=>{let o=class TestNode extends e{_changedCounter=0;_obj1MutatedCounter=0;_obj2MutatedCounter=0;static get Properties(){return{obj1:{type:Object,observe:!0},obj2:{type:Object,observe:!0}}}changed(){this._changedCounter++}obj1Mutated(){this._obj1MutatedCounter++}obj2Mutated(){this._obj2MutatedCounter++}};o=__decorate$2([t],o);const p=new o;chai.expect(p._changedCounter).to.equal(0),chai.expect(p._obj1MutatedCounter).to.equal(0),p.dispatchEvent("object-mutated",{object:p.obj1},!1,window),await nextTick(),chai.expect(p._changedCounter).to.equal(1),chai.expect(p._obj1MutatedCounter).to.equal(1),chai.expect(p._obj2MutatedCounter).to.equal(0),p.dispatchEvent("object-mutated",{object:p.obj2},!1,window),await nextTick(),p.dispose()})),it("should fire change events when connected",(()=>{let o=class TestNode extends e{static get Properties(){return{prop1:String,_onProp1ChangedCounter:0,_onProp1Change:null,_onCustomEventCounter:0,_onCustomEven:null}}static get Listeners(){return{"prop1-changed":"onProp1Changed","custom-event":"onCustomEvent"}}onProp1Changed(e){this._onProp1ChangedCounter++,this._onProp1Change=e}onCustomEvent(e){this._onCustomEventCounter++,this._onCustomEven=e}};o=__decorate$2([t],o);const p=new o;p.prop1="one",chai.expect(p._onProp1ChangedCounter).to.equal(1),chai.expect(p._onProp1Change.detail.property).to.equal("prop1"),chai.expect(p._onProp1Change.detail.oldValue).to.equal(""),chai.expect(p._onProp1Change.detail.value).to.equal("one"),p.dispatchEvent("custom-event",{value:"hello"}),chai.expect(p._onCustomEventCounter).to.equal(1),chai.expect(p._onCustomEven.path[0]).to.equal(p),chai.expect(p._onCustomEven.detail.value).to.equal("hello")}))})),describe("Binding",(()=>{it("should correctly bind properties",(()=>{let o=class TestNode extends e{static get Properties(){return{prop1:String,prop2:String}}};o=__decorate$2([t],o);const n=new o,a=n.bind("prop1");chai.expect(a).to.be.instanceof(p),chai.expect(a.node).to.be.equal(n),chai.expect(a.property).to.be.equal("prop1");const r=new o({prop1:a}),c=new o({prop1:a});c.prop2=a,chai.expect(a.targets[0]).to.be.equal(r),chai.expect(a.targets[1]).to.be.equal(c),chai.expect(a.targetProperties.get(r)[0]).to.be.equal("prop1"),chai.expect(a.targetProperties.get(r)[1]).to.be.equal(void 0),chai.expect(a.targetProperties.get(c)[0]).to.be.equal("prop1"),chai.expect(a.targetProperties.get(c)[1]).to.be.equal("prop2"),n.prop1="one",chai.expect(r.prop1).to.be.equal("one"),chai.expect(r.prop2).to.be.equal(""),chai.expect(c.prop1).to.be.equal("one"),chai.expect(c.prop2).to.be.equal("one"),r.prop1="two",chai.expect(n.prop1).to.be.equal("two"),chai.expect(c.prop1).to.be.equal("two"),chai.expect(a.targets.length).to.be.equal(2),r.dispose(),chai.expect(a.targets.length).to.be.equal(1),c.dispose(),chai.expect(a.targets.length).to.be.equal(0),n.dispose()})),it("Should add/remove targets and targetProperties when assigned to values",(()=>{let o=class TestNode extends e{static get Properties(){return{prop1:String,prop2:String}}};o=__decorate$2([t],o);const n=new o,a=new p(n,"prop1"),r=new p(n,"prop2"),c=new o;c.prop1=a,c.prop2=r;const i=new o({prop1:a}),l=new o({prop1:a,prop2:a});chai.expect(a.targets[0]).to.be.equal(c),chai.expect(a.targets[1]).to.be.equal(i),chai.expect(a.targets[2]).to.be.equal(l),chai.expect(a.targetProperties.get(c)).to.be.eql(["prop1"]),chai.expect(a.targetProperties.get(i)).to.be.eql(["prop1"]),chai.expect(a.targetProperties.get(l)).to.be.eql(["prop1","prop2"]),c.dispose(),i.unbind("prop1"),l.unbind("prop1"),chai.expect(a.targetProperties.get(c)).to.be.eql([]),chai.expect(a.targetProperties.get(i)).to.be.eql([]),chai.expect(a.targetProperties.get(l)).to.be.eql(["prop2"]),i.prop2=a,i.prop1=a,l.prop1=a,chai.expect(a.targetProperties.get(i)).to.be.eql(["prop2","prop1"]),chai.expect(a.targetProperties.get(l)).to.be.eql(["prop2","prop1"])})),it('Should return existing binding or create a new on "bind()"',(()=>{let o=class TestNode extends e{static get Properties(){return{prop1:String,prop2:String}}};o=__decorate$2([t],o);const p=new o,n=p.bind("prop1");chai.expect(n).to.be.equal(p._bindings.prop1),chai.expect(n).to.be.equal(p.bind("prop1"))})),it("Should dispose bindings correctly",(()=>{let o=class TestNode extends e{static get Properties(){return{prop1:String,prop2:String}}};o=__decorate$2([t],o);const p=new o,n=p.bind("prop1");p.unbind("prop1"),chai.expect(p._bindings.prop1).to.be.equal(void 0),chai.expect(n.prop1).to.be.equal(void 0);const a=new o,r=a.bind("prop1");a.dispose(),chai.expect(a._bindings).to.be.eql({}),chai.expect(r.prop1).to.be.equal(void 0)}))}))}))}}var __decorate$1=function(e,t,o,p){var n,a=arguments.length,r=a<3?t:null===p?p=Object.getOwnPropertyDescriptor(t,o):p;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(e,t,o,p);else for(var c=e.length-1;c>=0;c--)(n=e[c])&&(r=(a<3?n(r):a>3?n(t,o,r):n(t,o))||r);return a>3&&r&&Object.defineProperty(t,o,r),r};let r=class TestNode extends e{static get Properties(){return{prop0:String,prop2:1/0}}};r=__decorate$1([t],r);let c=class TestElement extends a{static get Properties(){return{prop0:-1,prop1:{value:"default"},_changedCounter:0,_prop1ChangedCounter:0,_prop1AltCounter:0,_prop1ChangeEvent:null,debug:!0}}static get Listeners(){return{"prop0-changed":"onProp1Change","custom-event":"onCustomEvent"}}reset(){this.prop0=-1,this.prop1="default",this._changedCounter=0,this._prop1ChangedCounter=0,this._prop1AltCounter=0,this._prop1Counter=0,this._customHandlerCounter=0,this._prop1AltChangeEvent=null,this._prop1ChangeEvent=null,this._customHandlerChangeEvent=null}constructor(e){super(e),this.template([["test-subelement",{id:"subelement",prop0:this.bind("prop0")}]]),this.subnode=new r({prop2:this.bind("prop0")})}changed(){this._changedCounter++}prop1Changed(e){this._prop1ChangedCounter++,this._prop1ChangedChange=e}onProp1ChangeAlt(e){this._prop1AltCounter++,this._prop1AltChangeEvent=e}onProp1Change(e){this._prop1Counter++,this._prop1ChangeEvent=e}onCustomEvent(e){this._customHandlerCounter++,this._customHandlerChangeEvent=e}};c=__decorate$1([n],c);let i=class TestSubelement extends a{static get Properties(){return{prop0:0}}};i=__decorate$1([n],i);class Element{_changedCounter;element;constructor(){this._changedCounter=0,this.element=new c({"on-prop0-changed":this.changed.bind(this),"on-prop1-changed":"onProp1ChangeAlt",debug:!0}),document.body.appendChild(this.element)}changed(e){e.target===this.element&&this._changedCounter++}reset(){this.element.reset(),this._changedCounter=0}run(){describe("IoElement",(()=>{describe("Registration",(()=>{it("Should have core API functions defined",(()=>{chai.expect(this.element.id).to.be.equal(""),chai.expect(this.element.tabindex).to.be.equal(""),chai.expect(this.element.contenteditable).to.be.equal(!1),chai.expect(this.element.title).to.be.equal(""),chai.expect(this.element.$).to.be.a("object"),chai.expect(this.element.template).to.be.a("function"),chai.expect(this.element.traverse).to.be.a("function")})),it("Should initialize property definitions correctly",(()=>{chai.expect(this.element.prop0).to.equal(-1),chai.expect(this.element.prop1).to.equal("default")}))})),describe("Construction",(()=>{})),describe("Reactivity",(()=>{it("Should corectly invoke handler functions on change",(()=>{this.reset(),this.element.prop0=1,this.element.prop1="test",chai.expect(this.element._prop1AltCounter).to.equal(1),chai.expect(this.element._changedCounter).to.equal(2),chai.expect(this._changedCounter).to.equal(1)})),it("Should dispatch correct event payloads to handlers",(()=>{this.reset(),this.element.prop0=1,this.element.prop0=0,chai.expect(this.element._prop1ChangeEvent.srcElement).to.equal(this.element),chai.expect(this.element._prop1ChangeEvent.detail.value).to.equal(0),this.element.$.subelement.prop0=2,chai.expect(this.element._prop1ChangeEvent.detail.oldValue).to.equal(0),chai.expect(this.element._prop1ChangeEvent.detail.value).to.equal(2),this.element.dispatchEvent("custom-event",{data:"io"}),chai.expect(this.element._customHandlerChangeEvent.detail.data).to.equal("io")}))})),describe("Binding",(()=>{it("Should update bound values correctly",(()=>{this.element.prop0=1/0,chai.expect(this.element.$.subelement.prop0).to.equal(1/0),this.element.$.subelement.prop0=0,chai.expect(this.element.prop0).to.equal(0)})),it("Should bind to Node node",(()=>{this.element.prop0=1/0,chai.expect(this.element.subnode.prop2).to.equal(1/0),this.element.subnode.prop2=0,chai.expect(this.element.prop0).to.equal(0)})),it("Should disconnect binding when Node node is disconnected",(()=>{this.element.prop0=1/0,chai.expect(this.element.subnode.prop2).to.equal(1/0),this.element.subnode.prop2=2,chai.expect(this.element.prop0).to.equal(2)}))}))}))}}var __decorate=function(e,t,o,p){var n,a=arguments.length,r=a<3?t:null===p?p=Object.getOwnPropertyDescriptor(t,o):p;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(e,t,o,p);else for(var c=e.length-1;c>=0;c--)(n=e[c])&&(r=(a<3?n(r):a>3?n(t,o,r):n(t,o))||r);return a>3&&r&&Object.defineProperty(t,o,r),r};mocha.setup("bdd");const l=document.createElement("div");l.setAttribute("id","mocha"),document.body.appendChild(l),l.style.display="none";let s=!1;async function nextTick(){return new Promise((e=>{setTimeout((()=>{e()}))}))}let h=class IoTest extends a{static get Style(){return"\n      :host #mocha {\n        margin: 0;\n        position: relative;\n      }\n      :host #mocha-report {\n        margin: 2em 1em;\n      }\n      :host #mocha-stats {\n        position: absolute;\n        top: -2em;\n        right: 2em;\n        font-size: 12px;\n        margin: 0;\n      }\n      :host #mocha-stats em {\n        color: var(--io-color);\n      }\n      :host #mocha-stats li {\n        padding: 0;\n      }\n      :host #mocha-stats .progress {\n        display: none;\n      }\n      :host #mocha-stats .passes {\n        color: #0c0;\n      }\n      :host #mocha-stats .failures {\n        color: #f00;\n        font-weight: bold;\n      }\n      :host h2 {\n        padding-right: 2em;\n      }\n      :host .replay {\n        display: none !important;\n      }\n    "}connectedCallback(){super.connectedCallback(),this.appendChild(l),l.style.display="block",function runTests(){s||((new Node).run(),(new Element).run(),mocha.checkLeaks(),mocha.run(),s=!0)}(),setTimeout((()=>{this.parentElement.scrollTop=this.parentElement.scrollHeight}),100)}disconnectedCallback(){super.disconnectedCallback(),document.body.appendChild(l),l.style.display="none"}};h=__decorate([n],h);export{h as IoTest,nextTick};
