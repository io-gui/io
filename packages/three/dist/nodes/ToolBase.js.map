{"version":3,"file":"ToolBase.js","sourceRoot":"","sources":["../../src/nodes/ToolBase.ts"],"names":[],"mappings":"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","sourcesContent":["import { ReactiveNode, ReactiveNodeProps, Register } from '@io-gui/core'\nimport { IoThreeViewport } from '../elements/IoThreeViewport'\nimport { Vector2, Ray, Raycaster } from 'three/webgpu'\n\nexport type ToolBaseProps = ReactiveNodeProps & {\n\n}\n\nexport interface Pointer3D {\n  event: PointerEvent\n  screen: Vector2\n  screenStart: Vector2\n  screenMovement: Vector2\n  ray: Ray\n  rayStart: Ray\n  rayMovement: Ray\n}\n\nconst _raycaster = new Raycaster()\n\n@Register\nexport class ToolBase extends ReactiveNode {\n\n  private readonly viewports: IoThreeViewport[] = []\n\n  constructor(args: ToolBaseProps) {\n    super(args)\n  }\n\n  registerViewport(viewport: IoThreeViewport) {\n    this.viewports.push(viewport)\n    viewport.addEventListener('pointerdown', this._onPointerDown)\n    viewport.addEventListener('pointermove', this._onPointerMove)\n    viewport.addEventListener('pointerup', this._onPointerUp)\n    viewport.addEventListener('pointercancel', this._onPointerCancel)\n  }\n\n  unregisterViewport(viewport: IoThreeViewport) {\n    this.viewports.splice(this.viewports.indexOf(viewport), 1)\n    viewport.removeEventListener('pointerdown', this._onPointerDown)\n    viewport.removeEventListener('pointermove', this._onPointerMove)\n    viewport.removeEventListener('pointerup', this._onPointerUp)\n    viewport.removeEventListener('pointercancel', this._onPointerCancel)\n  }\n\n  private _activePointers: Record<number, Pointer3D> = {}\n\n  _onPointerDown(event: PointerEvent) {\n    event.stopPropagation()\n    event.preventDefault()\n    const viewport = event.target as IoThreeViewport\n    viewport.setPointerCapture(event.pointerId)\n    const pointer3D = this.pointerTo3D(event)\n    this._activePointers[event.pointerId] = pointer3D\n    this.on3DPointerDown(Object.values(this._activePointers))\n  }\n  _onPointerMove(event: PointerEvent) {\n    event.stopPropagation()\n    event.preventDefault()\n    if (!this._activePointers[event.pointerId]) return\n    const pointer3D = this.pointerTo3D(event)\n    this._activePointers[event.pointerId] = pointer3D\n    this.on3DPointerMove(Object.values(this._activePointers))\n  }\n  _onPointerUp(event: PointerEvent) {\n    event.stopPropagation()\n    event.preventDefault()\n    const viewport = event.target as IoThreeViewport\n    viewport.releasePointerCapture(event.pointerId)\n    if (!this._activePointers[event.pointerId]) return\n    delete this._activePointers[event.pointerId]\n    this.on3DPointerUp(Object.values(this._activePointers))\n  }\n  _onPointerCancel(event: PointerEvent) {\n    event.stopPropagation()\n    event.preventDefault()\n    const viewport = event.target as IoThreeViewport\n    viewport.releasePointerCapture(event.pointerId)\n    if (!this._activePointers[event.pointerId]) return\n    delete this._activePointers[event.pointerId]\n    this.on3DPointerCancel(Object.values(this._activePointers))\n  }\n\n  on3DPointerDown(pointers: Pointer3D[]) {\n    console.log('on3DPointerDown', pointers)\n  }\n  on3DPointerMove(pointers: Pointer3D[]) {\n    console.log('on3DPointerMove', pointers)\n  }\n  on3DPointerUp(pointers: Pointer3D[]) {\n    console.log('on3DPointerUp', pointers)\n  }\n  on3DPointerCancel(pointers: Pointer3D[]) {\n    console.log('on3DPointerCancel', pointers)\n  }\n\n  pointerTo3D(event: PointerEvent): Pointer3D {\n\n    const _viewport = event.target as IoThreeViewport\n    const _rect = _viewport.getBoundingClientRect()\n    const screen = new Vector2(\n      ((event.clientX - _rect.left) / _rect.width) * 2 - 1,\n      -((event.clientY - _rect.top) / _rect.height) * 2 + 1,\n    )\n\n    _viewport.viewCameras.setOverscan(_viewport.width, _viewport.height, _viewport.overscan)\n    const camera = _viewport.viewCameras.camera\n    _raycaster.setFromCamera(screen, camera)\n    _viewport.viewCameras.resetOverscan()\n    const { origin, direction } = _raycaster.ray\n\n    const previousPointer3D = this._activePointers[event.pointerId]\n\n    if (previousPointer3D) {\n\n      return {\n        event,\n        screen,\n        screenStart: previousPointer3D.screenStart.clone(),\n        screenMovement: screen.clone().sub(previousPointer3D.screen),\n        ray: new Ray(\n          origin.clone(),\n          direction.clone(),\n        ),\n        rayStart: new Ray(\n          previousPointer3D.rayStart.origin.clone(),\n          previousPointer3D.rayStart.direction.clone(),\n        ),\n        rayMovement: new Ray(\n          origin.clone().sub(previousPointer3D.ray.origin),\n          direction.clone().sub(previousPointer3D.ray.direction),\n        ),\n      }\n\n    } else {\n\n      return {\n        event,\n        screen,\n        screenStart: screen.clone(),\n        screenMovement: new Vector2(0, 0),\n        ray: new Ray(\n          origin.clone(),\n          direction.clone(),\n        ),\n        rayStart: new Ray(\n          origin.clone(),\n          direction.clone(),\n        ),\n        rayMovement: new Ray(\n          origin.clone(),\n          direction.clone(),\n        ),\n      }\n\n    }\n\n  }\n}"]}