import{ReactiveProperty,IoElement,Register,Node,Property}from"@io-gui/core";import{ioButton}from"@io-gui/inputs";import{ioPropertyEditor,registerEditorConfig,registerEditorGroups}from"@io-gui/editors";import{Scene,NoToneMapping,LinearToneMapping,ReinhardToneMapping,CineonToneMapping,ACESFilmicToneMapping,AgXToneMapping,NeutralToneMapping,Box3,Sphere,Vector3,Camera,PerspectiveCamera,OrthographicCamera,WebGPURenderer,Clock,CanvasTarget}from"three/webgpu";import WebGPU from"three/addons/capabilities/WebGPU.js";import{ioNumberSlider}from"@io-gui/sliders";import{ioOptionSelect,MenuOption}from"@io-gui/menus";import{OrbitControls}from"three/addons/controls/OrbitControls.js";var __defProp$3=Object.defineProperty,__getOwnPropDesc$3=Object.getOwnPropertyDescriptor,__decorateClass$3=(decorators,target,key,kind)=>{for(var decorator,result=kind>1?void 0:kind?__getOwnPropDesc$3(target,key):target,i=decorators.length-1;i>=0;i--)(decorator=decorators[i])&&(result=(kind?decorator(target,key,result):decorator(result))||result);return kind&&result&&__defProp$3(target,key,result),result};let IoBuildGeometry=class extends IoElement{static get Style(){return"\n      :host {\n        display: flex;\n        flex-direction: column;\n      }\n    "}constructor(args={}){super(args)}buildGeometry(){const geometry=this.value;if(!geometry)return;const parameters=geometry.parameters;if(!parameters)return void console.warn("IoBuildGeometry: geometry has no parameters property");const newGeometry=new(0,geometry.constructor)(...Object.values(parameters));geometry.copy(newGeometry),newGeometry.dispose(),geometry.computeVertexNormals(),geometry.computeTangents(),geometry.computeBoundingSphere(),geometry.computeBoundingBox(),this.dispatchMutation(geometry),this.dispatchMutation(geometry.boundingBox),this.dispatchMutation(geometry.boundingSphere)}changed(){const hasParameters=this.value&&this.value.parameters;this.render([ioPropertyEditor({value:this.value,properties:["parameters"],labeled:!1}),ioButton({label:"Build Geometry",action:()=>this.buildGeometry(),disabled:!hasParameters}),ioButton({label:"Compute Vertex Normals",action:()=>{this.value?.computeVertexNormals()}}),ioButton({label:"Compute Tangents",action:()=>{this.value?.computeTangents()}}),ioButton({label:"Compute Bounding Sphere",action:()=>{this.value?.computeBoundingSphere(),this.dispatchMutation(this.value.boundingSphere),this.dispatchMutation(this.value.boundingSphere.center)}}),ioButton({label:"Compute Bounding Box",action:()=>{this.value?.computeBoundingBox(),this.dispatchMutation(this.value.boundingBox.max),this.dispatchMutation(this.value.boundingBox.min)}})])}};__decorateClass$3([ReactiveProperty({type:Object,init:null})],IoBuildGeometry.prototype,"value",2),IoBuildGeometry=__decorateClass$3([Register],IoBuildGeometry);const ioBuildGeometry=function(arg0){return IoBuildGeometry.vConstructor(arg0)};var __defProp$2=Object.defineProperty,__getOwnPropDesc$2=Object.getOwnPropertyDescriptor,__decorateClass$2=(decorators,target,key,kind)=>{for(var decorator,result=kind>1?void 0:kind?__getOwnPropDesc$2(target,key):target,i=decorators.length-1;i>=0;i--)(decorator=decorators[i])&&(result=(kind?decorator(target,key,result):decorator(result))||result);return kind&&result&&__defProp$2(target,key,result),result};let ThreeApplet=class extends Node{_renderer=null;_width=0;_height=0;_prevTime=-1;constructor(args){super(args)}updateViewportSize(width,height){this._width===width&&this._height===height||width&&height&&(this._width=width,this._height=height,this.onResized(width,height))}isRendererInitialized(){return!!this._renderer&&!0===this._renderer.initialized}onRendererInitialized(renderer){this._renderer=renderer}onResized(width,height){}animate(time,delta){this._prevTime!==time&&(this._prevTime=time,this.onAnimate(delta))}onAnimate(delta){}};__decorateClass$2([ReactiveProperty({type:Scene,init:null})],ThreeApplet.prototype,"scene",2),__decorateClass$2([ReactiveProperty({type:Number,value:1})],ThreeApplet.prototype,"toneMappingExposure",2),__decorateClass$2([ReactiveProperty({type:Number,value:NoToneMapping})],ThreeApplet.prototype,"toneMapping",2),__decorateClass$2([ReactiveProperty({type:Array,init:null})],ThreeApplet.prototype,"uiConfig",2),__decorateClass$2([ReactiveProperty({type:Object,init:null})],ThreeApplet.prototype,"uiGroups",2),ThreeApplet=__decorateClass$2([Register],ThreeApplet),registerEditorConfig(ThreeApplet,[["toneMappingExposure",ioNumberSlider({min:0,max:3,step:.01,exponent:2})],["toneMapping",ioOptionSelect({option:new MenuOption({options:[{value:NoToneMapping,id:"NoToneMapping"},{value:LinearToneMapping,id:"LinearToneMapping"},{value:ReinhardToneMapping,id:"ReinhardToneMapping"},{value:CineonToneMapping,id:"CineonToneMapping"},{value:ACESFilmicToneMapping,id:"ACESFilmicToneMapping"},{value:AgXToneMapping,id:"AgXToneMapping"},{value:NeutralToneMapping,id:"NeutralToneMapping"}]})})],["scene",ioPropertyEditor({properties:["children"],label:"_hidden_"})]]),registerEditorGroups(ThreeApplet,{Main:["scene"],Hidden:["toneMapping","toneMappingExposure","uiConfig","uiGroups","_renderer","_width","_height","_prevTime"]});var __defProp$1=Object.defineProperty,__getOwnPropDesc$1=Object.getOwnPropertyDescriptor,__decorateClass$1=(decorators,target,key,kind)=>{for(var decorator,result=kind>1?void 0:kind?__getOwnPropDesc$1(target,key):target,i=decorators.length-1;i>=0;i--)(decorator=decorators[i])&&(result=(kind?decorator(target,key,result):decorator(result))||result);return kind&&result&&__defProp$1(target,key,result),result};const box=new Box3,sphere=new Sphere,center=new Vector3,size=new Vector3,delta=new Vector3,cameraRight=new Vector3,cameraUp=new Vector3,cameraForward=new Vector3,corner=new Vector3;let radius=0;const resetCameras=/* @__PURE__ */new WeakMap;let ViewCameras=class extends Node{static get Listeners(){return{"frame-object":"onFrameObject"}}constructor(args){super(args),this.orbitControls.connect(this.viewport),this.orbitControls.addEventListener("change",()=>{this.applet.dispatchMutation()}),void 0===this.camera&&(this.camera=this.defaultCameras.perspective)}cameraSelectChanged(){this.debounce(this.cameraSelectChangedDebounced)}cameraSelectChangedDebounced(){let matchedCamera;if(this.cameraSelect.startsWith("scene")){const cameraId=this.cameraSelect.split(":")[1]||"",cameras=[...this.applet.scene.getObjectsByProperty("isPerspectiveCamera",!0),...this.applet.scene.getObjectsByProperty("isOrthographicCamera",!0)];cameraId?(matchedCamera=cameras.find(camera=>camera.name===cameraId),matchedCamera||console.warn(`Camera ${cameraId} not found in the scene, using default perspective camera`)):(matchedCamera=cameras[0],matchedCamera||console.warn("No cameras found in the scene, using default perspective camera")),this.camera=matchedCamera||this.defaultCameras.perspective}else matchedCamera=this.defaultCameras.getCamera(this.cameraSelect),matchedCamera?this.camera=matchedCamera:(console.warn(`Camera ${this.cameraSelect} not found in the default cameras, using default perspective camera`),this.camera=this.defaultCameras.perspective)}cameraChanged(){this.defaultCameras.cameras.includes(this.camera)?(this.orbitControls.enabled=!0,this.orbitControls.object=this.camera,this.orbitControls.enableRotate=!!this.camera.isPerspectiveCamera):this.orbitControls.enabled=!1}appletChanged(){this.frameObjectAll(this.applet.scene)}onFrameObject(event){this.frameObjectAll(event.detail.object,event.detail.overscan)}frameObjectAll(object,overscan=1){if(void 0!==object){for(const camera of this.defaultCameras.cameras)camera.position.copy(camera.userData.position),camera.lookAt(0,0,0),this.frameObject(object,camera,overscan);this.debounce(this.cameraSelectChangedDebounced)}else console.error("frameObject: object is undefined")}frameObject(object,camera,overscan=1){box.setFromObject(object),!1===box.isEmpty()?(box.getCenter(center),radius=box.getBoundingSphere(sphere).radius):(center.setFromMatrixPosition(camera.matrixWorld),radius=.1),cameraRight.set(1,0,0).applyQuaternion(camera.quaternion),cameraUp.set(0,1,0).applyQuaternion(camera.quaternion),cameraForward.set(0,0,-1).applyQuaternion(camera.quaternion),box.getSize(size).multiplyScalar(.5);const halfWidth=Math.abs(size.x*cameraRight.x)+Math.abs(size.y*cameraRight.y)+Math.abs(size.z*cameraRight.z),halfHeight=Math.abs(size.x*cameraUp.x)+Math.abs(size.y*cameraUp.y)+Math.abs(size.z*cameraUp.z),halfDepth=Math.abs(size.x*cameraForward.x)+Math.abs(size.y*cameraForward.y)+Math.abs(size.z*cameraForward.z);if(camera instanceof PerspectiveCamera){const vfov=camera.fov*Math.PI/180,tanHalfVfov=Math.tan(vfov/2),aspect=camera.aspect||1;let distance=0;for(let i=0;i<8;i++){corner.set(1&i?box.max.x:box.min.x,2&i?box.max.y:box.min.y,4&i?box.max.z:box.min.z).sub(center);const x=corner.dot(cameraRight),y=corner.dot(cameraUp),z=corner.dot(cameraForward),distV=Math.abs(y)/tanHalfVfov-z,distH=Math.abs(x)/(tanHalfVfov*aspect)-z;distance=Math.max(distance,distV,distH)}delta.set(0,0,1).applyQuaternion(camera.quaternion).multiplyScalar(distance),camera.position.copy(center).add(delta),camera.near=.01*halfDepth,camera.far=distance+20*halfDepth,camera.zoom=1/overscan,camera.updateProjectionMatrix()}else camera instanceof OrthographicCamera&&(delta.set(0,0,1).applyQuaternion(camera.quaternion).multiplyScalar(radius),camera.position.copy(center).add(delta),camera.lookAt(center),camera.left=-halfWidth,camera.right=halfWidth,camera.bottom=-halfHeight,camera.top=halfHeight,camera.zoom=1/overscan,camera.near=0,camera.far=radius+20*halfDepth,camera.updateProjectionMatrix());this.orbitControls.target.copy(center)}setOverscan(width,height,overscan){const camera=this.camera,resetCamera=resetCameras.get(camera)||camera.clone(!1);resetCamera.copy(camera,!1),resetCameras.set(camera,resetCamera);const aspect=width/height;if(camera instanceof PerspectiveCamera)camera.aspect=aspect,camera.fov*=overscan;else if(camera instanceof OrthographicCamera){const frustumHeight=camera.top-camera.bottom,frustumWidth=camera.right-camera.left;frustumWidth/frustumHeight>aspect?(camera.top=frustumWidth/2/aspect,camera.bottom=-frustumWidth/2/aspect):(camera.left=-frustumHeight/2*aspect,camera.right=frustumHeight/2*aspect),camera.top*=overscan,camera.bottom*=overscan,camera.left*=overscan,camera.right*=overscan}camera.updateProjectionMatrix()}resetOverscan(){const camera=this.camera,resetCamera=resetCameras.get(camera);resetCamera&&camera.copy(resetCamera,!1)}dispose(){this.orbitControls.dispose(),super.dispose()}};__decorateClass$1([Property()],ViewCameras.prototype,"viewport",2),__decorateClass$1([ReactiveProperty({type:ThreeApplet})],ViewCameras.prototype,"applet",2),__decorateClass$1([ReactiveProperty({type:String,value:"perspective"})],ViewCameras.prototype,"cameraSelect",2),__decorateClass$1([ReactiveProperty({type:Camera})],ViewCameras.prototype,"camera",2),__decorateClass$1([ReactiveProperty({type:class DefaultCameras{perspective;top;bottom;left;right;front;back;constructor(){this.perspective=new PerspectiveCamera(50,1,.1,1e3),this.top=new OrthographicCamera(-1,1,1,-1,0,1e3),this.bottom=new OrthographicCamera(-1,1,1,-1,0,1e3),this.left=new OrthographicCamera(-1,1,1,-1,0,1e3),this.right=new OrthographicCamera(-1,1,1,-1,0,1e3),this.front=new OrthographicCamera(-1,1,1,-1,0,1e3),this.back=new OrthographicCamera(-1,1,1,-1,0,1e3),this.perspective.userData.position=new Vector3(.5,.25,1),this.perspective.position.copy(this.perspective.userData.position),this.perspective.lookAt(0,0,0),this.perspective.name="perspective",this.top.userData.position=new Vector3(0,1,0),this.top.position.copy(this.top.userData.position),this.top.lookAt(0,0,0),this.top.name="top",this.bottom.userData.position=new Vector3(0,-1,0),this.bottom.position.copy(this.bottom.userData.position),this.bottom.lookAt(0,0,0),this.bottom.name="bottom",this.left.userData.position=new Vector3(-1,0,0),this.left.position.copy(this.left.userData.position),this.left.lookAt(0,0,0),this.left.name="left",this.right.userData.position=new Vector3(1,0,0),this.right.position.copy(this.right.userData.position),this.right.lookAt(0,0,0),this.right.name="right",this.front.userData.position=new Vector3(0,0,1),this.front.position.copy(this.front.userData.position),this.front.lookAt(0,0,0),this.front.name="front",this.back.userData.position=new Vector3(0,0,-1),this.back.position.copy(this.back.userData.position),this.back.lookAt(0,0,0),this.back.name="back"}get cameras(){return[this.perspective,this.top,this.bottom,this.left,this.right,this.front,this.back]}getCamera(name){return this.cameras.find(camera=>camera.name===name)}},init:null})],ViewCameras.prototype,"defaultCameras",2),__decorateClass$1([ReactiveProperty({type:OrbitControls,init:["this.defaultCameras.perspective"]})],ViewCameras.prototype,"orbitControls",2),ViewCameras=__decorateClass$1([Register],ViewCameras);var __defProp=Object.defineProperty,__getOwnPropDesc=Object.getOwnPropertyDescriptor,__decorateClass=(decorators,target,key,kind)=>{for(var decorator,result=kind>1?void 0:kind?__getOwnPropDesc(target,key):target,i=decorators.length-1;i>=0;i--)(decorator=decorators[i])&&(result=(kind?decorator(target,key,result):decorator(result))||result);return kind&&result&&__defProp(target,key,result),result};if(!1===WebGPU.isAvailable())throw new Error("No WebGPU support");const observer=new IntersectionObserver(entries=>{entries.forEach(entry=>{entry.target.visible=entry.isIntersecting})}),_renderer=new WebGPURenderer({antialias:!1,alpha:!0});_renderer.toneMapping=NeutralToneMapping,_renderer.setPixelRatio(window.devicePixelRatio),_renderer.shadowMap.enabled=!0,_renderer.init();const _clock=new Clock,_playingViewports=[];let _time=-1,_delta=0;new Promise((resolve,reject)=>{_renderer.setAnimationLoop(time=>{_time=time,_delta=_clock.getDelta();for(const viewport of _playingViewports)viewport.onAnimate()}).then(resolve).catch(reject)}).then(()=>{console.log("animation loop initialized")}).catch(error=>{console.error("animation loop initialization failed",error)});let IoThreeViewport=class extends IoElement{width=0;height=0;visible=!1;static get Style(){return"\n      :host {\n        position: relative;\n        display: flex;\n        flex: 1 1 auto;\n        flex-direction: column;\n        max-width: 100%;\n        max-height: 100%;\n        overflow: hidden;\n      }\n      :host > canvas {\n        position: absolute;\n      }\n    "}constructor(args){super(args),this.renderTarget=new CanvasTarget(document.createElement("canvas")),this.appendChild(this.renderTarget.domElement),this.viewCameras=new ViewCameras({viewport:this,applet:this.bind("applet"),cameraSelect:this.bind("cameraSelect")}),this.debounce(this.renderViewportDebounced)}connectedCallback(){super.connectedCallback(),observer.observe(this)}disconnectedCallback(){super.disconnectedCallback(),observer.unobserve(this),this.visible=!1}playingChanged(){this.playing?_playingViewports.push(this):_playingViewports.includes(this)&&_playingViewports.splice(_playingViewports.indexOf(this),1)}onAnimate(){this.visible&&this.debounce(this.renderViewportDebounced)}onResized(){const rect=this.getBoundingClientRect();this.width=Math.floor(rect.width),this.height=Math.floor(rect.height),this.renderTarget.setSize(this.width,this.height),this.renderTarget.setPixelRatio(window.devicePixelRatio),this.renderViewportDebounced()}appletChanged(){this.debounce(this.renderViewportDebounced)}appletMutated(){this.debounce(this.renderViewportDebounced)}changed(){this.debounce(this.renderViewportDebounced)}renderViewportDebounced(){if(!1===this.renderer.initialized)return void this.debounce(this.renderViewportDebounced);if(!1===this.applet.isRendererInitialized()&&this.applet.onRendererInitialized(this.renderer),!this.width||!this.height)return;this.renderer.setCanvasTarget(this.renderTarget),this.renderer.setClearColor(this.clearColor,this.clearAlpha),this.renderer.setSize(this.width,this.height),this.renderer.clear(),this.applet.updateViewportSize(this.width,this.height),this.applet.animate(_time,_delta);const toneMapping=this.renderer.toneMapping,toneMappingExposure=this.renderer.toneMappingExposure;this.renderer.toneMapping=this.applet.toneMapping,this.renderer.toneMappingExposure=this.applet.toneMappingExposure,this.viewCameras.setOverscan(this.width,this.height,1.1),this.renderer.render(this.applet.scene,this.viewCameras.camera),this.viewCameras.resetOverscan(),this.renderer.toneMapping=toneMapping,this.renderer.toneMappingExposure=toneMappingExposure}dispose(){this.renderTarget.dispose(),this.viewCameras.dispose(),this.renderer!==_renderer&&this.renderer.dispose(),super.dispose()}};__decorateClass([ReactiveProperty({type:Number,value:0})],IoThreeViewport.prototype,"clearColor",2),__decorateClass([ReactiveProperty({type:Number,value:1})],IoThreeViewport.prototype,"clearAlpha",2),__decorateClass([ReactiveProperty({type:String,value:"throttled"})],IoThreeViewport.prototype,"reactivity",2),__decorateClass([ReactiveProperty({type:ThreeApplet,init:null})],IoThreeViewport.prototype,"applet",2),__decorateClass([ReactiveProperty({type:Boolean})],IoThreeViewport.prototype,"playing",2),__decorateClass([ReactiveProperty({type:String,value:"perspective"})],IoThreeViewport.prototype,"cameraSelect",2),__decorateClass([ReactiveProperty({type:WebGPURenderer,value:_renderer})],IoThreeViewport.prototype,"renderer",2),IoThreeViewport=__decorateClass([Register],IoThreeViewport);const ioThreeViewport=function(arg0){return IoThreeViewport.vConstructor(arg0)};export{IoBuildGeometry,IoThreeViewport,ThreeApplet,ioBuildGeometry,ioThreeViewport};
//# sourceMappingURL=index.js.map
