{"version":3,"file":"animation_skinning_blending.js","sourceRoot":"","sources":["../../src/examples/animation_skinning_blending.ts"],"names":[],"mappings":"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","sourcesContent":["import { ReactiveProperty, Register } from '@io-gui/core'\nimport {\n  AnimationAction,\n  AnimationMixer,\n  Color,\n  DirectionalLight,\n  Fog,\n  Group,\n  HemisphereLight,\n  Mesh,\n  MeshPhongMaterial,\n  PerspectiveCamera,\n  PlaneGeometry,\n} from 'three/webgpu'\nimport { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js'\nimport { ThreeApplet } from '@io-gui/three'\nimport { ioButton, ioBoolean } from '@io-gui/inputs'\nimport { ioPropertyEditor } from '@io-gui/editors'\n\nconst loader = new GLTFLoader()\n\n@Register\nexport class AnimationSkinningBlendingExample extends ThreeApplet {\n\n  @ReactiveProperty({type: Boolean, value: false})\n  declare isActive: boolean\n\n  @ReactiveProperty({type: Boolean, value: false})\n  declare isPlaying: boolean\n\n  public camera: PerspectiveCamera\n  public mixer: AnimationMixer = new AnimationMixer(new Group())\n  public actions: Record<string, AnimationAction> = {}\n\n  // Playback\n  public stepSize: number = 0.05\n\n  // Crossfading\n  public useDefaultDuration: boolean = true\n  public customDuration: number = 3.5\n\n  constructor() {\n    super()\n\n    // Camera\n    this.camera = new PerspectiveCamera( 45, window.innerWidth / window.innerHeight, 1, 100 )\n    this.camera.position.set( 1, 2, - 3 )\n    this.camera.lookAt( 0, 1, 0 )\n    this.scene.add(this.camera)\n\n    // Scene setup\n    this.scene.background = new Color(0xa0a0a0)\n    this.scene.fog = new Fog(0xa0a0a0, 10, 50)\n\n    // Lights\n    const hemiLight = new HemisphereLight(0xffffff, 0x8d8d8d, 3)\n    hemiLight.position.set(0, 20, 0)\n    this.scene.add(hemiLight)\n\n    const dirLight = new DirectionalLight(0xffffff, 3)\n    dirLight.position.set(-3, 10, -10)\n    dirLight.castShadow = true\n    dirLight.shadow.camera.top = 2\n    dirLight.shadow.camera.bottom = -2\n    dirLight.shadow.camera.left = -2\n    dirLight.shadow.camera.right = 2\n    dirLight.shadow.camera.near = 0.1\n    dirLight.shadow.camera.far = 40\n    this.scene.add(dirLight)\n\n    const ground = new Mesh(\n      new PlaneGeometry(10, 10),\n      new MeshPhongMaterial({color: 0xcbcbcb, depthWrite: false})\n    )\n    ground.rotation.x = -Math.PI / 2\n    ground.receiveShadow = true\n    this.scene.add(ground)\n\n    this.uiConfig = [\n      ['isPlaying', ioBoolean({true: 'io:circle_pause', false: 'io:circle_fill_arrow_right'})],\n      ['makeSingleStep', ioButton({label: 'Make Single Step'})],\n      ['actions', ioPropertyEditor()],\n      [AnimationAction, ioPropertyEditor({groups: {\n        Playback: [\n          'isActive',\n          'isPlaying',\n          'stepSize',\n          'makeSingleStep',\n        ],\n        Crossfade: [\n          'actions',\n          'walk',\n          'run',\n          'idle',\n          'useDefaultDuration',\n          'customDuration',\n        ],\n        Scene: [\n          'camera',\n        ],\n        Rendering: []\n      }})],\n      [AnimationMixer, ioPropertyEditor({groups: {Hidden: ['stats']}})],\n    ]\n\n    this.uiGroups = {\n      Playback: [\n        'isActive',\n        'isPlaying',\n        'stepSize',\n        'makeSingleStep',\n      ],\n      Crossfade: [\n        'actions',\n        'walk',\n        'run',\n        'idle',\n        'useDefaultDuration',\n        'customDuration',\n      ],\n      Scene: [\n        'camera',\n      ],\n      Rendering: [],\n      Hidden: [],\n    }\n\n    void this.loadModel()\n  }\n\n  private async loadModel() {\n    loader.load('https://threejs.org/examples/models/gltf/Soldier.glb', (gltf) => {\n      const model = gltf.scene as Group\n      this.scene.add(model)\n\n      model.traverse((object) => {\n        if ((object as Mesh).isMesh) {\n          object.castShadow = true\n        }\n      })\n\n      this.mixer = new AnimationMixer(model)\n\n      this.actions = {\n        idle: this.mixer.clipAction(gltf.animations[0]),\n        walk: this.mixer.clipAction(gltf.animations[3]),\n        run: this.mixer.clipAction(gltf.animations[1]),\n      }\n\n      this.setProperties({\n        isActive: true,\n        isPlaying: true,\n      })\n\n      this.dispatch('scene-ready', {scene: this.scene}, true)\n    })\n  }\n\n  isActiveChanged() {\n    if (this.isActive) {\n      Object.values(this.actions).forEach((action: AnimationAction) => action.play())\n    } else {\n      Object.values(this.actions).forEach((action: AnimationAction) => action.stop())\n    }\n  }\n\n  idle = () => { this.prepareCrossFade(this.actions.idle, this.actions.walk, 1.0) }\n  walk = () => { this.prepareCrossFade(this.actions.walk, this.actions.run, 0.5) }\n  run = () => { this.prepareCrossFade(this.actions.run, this.actions.idle, 2.5) }\n\n  public makeSingleStep = () => {\n    if (this.mixer && !this.isPlaying) {\n      this.mixer.update(this.stepSize)\n    }\n  }\n\n  private prepareCrossFade(startAction: AnimationAction, endAction: AnimationAction, defaultDuration: number) {\n\n    const duration = this.setCrossFadeDuration(defaultDuration)\n\n    this.isPlaying = true\n\n    if (startAction === this.actions.idle) {\n      this.executeCrossFade(startAction, endAction, duration)\n    } else {\n      this.synchronizeCrossFade(startAction, endAction, duration)\n    }\n  }\n\n  private setCrossFadeDuration(defaultDuration: number): number {\n    if (this.useDefaultDuration) {\n      return defaultDuration\n    } else {\n      return this.customDuration as number\n    }\n  }\n\n  private synchronizeCrossFade(startAction: AnimationAction, endAction: AnimationAction, duration: number) {\n    if (!this.mixer) return\n\n    const onLoopFinished = (event: {action: AnimationAction}) => {\n      if (event.action === startAction) {\n        this.mixer.removeEventListener('loop', onLoopFinished as any)\n        this.executeCrossFade(startAction, endAction, duration)\n      }\n    }\n\n    this.mixer.addEventListener('loop', onLoopFinished as any)\n  }\n\n  private executeCrossFade(startAction: AnimationAction, endAction: AnimationAction, duration: number) {\n    this.setWeight(endAction, 1)\n    endAction.time = 0\n    startAction.crossFadeTo(endAction, duration, true)\n  }\n\n  private setWeight(action: AnimationAction, weight: number) {\n    action.enabled = true\n    action.setEffectiveTimeScale(1)\n    action.setEffectiveWeight(weight)\n  }\n\n  onAnimate(delta: number) {\n    if (!this.mixer) return\n\n    debug: {\n      this.dispatchMutation(this.actions.idle)\n      this.dispatchMutation(this.actions.walk)\n      this.dispatchMutation(this.actions.run)\n      this.dispatchMutation(this.mixer)\n    }\n\n    if (this.isPlaying) {\n      this.mixer.update(delta)\n    }\n  }\n}"]}