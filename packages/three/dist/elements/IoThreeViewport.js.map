{"version":3,"file":"IoThreeViewport.js","sourceRoot":"","sources":["../../src/elements/IoThreeViewport.ts"],"names":[],"mappings":"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","sourcesContent":["import { Register, IoElement, IoElementProps, ReactiveProperty, ReactivityType, Change, Property, WithBinding } from '@io-gui/core'\nimport { WebGPURenderer, CanvasTarget, NeutralToneMapping, PerspectiveCamera, Vector2, Vector3 } from 'three/webgpu'\nimport WebGPU from 'three/addons/capabilities/WebGPU.js'\nimport { ThreeApplet } from '../nodes/ThreeApplet.js'\nimport { ViewCameras } from '../nodes/ViewCameras.js'\nimport { ToolBase } from '../nodes/ToolBase.js'\n\nif ( WebGPU.isAvailable() === false ) {\n  throw new Error( 'No WebGPU support' )\n}\n\nexport interface Pointer3D {\n  screen: Vector2\n  origin: Vector3\n  direction: Vector3\n  event: PointerEvent\n}\n\nconst observer = new IntersectionObserver((entries) => {\n  entries.forEach(entry => {\n    (entry.target as IoThreeViewport).visible = entry.isIntersecting\n  })\n})\n\n// TODO: Add support for logarithmic depth buffer\n// TODO: Add support for unique renderer instances per viewport\nconst _renderer = new WebGPURenderer({antialias: false, alpha: true})\n_renderer.toneMapping = NeutralToneMapping\n_renderer.setPixelRatio(window.devicePixelRatio)\n_renderer.shadowMap.enabled = true\nvoid _renderer.init()\n\nexport type IoThreeViewportProps = IoElementProps & {\n  overscan?: WithBinding<number>\n  clearColor?: WithBinding<number>\n  clearAlpha?: WithBinding<number>\n  applet: WithBinding<ThreeApplet>\n  cameraSelect?: WithBinding<string>\n  renderer?: WebGPURenderer\n  tool?: WithBinding<ToolBase>\n}\n\n@Register\nexport class IoThreeViewport extends IoElement {\n\n  public width: number = 0\n  public height: number = 0\n  public visible: boolean = false\n\n  @ReactiveProperty({type: Number, value: 1.1})\n  declare public overscan: number\n\n  @ReactiveProperty({type: Number, value: 0x000000})\n  declare public clearColor: number\n\n  @ReactiveProperty({type: Number, value: 1})\n  declare public clearAlpha: number\n\n  @ReactiveProperty({type: String, value: 'throttled'})\n  declare reactivity: ReactivityType\n\n  @ReactiveProperty({type: ThreeApplet, init: null})\n  declare applet: ThreeApplet\n\n  @ReactiveProperty({type: String, value: 'perspective'})\n  declare cameraSelect: string\n\n  @ReactiveProperty({type: WebGPURenderer, value: _renderer})\n  declare renderer: WebGPURenderer\n\n  @ReactiveProperty({type: ViewCameras})\n  declare viewCameras: ViewCameras\n\n  @ReactiveProperty({type: ToolBase})\n  declare tool: ToolBase\n\n  @Property(0)\n  declare tabIndex: number\n\n  declare private readonly renderTarget: CanvasTarget\n\n  static get Style() {\n    return /* css */`\n      :host {\n        position: relative;\n        display: flex;\n        flex: 1 1 auto;\n        flex-direction: column;\n        max-width: 100%;\n        max-height: 100%;\n        overflow: hidden;\n        border: var(--io_border);\n        border-color: transparent;\n      }\n      :host > canvas {\n        position: absolute;\n        pointer-events: none;\n      }\n      :host:focus {\n        border: var(--io_border);\n        border-color: var(--io_colorWhite);\n      }\n    `\n  }\n\n  static get Listeners() {\n    return {\n      'three-applet-needs-render': 'onAppletNeedsRender',\n    }\n  }\n\n  constructor(args: IoThreeViewportProps) {\n    super(args)\n\n    this.renderTarget = new CanvasTarget(document.createElement('canvas'))\n    this.appendChild(this.renderTarget.domElement)\n\n    this.viewCameras = new ViewCameras({viewport: this, applet: this.bind('applet'), cameraSelect: this.bind('cameraSelect')})\n\n    this.debounce(this.renderViewportDebounced)\n  }\n\n  connectedCallback() {\n    super.connectedCallback()\n    observer.observe(this)\n  }\n  disconnectedCallback() {\n    super.disconnectedCallback()\n    observer.unobserve(this)\n    // TODO: Visibility observe\n    this.visible = false\n  }\n\n  toolChanged(change: Change<ToolBase>) {\n    const newTool = change.value\n    const oldTool = change.oldValue\n    if (oldTool) oldTool.unregisterViewport(this)\n    if (newTool) newTool.registerViewport(this)\n  }\n\n  onAppletNeedsRender(event: CustomEvent) {\n    event.stopPropagation()\n    if (!this.visible) return\n    this.debounce(this.renderViewportDebounced)\n  }\n\n  onResized() {\n    const rect = this.getBoundingClientRect()\n    this.width = Math.floor(rect.width)\n    this.height = Math.floor(rect.height)\n    this.renderTarget.setSize(this.width, this.height)\n    this.renderTarget.setPixelRatio(window.devicePixelRatio)\n    this.renderViewportDebounced()\n  }\n\n  appletChanged() {\n    this.debounce(this.renderViewportDebounced)\n  }\n  appletMutated() {\n    this.debounce(this.renderViewportDebounced)\n  }\n  viewCamerasMutated() {\n    this.debounce(this.renderViewportDebounced)\n  }\n  changed() {\n    this.debounce(this.renderViewportDebounced)\n  }\n\n  renderViewportDebounced() {\n    if (this.renderer.initialized === false) {\n      this.debounce(this.renderViewportDebounced, undefined, 2)\n      return\n    }\n    this.applet.updateViewportSize(this.width, this.height)\n    this.renderViewport()\n  }\n  renderViewport() {\n    if (this.renderer.initialized === false) return\n    if (this.applet.isRendererInitialized() === false) {\n      void this.applet.onRendererInitialized(this.renderer)\n    }\n    if (!this.width || !this.height) return\n\n    this.renderer.setCanvasTarget(this.renderTarget)\n    this.renderer.setClearColor(this.clearColor, this.clearAlpha)\n    this.renderer.setSize(this.width, this.height)\n    this.renderer.clear()\n\n    this.applet.updateViewportSize(this.width, this.height)\n\n    const toneMapping = this.renderer.toneMapping\n    const toneMappingExposure = this.renderer.toneMappingExposure\n\n    this.renderer.toneMapping = this.applet.toneMapping\n    this.renderer.toneMappingExposure = this.applet.toneMappingExposure\n\n    this.viewCameras.setOverscan(this.width, this.height, this.overscan)\n    this.renderer.render(this.applet.scene, this.viewCameras.camera)\n    this.viewCameras.resetOverscan()\n\n    this.renderer.toneMapping = toneMapping\n    this.renderer.toneMappingExposure = toneMappingExposure\n  }\n\n  pointerTo3D(event: PointerEvent): Pointer3D {\n    const rect = (event.target as IoThreeViewport).getBoundingClientRect()\n\n    const screen = new Vector2(\n      ((event.clientX - rect.left) / rect.width) * 2 - 1,\n      -((event.clientY - rect.top) / rect.height) * 2 + 1,\n    )\n\n    this.viewCameras.setOverscan(this.width, this.height, this.overscan)\n    const camera = this.viewCameras.camera\n\n    const origin = new Vector3(screen.x, screen.y, -1).unproject(camera)\n    camera.updateMatrixWorld()\n    origin.applyMatrix4(camera.matrixWorld)\n\n    const direction = new Vector3()\n\n    if (camera instanceof PerspectiveCamera) {\n      direction.setFromMatrixPosition(camera.matrixWorld)\n      direction.subVectors(origin, direction).normalize()\n    } else {\n      direction.set(0, 0, -1).transformDirection(camera.matrixWorld)\n    }\n\n    this.viewCameras.resetOverscan()\n\n    return {\n      screen,\n      origin,\n      direction,\n      event,\n    }\n  }\n\n\n  dispose() {\n    delete (this as any).applet\n    this.renderTarget.dispose()\n    this.viewCameras.dispose()\n    this.tool.unregisterViewport(this)\n    super.dispose()\n  }\n}\n\nexport const ioThreeViewport = function(arg0: IoThreeViewportProps) {\n  return IoThreeViewport.vConstructor(arg0)\n}"]}