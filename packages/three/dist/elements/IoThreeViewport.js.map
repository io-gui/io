{"version":3,"file":"IoThreeViewport.js","sourceRoot":"","sources":["../../src/elements/IoThreeViewport.ts"],"names":[],"mappings":"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","sourcesContent":["import { Register, IoElement, IoElementProps, ReactiveProperty, ReactivityType, Binding } from '@io-gui/core'\nimport { WebGPURenderer, CanvasTarget, Clock, NeutralToneMapping } from 'three/webgpu'\nimport WebGPU from 'three/addons/capabilities/WebGPU.js'\nimport { ThreeApplet } from '../nodes/ThreeApplet.js'\nimport { ViewCameras } from '../nodes/ViewCameras.js'\n\nif ( WebGPU.isAvailable() === false ) {\n  throw new Error( 'No WebGPU support' )\n}\n\nconst observer = new IntersectionObserver((entries) => {\n  entries.forEach(entry => {\n    (entry.target as IoThreeViewport).visible = entry.isIntersecting\n  })\n})\n\n// TODO: Add support for logarithmic depth buffer\n// TODO: Add support for unique renderer instances per viewport\nconst _renderer = new WebGPURenderer({antialias: false, alpha: true})\n_renderer.toneMapping = NeutralToneMapping\n_renderer.setPixelRatio(window.devicePixelRatio)\n_renderer.shadowMap.enabled = true\nvoid _renderer.init()\n\nconst _clock = new Clock()\n\nconst _playingViewports: IoThreeViewport[] = []\nlet _time = -1\nlet _delta = 0\n\nnew Promise((resolve, reject) => {\n  _renderer.setAnimationLoop((time: number) => {\n    _time = time\n    _delta = _clock.getDelta()\n    for (const viewport of _playingViewports) {\n      viewport.onAnimate()\n    }\n  }).then(resolve).catch(reject)\n}).then(() => {\n  console.log('animation loop initialized')\n}).catch(error => {\n  console.error('animation loop initialization failed', error)\n})\n\nexport type IoThreeViewportProps = IoElementProps & {\n  clearColor?: number | Binding\n  clearAlpha?: number | Binding\n  applet: ThreeApplet | Binding\n  playing?: boolean | Binding\n  cameraSelect?: string | Binding\n  renderer?: WebGPURenderer\n}\n\n@Register\nexport class IoThreeViewport extends IoElement {\n\n  public width: number = 0\n  public height: number = 0\n  public visible: boolean = false\n\n  @ReactiveProperty({type: Number, value: 0x000000})\n  declare public clearColor: number\n\n  @ReactiveProperty({type: Number, value: 1})\n  declare public clearAlpha: number\n\n  @ReactiveProperty({type: String, value: 'throttled'})\n  declare reactivity: ReactivityType\n\n  @ReactiveProperty({type: ThreeApplet, init: null})\n  declare applet: ThreeApplet\n\n  @ReactiveProperty({type: Boolean})\n  declare playing: boolean\n\n  @ReactiveProperty({type: String, value: 'perspective'})\n  declare cameraSelect: string\n\n  @ReactiveProperty({type: WebGPURenderer, value: _renderer})\n  declare renderer: WebGPURenderer\n\n  declare private readonly viewCameras: ViewCameras\n  declare private readonly renderTarget: CanvasTarget\n\n  static get Style() {\n    return /* css */`\n      :host {\n        position: relative;\n        display: flex;\n        flex: 1 1 auto;\n        flex-direction: column;\n        max-width: 100%;\n        max-height: 100%;\n        overflow: hidden;\n      }\n      :host > canvas {\n        position: absolute;\n      }\n    `\n  }\n\n  constructor(args: IoThreeViewportProps) {\n    super(args)\n\n    this.renderTarget = new CanvasTarget(document.createElement('canvas'))\n    this.appendChild(this.renderTarget.domElement)\n\n    this.viewCameras = new ViewCameras({viewport: this, applet: this.bind('applet'), cameraSelect: this.bind('cameraSelect')})\n\n    this.debounce(this.renderViewportDebounced)\n\n    this.playingChanged()\n  }\n\n  connectedCallback() {\n    super.connectedCallback()\n    observer.observe(this)\n  }\n  disconnectedCallback() {\n    super.disconnectedCallback()\n    observer.unobserve(this)\n    this.visible = false\n  }\n\n  playingChanged() {\n    if (this.playing === true && _playingViewports.includes(this) === false) {\n      _playingViewports.push(this)\n    } else if (this.playing === false && _playingViewports.includes(this)) {\n      _playingViewports.splice(_playingViewports.indexOf(this), 1)\n    }\n  }\n\n\n  onAnimate() {\n    if (!this.visible) return\n    this.debounce(this.renderViewportDebounced)\n  }\n\n  onResized() {\n    const rect = this.getBoundingClientRect()\n    this.width = Math.floor(rect.width)\n    this.height = Math.floor(rect.height)\n    this.renderTarget.setSize(this.width, this.height)\n    this.renderTarget.setPixelRatio(window.devicePixelRatio)\n    this.renderViewportDebounced()\n  }\n\n  appletChanged() {\n    this.debounce(this.renderViewportDebounced)\n  }\n  appletMutated() {\n    this.debounce(this.renderViewportDebounced)\n  }\n  changed() {\n    this.debounce(this.renderViewportDebounced)\n  }\n\n  renderViewportDebounced() {\n    if (this.renderer.initialized === false) {\n      this.debounce(this.renderViewportDebounced)\n      return\n    }\n    if (this.applet.isRendererInitialized() === false) {\n      void this.applet.onRendererInitialized(this.renderer)\n    }\n    if (!this.width || !this.height) {\n      return\n    }\n    this.renderer.setCanvasTarget(this.renderTarget)\n    this.renderer.setClearColor(this.clearColor, this.clearAlpha)\n    this.renderer.setSize(this.width, this.height)\n    this.renderer.clear()\n\n    this.applet.updateViewportSize(this.width, this.height)\n    this.applet.animate(_time, _delta)\n\n    const toneMapping = this.renderer.toneMapping\n    const toneMappingExposure = this.renderer.toneMappingExposure\n\n    this.renderer.toneMapping = this.applet.toneMapping\n    this.renderer.toneMappingExposure = this.applet.toneMappingExposure\n\n    this.viewCameras.setOverscan(this.width, this.height, 1.1)\n    this.renderer.render(this.applet.scene, this.viewCameras.camera)\n    this.viewCameras.resetOverscan()\n\n    this.renderer.toneMapping = toneMapping\n    this.renderer.toneMappingExposure = toneMappingExposure\n  }\n\n  dispose() {\n    this.renderTarget.dispose()\n    this.viewCameras.dispose()\n    if (this.renderer !== _renderer) {\n      this.renderer.dispose()\n    }\n    super.dispose()\n  }\n}\n\nexport const ioThreeViewport = function(arg0: IoThreeViewportProps) {\n  return IoThreeViewport.vConstructor(arg0)\n}"]}