{"version":3,"file":"index.js","sources":["../src/nodes/ThreeApplet.ts","../src/nodes/ViewCameras.ts","../src/elements/IoThreeViewport.ts"],"sourcesContent":["import { Register, Node, ReactiveProperty, NodeProps } from '@io-gui/core'\nimport { PropertyConfig, registerEditorGroups } from '@io-gui/editors'\nimport { NoToneMapping, Scene, ToneMapping, WebGPURenderer } from 'three/webgpu'\n\nexport type ThreeAppletProps = NodeProps & {\n  scene?: Scene\n  toneMappingExposure?: number\n  toneMapping?: ToneMapping\n  uiConfig?: PropertyConfig[]\n}\n\n@Register\nexport class ThreeApplet extends Node {\n\n  @ReactiveProperty({type: Scene, init: null})\n  declare scene: Scene\n\n  @ReactiveProperty({type: Number, value: 1})\n  declare toneMappingExposure: number\n\n  @ReactiveProperty({type: Number, value: NoToneMapping})\n  declare toneMapping: ToneMapping\n\n  // TODO: dispose uiConfig when applet is disposed\n  @ReactiveProperty({type: Array, init: null})\n  declare uiConfig: PropertyConfig[]\n\n  private _renderer: WebGPURenderer | null = null\n  private _width: number = 0\n  private _height: number = 0\n  private _prevTime: number = -1\n\n  constructor(args?: ThreeAppletProps) {\n    super(args)\n  }\n\n  updateViewportSize(width: number, height: number) {\n    if (this._width !== width || this._height !== height) {\n      if (!!width && !!height) {\n        this._width = width\n        this._height = height\n        this.onResized(width, height)\n      }\n    }\n\n  }\n  isRendererInitialized() {\n    return !!this._renderer && this._renderer.initialized === true\n  }\n  onRendererInitialized(renderer: WebGPURenderer) {\n    this._renderer = renderer\n  }\n  // eslint-disable-next-line @typescript-eslint/no-unused-vars\n  onResized(width: number, height: number) {}\n\n  animate(time: number, delta: number) {\n    if (this._prevTime === time) return\n    this._prevTime = time\n    this.onAnimate(delta)\n  }\n  // eslint-disable-next-line @typescript-eslint/no-unused-vars\n  onAnimate(delta: number) {}\n}\n\nregisterEditorGroups(ThreeApplet, {\n  Scene: [\n    'scene',\n  ],\n  Rendering: [\n    'toneMappingExposure',\n    'toneMapping',\n  ],\n  Hidden: [\n    'uiConfig',\n  ]\n})","import { Register, Node, ReactiveProperty, Property, NodeProps, Binding  } from '@io-gui/core'\nimport { IoThreeViewport } from '../elements/IoThreeViewport.js'\nimport { ThreeApplet } from './ThreeApplet.js'\nimport { Box3, Camera, Object3D, OrthographicCamera, PerspectiveCamera, Sphere, Vector3 } from 'three/webgpu'\nimport { OrbitControls } from 'three/addons/controls/OrbitControls.js'\n\nconst box = new Box3()\nconst sphere = new Sphere()\nconst center = new Vector3()\nconst size = new Vector3()\nconst delta = new Vector3()\nconst cameraRight = new Vector3()\nconst cameraUp = new Vector3()\nconst cameraForward = new Vector3()\nconst corner = new Vector3()\nlet radius = 0\n\nconst resetCameras = new WeakMap<Camera, Camera>()\n\nclass DefaultCameras {\n  public perspective: PerspectiveCamera\n  public top: OrthographicCamera\n  public bottom: OrthographicCamera\n  public left: OrthographicCamera\n  public right: OrthographicCamera\n  public front: OrthographicCamera\n  public back: OrthographicCamera\n  constructor() {\n    this.perspective = new PerspectiveCamera(50, 1, 0.1, 1000)\n    this.top = new OrthographicCamera(-1, 1, 1, -1, 0, 1000)\n    this.bottom = new OrthographicCamera(-1, 1, 1, -1, 0, 1000)\n    this.left = new OrthographicCamera(-1, 1, 1, -1, 0, 1000)\n    this.right = new OrthographicCamera(-1, 1, 1, -1, 0, 1000)\n    this.front = new OrthographicCamera(-1, 1, 1, -1, 0, 1000)\n    this.back = new OrthographicCamera(-1, 1, 1, -1, 0, 1000)\n\n    this.perspective.userData.position = new Vector3(0.5, 0.25, 1)\n    this.perspective.position.copy(this.perspective.userData.position)\n    this.perspective.lookAt(0, 0, 0)\n    this.perspective.name = 'perspective'\n\n    this.top.userData.position = new Vector3(0, 1, 0)\n    this.top.position.copy(this.top.userData.position)\n    this.top.lookAt(0, 0, 0)\n    this.top.name = 'top'\n\n    this.bottom.userData.position = new Vector3(0, -1, 0)\n    this.bottom.position.copy(this.bottom.userData.position)\n    this.bottom.lookAt(0, 0, 0)\n    this.bottom.name = 'bottom'\n\n    this.left.userData.position = new Vector3(-1, 0, 0)\n    this.left.position.copy(this.left.userData.position)\n    this.left.lookAt(0, 0, 0)\n    this.left.name = 'left'\n\n    this.right.userData.position = new Vector3(1, 0, 0)\n    this.right.position.copy(this.right.userData.position)\n    this.right.lookAt(0, 0, 0)\n    this.right.name = 'right'\n\n    this.front.userData.position = new Vector3(0, 0, 1)\n    this.front.position.copy(this.front.userData.position)\n    this.front.lookAt(0, 0, 0)\n    this.front.name = 'front'\n\n    this.back.userData.position = new Vector3(0, 0, -1)\n    this.back.position.copy(this.back.userData.position)\n    this.back.lookAt(0, 0, 0)\n    this.back.name = 'back'\n  }\n  get cameras() {\n    return [this.perspective, this.top, this.bottom, this.left, this.right, this.front, this.back]\n  }\n  getCamera(name: string) {\n    return this.cameras.find(camera => camera.name === name)\n  }\n}\n\n\n\nexport type ViewCamerasProps = NodeProps & {\n  viewport: IoThreeViewport\n  applet: ThreeApplet | Binding\n  cameraSelect: string | Binding\n}\n\n@Register\nexport class ViewCameras extends Node {\n\n  @Property()\n  declare private viewport: IoThreeViewport\n\n  @ReactiveProperty({type: ThreeApplet})\n  declare public applet: ThreeApplet\n\n  @ReactiveProperty({type: String, value: 'perspective'})\n  declare public cameraSelect: string\n\n  @ReactiveProperty({type: Camera})\n  declare public camera: PerspectiveCamera | OrthographicCamera\n\n  @ReactiveProperty({type: DefaultCameras, init: null})\n  declare private readonly defaultCameras: DefaultCameras\n\n  @ReactiveProperty({type: OrbitControls, init: ['this.defaultCameras.perspective']})\n  declare private readonly orbitControls: OrbitControls\n\n  static get Listeners() {\n    return {\n      'scene-ready': 'onSceneReady'\n    }\n  }\n\n  constructor(args: ViewCamerasProps) {\n    super(args)\n\n    this.orbitControls.connect(this.viewport)\n    this.orbitControls.addEventListener('change', () => {\n      this.applet.dispatchMutation()\n    })\n\n    if (this.camera === undefined) this.camera = this.defaultCameras.perspective\n  }\n\n  cameraSelectChanged() {\n    this.debounce(this.cameraSelectChangedDebounced)\n  }\n\n  cameraSelectChangedDebounced() {\n    let matchedCamera: PerspectiveCamera | OrthographicCamera | undefined\n    if (this.cameraSelect.startsWith('scene')) {\n      const cameraId = this.cameraSelect.split(':')[1] || ''\n      const persp = this.applet.scene.getObjectsByProperty('isPerspectiveCamera', true)\n      const ortho = this.applet.scene.getObjectsByProperty('isOrthographicCamera', true)\n      const cameras = [...persp, ...ortho]\n\n      if (cameraId) {\n        matchedCamera = cameras.find(camera => camera.name === cameraId) as PerspectiveCamera | OrthographicCamera | undefined\n        if (!matchedCamera) {\n          console.warn(`Camera ${cameraId} not found in the scene, using default perspective camera`)\n        }\n      } else {\n        matchedCamera = cameras[0] as PerspectiveCamera | OrthographicCamera | undefined\n        if (!matchedCamera) {\n          console.warn('No cameras found in the scene, using default perspective camera')\n        }\n      }\n      if (matchedCamera) {\n        this.camera = matchedCamera\n      } else {\n        this.camera = this.defaultCameras.perspective\n      }\n    } else {\n      matchedCamera = this.defaultCameras.getCamera(this.cameraSelect)\n      if (matchedCamera) {\n        this.camera = matchedCamera\n      } else {\n        console.warn(`Camera ${this.cameraSelect} not found in the default cameras, using default perspective camera`)\n        this.camera = this.defaultCameras.perspective\n      }\n    }\n  }\n\n  cameraChanged() {\n    // TODO: redundant if camera is one of the defaults?\n    // TODO: Consider leaving scene camera aspect ratio unchanged or:\n    // - Set it temporarily to match viewport aspect ratio (show frame mask) and restore it\n    if (!this.defaultCameras.cameras.includes(this.camera)) {\n      this.orbitControls.enabled = false\n    } else {\n      this.orbitControls.enabled = true\n      this.orbitControls.object = this.camera\n      this.orbitControls.enableRotate = !!(this.camera as PerspectiveCamera).isPerspectiveCamera\n    }\n  }\n\n  appletChanged() {\n    for (const camera of this.defaultCameras.cameras) {\n      camera.position.copy(camera.userData.position)\n      camera.lookAt(0, 0, 0)\n      this.frameObject(this.applet.scene, camera)\n    }\n    this.debounce(this.cameraSelectChangedDebounced)\n  }\n\n  onSceneReady() {\n    this.appletChanged()\n  }\n\n  frameObject(object: Object3D, camera: Camera) {\n\n    box.setFromObject( object )\n\n    if ( box.isEmpty() === false ) {\n      box.getCenter( center )\n      radius = box.getBoundingSphere( sphere ).radius\n    } else {\n      // Focusing on an Group, AmbientLight, etc\n      // TODO: Investigate and make more robust\n      center.setFromMatrixPosition( camera.matrixWorld )\n      radius = 0.1\n    }\n\n    // Project box onto camera axes\n    cameraRight.set(1, 0, 0).applyQuaternion(camera.quaternion)\n    cameraUp.set(0, 1, 0).applyQuaternion(camera.quaternion)\n    cameraForward.set(0, 0, -1).applyQuaternion(camera.quaternion)\n\n    box.getSize(size).multiplyScalar(0.5)\n\n    const halfWidth = Math.abs(size.x * cameraRight.x) + Math.abs(size.y * cameraRight.y) + Math.abs(size.z * cameraRight.z)\n    const halfHeight = Math.abs(size.x * cameraUp.x) + Math.abs(size.y * cameraUp.y) + Math.abs(size.z * cameraUp.z)\n    const halfDepth = Math.abs(size.x * cameraForward.x) + Math.abs(size.y * cameraForward.y) + Math.abs(size.z * cameraForward.z)\n\n    if (camera instanceof PerspectiveCamera) {\n\n      const vfov = camera.fov * Math.PI / 180\n      const tanHalfVfov = Math.tan(vfov / 2)\n      const aspect = camera.aspect || 1\n\n      let distance = 0\n      for (let i = 0; i < 8; i++) {\n        corner.set(\n          (i & 1) ? box.max.x : box.min.x,\n          (i & 2) ? box.max.y : box.min.y,\n          (i & 4) ? box.max.z : box.min.z\n        ).sub(center)\n\n        const x = corner.dot(cameraRight)\n        const y = corner.dot(cameraUp)\n        const z = corner.dot(cameraForward)\n\n        const distV = Math.abs(y) / tanHalfVfov - z\n        const distH = Math.abs(x) / (tanHalfVfov * aspect) - z\n        distance = Math.max(distance, distV, distH)\n      }\n\n      delta.set(0, 0, 1)\n        .applyQuaternion(camera.quaternion)\n        .multiplyScalar(distance)\n      camera.position.copy(center).add(delta)\n\n      camera.near = Math.max(halfDepth * 0.1)\n      camera.far = distance + halfDepth * 20\n      camera.updateProjectionMatrix()\n\n    } else if (camera instanceof OrthographicCamera) {\n\n      delta.set(0, 0, 1).applyQuaternion(camera.quaternion).multiplyScalar(radius)\n      camera.position.copy(center).add(delta)\n      camera.lookAt(center)\n\n      camera.left = -halfWidth\n      camera.right = halfWidth\n      camera.bottom = -halfHeight\n      camera.top = halfHeight\n\n      camera.zoom = 1\n      camera.near = 0\n      camera.far = radius + halfDepth * 20\n\n      camera.updateProjectionMatrix()\n    }\n\n    this.orbitControls.target.copy( center )\n  }\n\n  setOverscan(width: number, height: number, overscan: number) {\n\n    const camera = this.camera\n    const resetCamera = resetCameras.get(camera) || camera.clone(false)\n    resetCamera.copy(camera, false)\n    resetCameras.set(camera, resetCamera)\n\n    const aspect = width / height\n    if (camera instanceof PerspectiveCamera) {\n      camera.aspect = aspect\n      camera.fov *= overscan\n    } else if (camera instanceof OrthographicCamera) {\n      const frustumHeight = camera.top - camera.bottom\n      const frustumWidth = camera.right - camera.left\n      const frustumAspect = frustumWidth / frustumHeight\n\n      if (frustumAspect > aspect) {\n        camera.top = frustumWidth / 2 / aspect\n        camera.bottom = -frustumWidth / 2 / aspect\n      } else {\n        camera.left = -frustumHeight / 2 * aspect\n        camera.right = frustumHeight / 2 * aspect\n      }\n\n      camera.top *= overscan\n      camera.bottom *= overscan\n      camera.left *= overscan\n      camera.right *= overscan\n    }\n    camera.updateProjectionMatrix()\n  }\n\n  resetOverscan() {\n    const camera = this.camera\n    const resetCamera = resetCameras.get(camera)\n    if (resetCamera) {\n      camera.copy(resetCamera, false)\n    }\n  }\n\n  dispose() {\n    this.orbitControls.dispose()\n    super.dispose()\n  }\n}","import { Register, IoElement, IoElementProps, ReactiveProperty, ReactivityType, Binding } from '@io-gui/core'\nimport { WebGPURenderer, CanvasTarget, Clock, NeutralToneMapping } from 'three/webgpu'\nimport WebGPU from 'three/addons/capabilities/WebGPU.js'\nimport { ThreeApplet } from '../nodes/ThreeApplet.js'\nimport { ViewCameras } from '../nodes/ViewCameras.js'\n\nif ( WebGPU.isAvailable() === false ) {\n  throw new Error( 'No WebGPU support' )\n}\n\nconst observer = new IntersectionObserver((entries) => {\n  entries.forEach(entry => {\n    (entry.target as IoThreeViewport).visible = entry.isIntersecting\n  })\n})\n\n// TODO: Add support for logarithmic depth buffer\n// TODO: Add support for unique renderer instances per viewport\nconst _renderer = new WebGPURenderer({antialias: false, alpha: true})\n_renderer.toneMapping = NeutralToneMapping\n_renderer.setPixelRatio(window.devicePixelRatio)\n_renderer.shadowMap.enabled = true\nvoid _renderer.init()\n\nconst _clock = new Clock()\n\nconst _playingViewports: IoThreeViewport[] = []\nlet _time = -1\nlet _delta = 0\n\nnew Promise((resolve, reject) => {\n  _renderer.setAnimationLoop((time: number) => {\n    _time = time\n    _delta = _clock.getDelta()\n    for (const viewport of _playingViewports) {\n      viewport.onAnimate()\n    }\n  }).then(resolve).catch(reject)\n}).then(() => {\n  console.log('animation loop initialized')\n}).catch(error => {\n  console.error('animation loop initialization failed', error)\n})\n\nexport type IoThreeViewportProps = IoElementProps & {\n  clearColor?: number | Binding\n  clearAlpha?: number | Binding\n  applet: ThreeApplet | Binding\n  playing?: boolean | Binding\n  cameraSelect?: string | Binding\n  renderer?: WebGPURenderer\n}\n\n@Register\nexport class IoThreeViewport extends IoElement {\n\n  public width: number = 0\n  public height: number = 0\n  public visible: boolean = false\n\n  @ReactiveProperty({type: Number, value: 0x000000})\n  declare public clearColor: number\n\n  @ReactiveProperty({type: Number, value: 1})\n  declare public clearAlpha: number\n\n  @ReactiveProperty({type: String, value: 'throttled'})\n  declare reactivity: ReactivityType\n\n  @ReactiveProperty({type: ThreeApplet, init: null})\n  declare applet: ThreeApplet\n\n  @ReactiveProperty({type: Boolean})\n  declare playing: boolean\n\n  @ReactiveProperty({type: String, value: 'perspective'})\n  declare cameraSelect: string\n\n  @ReactiveProperty({type: WebGPURenderer, value: _renderer})\n  declare renderer: WebGPURenderer\n\n  declare private readonly viewCameras: ViewCameras\n  declare private readonly renderTarget: CanvasTarget\n\n  static get Style() {\n    return /* css */`\n      :host {\n        position: relative;\n        display: flex;\n        flex: 1 1 auto;\n        flex-direction: column;\n        max-width: 100%;\n        max-height: 100%;\n        overflow: hidden;\n      }\n      :host > canvas {\n        position: absolute;\n      }\n    `\n  }\n\n  constructor(args: IoThreeViewportProps) {\n    super(args)\n    this.renderViewport = this.renderViewport.bind(this)\n\n    this.renderTarget = new CanvasTarget(document.createElement('canvas'))\n    this.appendChild(this.renderTarget.domElement)\n\n    this.viewCameras = new ViewCameras({viewport: this, applet: this.bind('applet'), cameraSelect: this.bind('cameraSelect')})\n\n    this.debounce(this.renderViewport)\n  }\n\n  connectedCallback() {\n    super.connectedCallback()\n    observer.observe(this)\n  }\n  disconnectedCallback() {\n    super.disconnectedCallback()\n    observer.unobserve(this)\n    this.visible = false\n  }\n\n  playingChanged() {\n    if (this.playing) {\n      _playingViewports.push(this)\n    } else if (_playingViewports.includes(this)) {\n      _playingViewports.splice(_playingViewports.indexOf(this), 1)\n    }\n  }\n\n\n  onAnimate() {\n    if (!this.visible) return\n    this.debounce(this.renderViewport)\n  }\n\n  onResized() {\n    const rect = this.getBoundingClientRect()\n    this.width = Math.floor(rect.width)\n    this.height = Math.floor(rect.height)\n    this.renderTarget.setSize(this.width, this.height)\n    this.renderTarget.setPixelRatio(window.devicePixelRatio)\n    this.renderViewport()\n  }\n\n  appletChanged() {\n    this.debounce(this.renderViewport)\n  }\n  appletMutated() {\n    this.debounce(this.renderViewport)\n  }\n  changed() {\n    this.debounce(this.renderViewport)\n  }\n\n  renderViewport() {\n    if (this.renderer.initialized === false) {\n      this.debounce(this.renderViewport)\n      return\n    }\n    if (this.applet.isRendererInitialized() === false) {\n      void this.applet.onRendererInitialized(this.renderer)\n    }\n    if (!this.width || !this.height) {\n      return\n    }\n    this.renderer.setCanvasTarget(this.renderTarget)\n    this.renderer.setClearColor(this.clearColor, this.clearAlpha)\n    this.renderer.setSize(this.width, this.height)\n    this.renderer.clear()\n\n    this.applet.updateViewportSize(this.width, this.height)\n    this.applet.animate(_time, _delta)\n\n    const toneMapping = this.renderer.toneMapping\n    const toneMappingExposure = this.renderer.toneMappingExposure\n\n    this.renderer.toneMapping = this.applet.toneMapping\n    this.renderer.toneMappingExposure = this.applet.toneMappingExposure\n\n    this.viewCameras.setOverscan(this.width, this.height, 1.1)\n    this.renderer.render(this.applet.scene, this.viewCameras.camera)\n    this.viewCameras.resetOverscan()\n\n    this.renderer.toneMapping = toneMapping\n    this.renderer.toneMappingExposure = toneMappingExposure\n  }\n\n  dispose() {\n    this.renderTarget.dispose()\n    this.viewCameras.dispose()\n    if (this.renderer !== _renderer) {\n      this.renderer.dispose()\n    }\n    super.dispose()\n  }\n}\n\nexport const ioThreeViewport = function(arg0: IoThreeViewportProps) {\n  return IoThreeViewport.vConstructor(arg0)\n}"],"names":["ThreeApplet","Node","_renderer","_width","_height","_prevTime","constructor","args","super","updateViewportSize","width","height","this","onResized","isRendererInitialized","initialized","onRendererInitialized","renderer","animate","time","delta","onAnimate","__decorateClass","ReactiveProperty","type","Scene","init","prototype","Number","value","NoToneMapping","Array","Register","registerEditorGroups","Rendering","Hidden","box","Box3","sphere","Sphere","center","Vector3","size","cameraRight","cameraUp","cameraForward","corner","radius","resetCameras","WeakMap","ViewCameras","Listeners","orbitControls","connect","viewport","addEventListener","applet","dispatchMutation","camera","defaultCameras","perspective","cameraSelectChanged","debounce","cameraSelectChangedDebounced","matchedCamera","cameraSelect","startsWith","cameraId","split","cameras","scene","getObjectsByProperty","find","name","console","warn","getCamera","cameraChanged","includes","enabled","object","enableRotate","isPerspectiveCamera","appletChanged","position","copy","userData","lookAt","frameObject","onSceneReady","setFromObject","isEmpty","getCenter","getBoundingSphere","setFromMatrixPosition","matrixWorld","set","applyQuaternion","quaternion","getSize","multiplyScalar","halfWidth","Math","abs","x","y","z","halfHeight","halfDepth","PerspectiveCamera","vfov","fov","PI","tanHalfVfov","tan","aspect","distance","i","max","min","sub","dot","distV","distH","add","near","far","updateProjectionMatrix","OrthographicCamera","left","right","bottom","top","zoom","target","setOverscan","overscan","resetCamera","get","clone","frustumHeight","frustumWidth","resetOverscan","dispose","Property","String","Camera","DefaultCameras","front","back","OrbitControls","WebGPU","isAvailable","Error","observer","IntersectionObserver","entries","forEach","entry","visible","isIntersecting","WebGPURenderer","antialias","alpha","toneMapping","NeutralToneMapping","setPixelRatio","window","devicePixelRatio","shadowMap","_clock","Clock","_playingViewports","_time","_delta","Promise","resolve","reject","setAnimationLoop","getDelta","then","catch","log","error","IoThreeViewport","IoElement","Style","renderViewport","bind","renderTarget","CanvasTarget","document","createElement","appendChild","domElement","viewCameras","connectedCallback","observe","disconnectedCallback","unobserve","playingChanged","playing","push","splice","indexOf","rect","getBoundingClientRect","floor","setSize","appletMutated","changed","setCanvasTarget","setClearColor","clearColor","clearAlpha","clear","toneMappingExposure","render","Boolean","ioThreeViewport","arg0","vConstructor"],"mappings":"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"}