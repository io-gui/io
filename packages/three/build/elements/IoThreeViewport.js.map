{"version":3,"file":"IoThreeViewport.js","sourceRoot":"","sources":["../../src/elements/IoThreeViewport.ts"],"names":[],"mappings":"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","sourcesContent":["import { Register, IoElement, IoElementProps, ReactiveProperty, ReactivityType, Binding } from 'io-core'\nimport { WebGPURenderer, CanvasTarget, Color } from 'three/build/three.webgpu.js';\nimport WebGPU from 'three/examples/jsm/capabilities/WebGPU.js';\nimport { ThreeState } from '../nodes/ThreeState.js';\nimport { ViewCameras } from '../nodes/ViewCameras.js';\n\nif ( WebGPU.isAvailable() === false ) {\n  throw new Error( 'No WebGPU support' );\n}\n\nconst observer = new IntersectionObserver((entries) => {\n  entries.forEach(entry => {\n    (entry.target as IoThreeViewport).visible = entry.isIntersecting\n  })\n})\n\nconst _renderer = new WebGPURenderer({antialias: false, alpha: true})\n_renderer.setPixelRatio(window.devicePixelRatio)\n_renderer.init()\n\nconst _playingViewports: IoThreeViewport[] = []\n\n_renderer.setAnimationLoop((time: number) => {\n  for (const viewport of _playingViewports) {\n    viewport.onAnimate(time)\n  }\n})\n\nexport type IoThreeViewportProps = IoElementProps & {\n  state: ThreeState | Binding<ThreeState>\n  cameraSelect?: string | Binding<string>\n  playing?: boolean | Binding<boolean>\n  clearColor?: Color | Binding<Color>\n  clearAlpha?: number | Binding<number>\n}\n\n@Register\nexport class IoThreeViewport extends IoElement {\n\n  public width: number = 0\n  public height: number = 0\n  public visible: boolean = false\n\n  @ReactiveProperty({type: Number, value: 0x000000})\n  declare public clearColor: number\n\n  @ReactiveProperty({type: Number, value: 1})\n  declare public clearAlpha: number\n\n  @ReactiveProperty({type: String, value: 'throttled'})\n  declare reactivity: ReactivityType\n\n  @ReactiveProperty({type: ThreeState, init: null})\n  declare state: ThreeState\n\n  @ReactiveProperty({type: Boolean})\n  declare playing: boolean\n\n  @ReactiveProperty({type: String, value: 'perspective'})\n  declare cameraSelect: string\n\n  declare private readonly viewCameras: ViewCameras\n  declare private readonly renderTarget: CanvasTarget\n\n  static get Style() {\n    return /* css */`\n      :host {\n        position: relative;\n        display: flex;\n        flex: 1 1 auto;\n        flex-direction: column;\n        max-width: 100%;\n        max-height: 100%;\n        overflow: hidden;\n      }\n      :host > canvas {\n        position: absolute;\n      }\n    `\n  }\n\n  constructor(args: IoThreeViewportProps) {\n    super(args)\n    this.renderViewport = this.renderViewport.bind(this);\n\n    this.renderTarget = new CanvasTarget(document.createElement('canvas'))\n    this.appendChild(this.renderTarget.domElement)\n\n    this.viewCameras = new ViewCameras({viewport: this, state: this.state, cameraSelect: this.bind('cameraSelect')})\n\n    this.debounce(this.renderViewport)\n  }\n\n  connectedCallback() {\n    super.connectedCallback()\n    observer.observe(this)\n  }\n  disconnectedCallback() {\n    super.disconnectedCallback()\n    observer.unobserve(this)\n    this.visible = false\n  }\n\n  playingChanged() {\n    if (this.playing) {\n      _playingViewports.push(this)\n    } else if (_playingViewports.includes(this)) {\n      _playingViewports.splice(_playingViewports.indexOf(this), 1)\n    }\n  }\n\n  onAnimate(time: number) {\n    if (!this.visible) return\n    this.debounce(this.renderViewport)\n  }\n\n  onResized() {\n    const rect = this.getBoundingClientRect()\n    this.width = Math.floor(rect.width)\n    this.height = Math.floor(rect.height)\n    this.renderTarget.setSize(this.width, this.height)\n    this.renderTarget.setPixelRatio(window.devicePixelRatio)\n    this.viewCameras.setSize(this.width, this.height)\n    this.renderViewport()\n  }\n\n  stateChanged() {\n    this.debounce(this.renderViewport)\n  }\n  stateMutated() {\n    this.debounce(this.renderViewport)\n  }\n  changed() {\n    this.debounce(this.renderViewport)\n  }\n\n  renderViewport() {\n    if (_renderer.initialized === false) {\n      this.debounce(this.renderViewport)\n      return\n    }\n    if (this.state.isRendererInitialized() === false) {\n      this.state.onRendererInitialized(_renderer)\n    }\n    if (!this.width || !this.height) {\n      return\n    }\n    _renderer.setCanvasTarget(this.renderTarget)\n    _renderer.setClearColor(this.clearColor, this.clearAlpha)\n    _renderer.setSize(this.width, this.height)\n    _renderer.clear()\n\n    this.state.setViewportSize(this.width, this.height)\n    this.state.onAnimate()\n    _renderer.render(this.state.scene, this.viewCameras.camera)\n  }\n\n  dispose() {\n    super.dispose()\n    this.renderTarget.dispose()\n    this.viewCameras.dispose()\n  }\n}\n\nexport const ioThreeViewport = function(arg0: IoThreeViewportProps) {\n  return IoThreeViewport.vConstructor(arg0)\n}"]}