{"version":3,"file":"Storage.js","sourceRoot":"","sources":["../../src/nodes/Storage.ts"],"names":[],"mappings":"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","sourcesContent":["import { ReactiveProperty } from '../decorators/Property.js';\nimport { Register } from '../decorators/Register.js';\nimport { Binding } from '../core/Binding.js';\nimport { Node, NodeProps, AnyConstructor } from '../nodes/Node.js';\n\nclass EmulatedLocalStorage {\n  declare store: Map<string, unknown>;\n  declare warned: boolean;\n  constructor() {\n    Object.defineProperty(this, 'store', {value: new Map()});\n    Object.defineProperty(this, 'warned', {value: false, writable: true});\n  }\n  get permitted(): boolean {\n    try {\n      return self.localStorage.getItem('Storage:user-permitted') === 'true';\n    } catch (error) {\n      console.warn('Storage: Cannot access localStorage. Check browser privacy settings!');\n    }\n    return false;\n  }\n  set permitted(permitted: boolean) {\n    try {\n      if (permitted) {\n        console.info('Storage: localStorage permission granted.');\n        this.store.set('Storage:user-permitted', String(permitted));\n        this.store.forEach((value: unknown, key: string) => {\n          self.localStorage.setItem(key, String(value));\n          this.store.delete(key);\n        });\n      } else {\n        console.info('Storage: localStorage permission revoked.');\n        self.localStorage.setItem('Storage:user-permitted', String(permitted));\n        new Map(Object.entries(self.localStorage)).forEach((value: unknown, key: string) => {\n          this.store.set(key, value);\n        });\n        self.localStorage.clear();\n      }\n    } catch (error) {\n      console.warn('Storage: Cannot access localStorage. Check browser privacy settings!');\n    }\n  }\n  setItem(key: string, value: unknown) {\n    const strValue = typeof value === 'object' ? JSON.stringify(value) : String(value);\n    if (key === 'Storage:user-permitted') {\n      this.permitted = value === 'true';\n      return;\n    }\n    if (this.permitted) {\n      self.localStorage.setItem(key, strValue);\n    } else {\n      this.store.set(key, strValue);\n      if (!this.warned && !this.permitted) {\n        console.warn('Storage: localStorage permission not set.');\n        this.warned = true;\n      }\n    }\n  }\n  getItem(key: string): string | null {\n    if (this.permitted) {\n      return self.localStorage.getItem(key);\n    } else if (this.store.has(key)) {\n      return this.store.get(key) as string;\n    }\n    return null;\n  }\n  removeItem(key: string) {\n    if (this.permitted) {\n      return self.localStorage.removeItem(key);\n    } else {\n      this.store.delete(key);\n    }\n  }\n  clear() {\n    if (this.permitted) {\n      return self.localStorage.clear();\n    } else {\n      this.store.clear();\n    }\n  }\n}\n\nconst localStorage = new EmulatedLocalStorage();\n\ntype StorageNodes = {\n  local: Map<string, StorageNode>,\n  hash: Map<string, StorageNode>,\n}\n\nconst nodes: StorageNodes = {\n  local: new Map(),\n  hash: new Map(),\n};\n\nlet hashValues: Record<string, any> = {};\n\nexport type StorageProps = NodeProps & {\n  key: string,\n  value: any,\n  storage?: 'hash' | 'local',\n};\n\n@Register\nexport class StorageNode extends Node {\n\n  @ReactiveProperty({value: '', type: String})\n  declare key: string;\n\n  @ReactiveProperty()\n  declare value: any;\n\n  @ReactiveProperty({value: 'local', type: String})\n  declare storage: 'hash' | 'local';\n\n  declare binding: Binding<any>;\n\n  declare default: any;\n\n  constructor(props: StorageProps) {\n    debug: {\n      if (typeof props !== 'object') {\n        console.warn('Ivalid Storage arguments!');\n      } else {\n        if (typeof props.key !== 'string' || !props.key)\n          console.warn('Ivalid Storage key!');\n        if (props.storage && ['hash', 'local'].indexOf(props.storage) === -1)\n          console.warn('Ivalid Storage storage!');\n      }\n    }\n\n    if (props.storage === undefined) props.storage = 'local';\n    if (nodes[props.storage].has(props.key)) {\n      return nodes[props.storage].get(props.key)!;\n    } else {\n      let def: any;\n      // TODO: test!\n      let constructor: AnyConstructor | undefined;\n      if (typeof props.value === 'object' && props.value !== null) {\n        constructor = props.value.constructor as AnyConstructor;\n        def = JSON.stringify(props.value);\n      } else {\n        def = props.value;\n      }\n\n      let storedValue: string | null = null;\n      switch (props.storage) {\n        case 'hash':\n          storedValue = getValueFromHash(props.key);\n          break;\n        case 'local':\n          storedValue = localStorage.getItem('Storage:' + props.key);\n          break;\n      }\n      if (storedValue !== null) {\n        try {\n          const value = JSON.parse(storedValue);\n          props.value = constructor ? new constructor(value) : value;\n        } catch (error) {\n          props.value = storedValue;\n        }\n      }\n\n      super(props);\n\n      this.valueMutatedDebounced = this.valueMutatedDebounced.bind(this);\n\n      this.default = def;\n\n      this.binding = this.bind('value');\n      this.binding.dispose = () => {\n        this.clearStorage();\n      };\n\n      if (props.key !== '__proto__') { // TODO: Why is this here ffs?\n        nodes[props.storage].set(props.key, this);\n      }\n\n      return this;\n    }\n  }\n  dispose() {\n    this.clearStorage();\n    super.dispose();\n  }\n  clearStorage() {\n    switch (this.storage) {\n      case 'hash': {\n        this.removeValueToHash();\n        break;\n      }\n      case 'local': {\n        localStorage.removeItem('Storage:' + this.key);\n        break;\n      }\n    }\n    const s = (this.storage) as keyof StorageNodes;\n    nodes[s].delete(this.key);\n  }\n  valueMutated() {\n    this.debounce(this.valueMutatedDebounced);\n  }\n  valueMutatedDebounced() {\n    this.valueChanged();\n  }\n  valueChanged() {\n    switch (this.storage) {\n      case 'hash': {\n        this.saveValueToHash();\n        break;\n      }\n      case 'local': {\n        if (this.value === null || this.value === undefined || (this.value === this.default && typeof this.value !== 'object')) {\n          localStorage.removeItem('Storage:' + this.key);\n        } else {\n          localStorage.setItem('Storage:' + this.key, JSON.stringify(this.value));\n        }\n        break;\n      }\n    }\n  }\n  removeValueToHash() {\n    hashValues = parseHash(self.location.hash);\n    delete hashValues[this.key];\n\n    let hashString = '';\n    for (const h in hashValues) {\n      hashString += h + '=' + hashValues[h] + '&';\n    }\n    if (hashString) {\n      hashString = hashString.slice(0, -1);\n      self.location.hash = hashString;\n    } else {\n      history.replaceState('', document.title, self.location.pathname + self.location.search);\n    }\n  }\n  saveValueToHash() {\n    hashValues = parseHash(self.location.hash);\n\n    const value = this.value;\n    if (value !== undefined && value !== '' && value !== this.default) {\n      if (typeof value === 'string') {\n        if (isNaN(value as unknown as number)) {\n          hashValues[this.key] = value;\n        } else {\n          hashValues[this.key] = '\"' + value + '\"';\n        }\n      } else {\n        hashValues[this.key] = JSON.stringify(value);\n      }\n    } else {\n      delete hashValues[this.key];\n    }\n\n    let hashString = '';\n    for (const h in hashValues) {\n      hashString += h + '=' + hashValues[h] + '&';\n    }\n    if (hashString) {\n      hashString = hashString.slice(0, -1);\n      self.location.hash = hashString;\n    } else {\n      history.replaceState('', document.title, self.location.pathname + self.location.search);\n    }\n  }\n}\n\n\nexport const Storage = Object.assign(\n  (props: StorageProps) => {\n    const storageNode = new StorageNode(props);\n    return storageNode.binding;\n  }, {\n    permit() {\n      localStorage.permitted = true;\n    },\n    unpermit() {\n      localStorage.permitted = false;\n    }\n  }\n);\n\n// TODO: unhack and test\nfunction parseHash(hash: string) {\n  return hash.substring(1).split('&').reduce(function (result: Record<string, string>, item) {\n    const parts = item.split('=');\n    if (parts[0] && parts[1]) {\n      result[parts[0]] = parts[1].replace(/%22/g, '\"').replace(/%20/g, ' ');\n    }\n    return result;\n  }, {});\n}\n\nfunction getValueFromHash(key: string) {\n  hashValues = parseHash(self.location.hash);\n  return hashValues[key] || null;\n}\n\nfunction updateAllFromHash() {\n  hashValues = parseHash(self.location.hash);\n  for (const h in hashValues) {\n    if (nodes.hash.has(h)) {\n      const node = nodes.hash.get(h) as StorageNode;\n      try {\n        node.value = JSON.parse(hashValues[h]);\n      } catch (error) {\n        node.value = hashValues[h];\n      }\n    }\n  }\n\n  for (const [key, node] of nodes.hash.entries()) {\n    if (hashValues[key] === undefined) {\n      node.value = node.default;\n    }\n  }\n}\n\nself.addEventListener('hashchange', updateAllFromHash, false);\nupdateAllFromHash();\n"]}