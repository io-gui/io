{"version":3,"file":"NodeArray.js","sourceRoot":"","sources":["../../src/core/NodeArray.ts"],"names":[],"mappings":"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","sourcesContent":["import { Node } from '../nodes/Node.js'\nimport { IoElement } from '../elements/IoElement.js'\n\n// TODO: test!!!\nexport class NodeArray<N extends Node> extends Array<N> {\n  declare private proxy: typeof Proxy\n  private _isInternalOperation = false\n\n  static get [Symbol.species]() { return Array }\n\n  constructor(public node: Node | IoElement, ...args: any[]) {\n    super(...args)\n    // TODO: Avoid creating empty NodeArrays in models!\n    // TODO: Test thoroughly! Check initializations with items!\n    // console.log('NodeArray constructor', args);\n    this.itemMutated = this.itemMutated.bind(this)\n    this.dispatchMutation = this.dispatchMutation.bind(this)\n\n    debug: if (!(node as Node)._isNode && !(node as IoElement)._isIoElement) {\n      console.error('NodeArray constructor called with non-node!')\n    }\n\n    const self = this\n    const proxy = new Proxy(this, {\n      get(target: NodeArray<N>, property: string | symbol) {\n        if (typeof property === 'symbol') {\n          return target[property as any]\n        }\n        const index = Number(property)\n        if (!isNaN(index) && index >= 0) {\n          return target[index]\n        }\n        return target[property as any]\n      },\n      set(target: NodeArray<N>, property: string | symbol, value: any) {\n        if (property === 'length') {\n          if (!self._isInternalOperation) {\n            const oldLength = target.length\n            const newLength = Number(value)\n            if (newLength < oldLength) {\n              for (let i = newLength; i < oldLength; i++) {\n                const item = target[i]\n                if (item._isNode) {\n                  item.removeEventListener('io-object-mutation', self.itemMutated)\n                  item.removeParent(self.node as Node)\n                }\n              }\n            } else if (newLength > oldLength) {\n              console.warn('NodeArray: cannot extend array with empty slots')\n              return true\n            }\n          }\n          target[property] = value\n          if (!self._isInternalOperation) self.dispatchMutation()\n          return true\n        }\n        const index = Number(property)\n        if (!isNaN(index) && index >= 0) {\n          // TODO Prevent adding to index greater than length?\n          const oldValue = target[index]\n          if (oldValue !== undefined && oldValue._isNode && !self._isInternalOperation) {\n            oldValue.removeEventListener('io-object-mutation', self.itemMutated)\n            oldValue.removeParent(self.node as Node)\n          }\n          target[property as any] = value\n          if (value._isNode && !self._isInternalOperation) {\n            value.addEventListener('io-object-mutation', self.itemMutated)\n            value.addParent(self.node)\n          }\n          if (!self._isInternalOperation) self.dispatchMutation()\n          return true\n        }\n        target[property as any] = value\n        return true\n      }\n    })\n    Object.defineProperty(this, 'proxy', {value: proxy, enumerable: false, configurable: false})\n    return proxy\n  }\n  // TODO: test!\n  withInternalOperation<T>(operation: () => T): T {\n    this._isInternalOperation = true\n    try {\n      return operation()\n    } finally {\n      this._isInternalOperation = false\n    }\n  }\n  splice(start: number, deleteCount: number, ...items: N[]): N[] {\n    return this.withInternalOperation(() => {\n      for (let i = start; i < start + deleteCount; i++) {\n        const item = this[i]\n        if (item._isNode) {\n          item.removeEventListener('io-object-mutation', this.itemMutated)\n          item.removeParent(this.node as Node)\n        }\n      }\n      const result = super.splice(start, deleteCount, ...items)\n      for (let i = start; i < start + items.length; i++) {\n        const item = this[i]\n        if (item._isNode) {\n          item.addEventListener('io-object-mutation', this.itemMutated)\n          item.addParent(this.node as Node)\n        }\n      }\n      if (deleteCount || items.length) this.dispatchMutation()\n      return result\n    })\n  }\n  push(...items: N[]): number {\n    return this.withInternalOperation(() => {\n      const result = super.push(...items)\n      for (const item of items) {\n        if (item._isNode) {\n          item.addEventListener('io-object-mutation', this.itemMutated)\n          item.addParent(this.node as Node)\n        }\n      }\n      if (items.length) this.dispatchMutation()\n      return result\n    })\n  }\n  unshift(...items: N[]): number {\n    return this.withInternalOperation(() => {\n      const result = super.unshift(...items)\n      for (const item of items) {\n        if (item._isNode) {\n          item.addEventListener('io-object-mutation', this.itemMutated)\n          item.addParent(this.node as Node)\n        }\n      }\n      if (items.length) this.dispatchMutation()\n      return result\n    })\n  }\n  pop(): N | undefined {\n    return this.withInternalOperation(() => {\n      const item = super.pop()\n      if (item !== undefined && item._isNode) {\n        item.removeEventListener('io-object-mutation', this.itemMutated)\n        item.removeParent(this.node as Node)\n      }\n      if (item !== undefined) this.dispatchMutation()\n      return item\n    })\n  }\n  shift(): N | undefined {\n    return this.withInternalOperation(() => {\n      const item = super.shift()\n      if (item !== undefined && item._isNode) {\n        item.removeEventListener('io-object-mutation', this.itemMutated)\n        item.removeParent(this.node as Node)\n      }\n      if (item !== undefined) this.dispatchMutation()\n      return item\n    })\n  }\n  reverse() {\n    return this.withInternalOperation(() => {\n      const result = super.reverse()\n      if (result.length) this.dispatchMutation()\n      return result\n    })\n  }\n  sort(compareFn?: (a: N, b: N) => number) {\n    return this.withInternalOperation(() => {\n      const result = super.sort(compareFn)\n      if (result.length) this.dispatchMutation()\n      return result\n    })\n  }\n  fill() {\n    console.warn('NodeArray: fill is not supported')\n    return this\n  }\n  copyWithin() {\n    console.warn('NodeArray: copyWithin is not supported')\n    return this\n  }\n  itemMutated(event: CustomEvent) {\n    this.node.dispatch('io-object-mutation', {object: this.proxy}, false, window)\n  }\n  dispatchMutation() {\n    this.node.dispatch('io-object-mutation', {object: this.proxy}, false, window)\n  }\n}"]}