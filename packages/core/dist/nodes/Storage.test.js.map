{"version":3,"file":"Storage.test.js","sourceRoot":"","sources":["../../src/nodes/Storage.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { StorageNode, Storage, Binding } from '@io-gui/core'\n\nasync function afterHashChange(): Promise<void> {\n  return new Promise((resolve) => {\n    self.addEventListener('hashchange', () => {\n      resolve()\n    }, { once: true })\n  })\n}\n\nlocalStorage.removeItem('Storage:test2')\nlocalStorage.removeItem('Storage:test3')\nlocalStorage.removeItem('Storage:test4')\nlocalStorage.removeItem('Storage:test5')\n\nconst permited = localStorage.getItem('Storage:user-permitted')\n\nlocalStorage.setItem('Storage:user-permitted', 'true')\n\nexport default class {\n  run() {\n    describe('Storage.test.ts', () => {\n      it('Should register property definitions correctly', () => {\n        const node = new StorageNode({key: 'test', value: 'foo'})\n        expect(node.key).to.be.equal('test')\n        expect(node.value).to.be.equal('foo')\n        expect(node.storage).to.be.equal('local')\n\n        expect(node._reactiveProperties.get('key')).to.eql({\n          binding: undefined,\n          reflect: false,\n          init: undefined,\n          type: String,\n          value: 'test',\n        })\n\n        expect(node._reactiveProperties.get('value')).to.eql({\n          binding: undefined,\n          reflect: false,\n          init: undefined,\n          type: undefined,\n          value: 'foo',\n        })\n\n        expect(node._reactiveProperties.get('storage')).to.eql({\n          binding: undefined,\n          reflect: false,\n          init: undefined,\n          type: String,\n          value: 'local',\n        })\n        node.dispose()\n      })\n      it('Should initialize property value from localStorage store if exists', () => {\n        localStorage.setItem('Storage:test2', '\"asd\"')\n        const node = new StorageNode({key: 'test2', value: 'buzz', storage: 'local'})\n        expect(node.key).to.be.equal('test2')\n        expect(node.value).to.be.equal('asd')\n        expect(node.default).to.be.equal('buzz')\n        expect(node.storage).to.be.equal('local')\n        node.dispose()\n      })\n      it('Should initialize property value from location.hash store if exists', async () => {\n        self.location.hash = self.location.hash + '&testhash=foo'\n        const node = new StorageNode({key: 'testhash', value: 'buzz', storage: 'hash'})\n        expect(node.key).to.be.equal('testhash')\n        expect(node.value).to.be.equal('foo')\n        expect(node.default).to.be.equal('buzz')\n        expect(node.storage).to.be.equal('hash')\n        node.dispose()\n      })\n      it('Should return a new instance only if key and store are unique', () => {\n        const node1 = new StorageNode({key: 'test3', value: ''})\n        const node2 = new StorageNode({key: 'test3', value: ''})\n        expect(node1).to.be.equal(node2)\n        node1.dispose()\n      })\n      it('Should update localStorage store when value changes', () => {\n        const node = new StorageNode({key: 'test5', value: 'one', storage: 'local'})\n        expect(localStorage.getItem('Storage:test5')).to.be.equal('\"one\"')\n        node.value = 'two'\n        expect(localStorage.getItem('Storage:test5')).to.be.equal('\"two\"')\n        node.value = '2'\n        expect(localStorage.getItem('Storage:test5')).to.be.equal('\"2\"')\n        node.value = 2\n        expect(localStorage.getItem('Storage:test5')).to.be.equal('2')\n        node.value = 'one'\n        expect(localStorage.getItem('Storage:test5')).to.be.equal(null)\n        node.dispose()\n      })\n      it('Should update location.hash store when value changes to non-default', async () => {\n        const node = new StorageNode({key: 'test6', value: 'one', storage: 'hash'})\n        node.value = 'two'\n        expect(self.location.hash).to.include('test6=two')\n        node.value = '2'\n        expect(self.location.hash).to.include('test6=%222%22')\n        node.value = true\n        expect(self.location.hash).to.include('test6=true')\n        node.value = 2\n        expect(self.location.hash).to.include('test6=2')\n        self.location.hash = self.location.hash.replace('test6=2', 'test6=3')\n\n        await afterHashChange()\n\n        expect(node.value).to.be.equal(3)\n\n        self.location.hash = self.location.hash.replace('test6=3', 'test6=\"3\"')\n\n        await afterHashChange()\n\n        expect(node.value).to.be.equal('3')\n\n        self.location.hash = self.location.hash.replace('test6=%223%22', 'test6=false')\n\n        await afterHashChange()\n\n        expect(node.value).to.be.equal(false)\n\n        node.value = [0,1,2]\n        expect(self.location.hash).to.include('test6=[0,1,2]')\n        node.value = [0,1,'2']\n        expect(self.location.hash).to.include('test6=[0,1,%222%22]')\n        node.value = '2'\n        expect(self.location.hash).to.include('test6=%222%22')\n\n        node.dispose()\n\n        if (!permited || permited === 'false') localStorage.setItem('Storage:user-permitted', 'false')\n      })\n      it('Storage should return binding to StorageNode Node', () => {\n        const storage = Storage({key: 'test', value: ''})\n        storage.value = 'foo'\n        expect(storage).to.be.instanceOf(Binding)\n        storage.dispose()\n        expect(self.location.hash).to.not.include('test=foo')\n      })\n    })\n  }\n}\n"]}