{"version":3,"file":"Storage.test.js","sourceRoot":"","sources":["../../src/nodes/Storage.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, it, expect } from 'vitest'\nimport { StorageNode, Storage, Binding } from '@io-gui/core'\n\nasync function afterHashChange(): Promise<void> {\n  return new Promise((resolve) => {\n    self.addEventListener('hashchange', () => {\n      resolve()\n    }, { once: true })\n  })\n}\n\nlocalStorage.removeItem('Storage:test2')\nlocalStorage.removeItem('Storage:test3')\nlocalStorage.removeItem('Storage:test4')\nlocalStorage.removeItem('Storage:test5')\n\nconst permited = localStorage.getItem('Storage:user-permitted')\n\nlocalStorage.setItem('Storage:user-permitted', 'true')\n\ndescribe('Storage.test.ts', () => {\n  it('Should register property definitions correctly', () => {\n    const node = new StorageNode({key: 'test', value: 'foo'})\n    expect(node.key).toBe('test')\n    expect(node.value).toBe('foo')\n    expect(node.storage).toBe('local')\n\n    expect(node._reactiveProperties.get('key')).toEqual({\n      binding: undefined,\n      reflect: false,\n      init: undefined,\n      type: String,\n      value: 'test',\n      observer: {type: 'none', observing: false},\n    })\n\n    expect(node._reactiveProperties.get('value')).toEqual({\n      binding: undefined,\n      reflect: false,\n      init: undefined,\n      type: undefined,\n      value: 'foo',\n      observer: {type: 'none', observing: false},\n    })\n\n    expect(node._reactiveProperties.get('storage')).toEqual({\n      binding: undefined,\n      reflect: false,\n      init: undefined,\n      type: String,\n      value: 'local',\n      observer: {type: 'none', observing: false},\n    })\n    node.dispose()\n  })\n  it('Should initialize property value from localStorage store if exists', async () => {\n    localStorage.setItem('Storage:test2', '\"asd\"')\n    const node = new StorageNode({key: 'test2', value: 'buzz', storage: 'local'})\n    expect(node.key).toBe('test2')\n    expect(node.value).toBe('asd')\n    expect(node.default).toBe('buzz')\n    expect(node.storage).toBe('local')\n    node.dispose()\n  })\n  it('Should initialize property value from location.hash store if exists', async () => {\n    self.location.hash = self.location.hash + '&testhash=foo'\n    const node = new StorageNode({key: 'testhash', value: 'buzz', storage: 'hash'})\n    expect(node.key).toBe('testhash')\n    expect(node.value).toBe('foo')\n    expect(node.default).toBe('buzz')\n    expect(node.storage).toBe('hash')\n    node.dispose()\n  })\n  it('Should return a new instance only if key and store are unique', () => {\n    const node1 = new StorageNode({key: 'test3', value: ''})\n    const node2 = new StorageNode({key: 'test3', value: ''})\n    expect(node1).toBe(node2)\n    node1.dispose()\n  })\n  it('Should update localStorage store when value changes', async () => {\n    localStorage.removeItem('Storage:test5')\n    const node = new StorageNode({key: 'test5', value: 'one', storage: 'local'})\n    expect(localStorage.getItem('Storage:test5')).toBe(null)\n    node.value = 'two'\n    expect(localStorage.getItem('Storage:test5')).toBe('\"two\"')\n    node.value = '2'\n    expect(localStorage.getItem('Storage:test5')).toBe('\"2\"')\n    node.value = 2\n    expect(localStorage.getItem('Storage:test5')).toBe('2')\n    node.value = 'one'\n    expect(localStorage.getItem('Storage:test5')).toBe(null)\n    node.dispose()\n  })\n  it('Should update location.hash store when value changes to non-default', async () => {\n    const node = new StorageNode({key: 'test6', value: 'one', storage: 'hash'})\n    node.value = 'two'\n    expect(self.location.hash).toContain('test6=two')\n    node.value = '2'\n    expect(self.location.hash).toContain('test6=%222%22')\n    node.value = true\n    expect(self.location.hash).toContain('test6=true')\n    node.value = 2\n    expect(self.location.hash).toContain('test6=2')\n    self.location.hash = self.location.hash.replace('test6=2', 'test6=3')\n\n    await afterHashChange()\n\n    expect(node.value).toBe(3)\n\n    self.location.hash = self.location.hash.replace('test6=3', 'test6=\"3\"')\n\n    await afterHashChange()\n\n    expect(node.value).toBe('3')\n\n    self.location.hash = self.location.hash.replace('test6=%223%22', 'test6=false')\n\n    await afterHashChange()\n\n    expect(node.value).toBe(false)\n\n    node.value = 'one'\n    expect(self.location.hash).not.toContain('test6')\n    node.value = [0,1,2]\n    expect(self.location.hash).not.toContain('test6')\n    node.value = {a: 1}\n    expect(self.location.hash).not.toContain('test6')\n    node.value = '2'\n    expect(self.location.hash).toContain('test6=%222%22')\n\n    node.dispose()\n\n    if (!permited || permited === 'false') localStorage.setItem('Storage:user-permitted', 'false')\n  })\n  it('Storage should return binding to StorageNode', () => {\n    const storage = Storage({key: 'test', value: ''})\n    storage.value = 'foo'\n    expect(storage).toBeInstanceOf(Binding)\n    storage.dispose()\n    expect(self.location.hash).not.toContain('test=foo')\n  })\n})\n"]}