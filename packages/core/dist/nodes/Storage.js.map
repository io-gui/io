{"version":3,"file":"Storage.js","sourceRoot":"","sources":["../../src/nodes/Storage.ts"],"names":[],"mappings":"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","sourcesContent":["import { ReactiveProperty } from '../decorators/Property.js'\nimport { Register } from '../decorators/Register.js'\nimport { Binding } from '../core/Binding.js'\nimport { Node, NodeProps, AnyConstructor } from '../nodes/Node.js'\n\nclass EmulatedLocalStorage {\n  declare store: Map<string, unknown>\n  declare warned: boolean\n  constructor() {\n    Object.defineProperty(this, 'store', {value: new Map()})\n    Object.defineProperty(this, 'warned', {value: false, writable: true})\n  }\n  get permitted(): boolean {\n    try {\n      return self.localStorage.getItem('Storage:user-permitted') === 'true'\n    } catch (error) {\n      console.warn('Storage: Cannot access localStorage. Check browser privacy settings!')\n      console.warn(error)\n    }\n    return false\n  }\n  set permitted(permitted: boolean) {\n    try {\n      if (permitted) {\n        console.info('Storage: localStorage permission granted.')\n        this.store.set('Storage:user-permitted', String(permitted))\n        this.store.forEach((value: unknown, key: string) => {\n          self.localStorage.setItem(key, String(value))\n          this.store.delete(key)\n        })\n      } else {\n        console.info('Storage: localStorage permission revoked.')\n        self.localStorage.setItem('Storage:user-permitted', String(permitted))\n        new Map(Object.entries(self.localStorage)).forEach((value: unknown, key: string) => {\n          this.store.set(key, value)\n        })\n        self.localStorage.clear()\n      }\n    } catch (error) {\n      console.warn('Storage: Cannot access localStorage. Check browser privacy settings!')\n      console.warn(error)\n    }\n  }\n  setItem(key: string, value: unknown) {\n    const strValue = typeof value === 'object' ? JSON.stringify(value) : String(value)\n    if (key === 'Storage:user-permitted') {\n      this.permitted = value === 'true'\n      return\n    }\n    if (this.permitted) {\n      self.localStorage.setItem(key, strValue)\n    } else {\n      this.store.set(key, strValue)\n      if (!this.warned && !this.permitted) {\n        console.warn('Storage: localStorage permission not set.')\n        this.warned = true\n      }\n    }\n  }\n  getItem(key: string): string | null {\n    if (this.permitted) {\n      return self.localStorage.getItem(key)\n    } else if (this.store.has(key)) {\n      return this.store.get(key) as string\n    }\n    return null\n  }\n  removeItem(key: string) {\n    if (this.permitted) {\n      return self.localStorage.removeItem(key)\n    } else {\n      this.store.delete(key)\n    }\n  }\n  clear() {\n    if (this.permitted) {\n      return self.localStorage.clear()\n    } else {\n      this.store.clear()\n    }\n  }\n}\n\nconst localStorage = new EmulatedLocalStorage()\n\ntype StorageNodes = {\n  local: Map<string, StorageNode>\n  hash: Map<string, StorageNode>\n}\n\nconst nodes: StorageNodes = {\n  local: new Map(),\n  hash: new Map(),\n}\n\nlet hashValues: Record<string, any> = {}\n\nexport type StorageProps = NodeProps & {\n  key: string\n  value: any\n  storage?: 'hash' | 'local'\n}\n\n@Register\nexport class StorageNode extends Node {\n\n  @ReactiveProperty({value: '', type: String})\n  declare key: string\n\n  @ReactiveProperty()\n  declare value: any\n\n  @ReactiveProperty({value: 'local', type: String})\n  declare storage: 'hash' | 'local'\n\n  declare binding: Binding<any>\n\n  declare default: any\n\n  constructor(props: StorageProps) {\n    debug: {\n      if (typeof props !== 'object') {\n        console.warn('Ivalid Storage arguments!')\n      } else {\n        if (typeof props.key !== 'string' || !props.key)\n          console.warn('Ivalid Storage key!')\n        if (props.storage && ['hash', 'local'].indexOf(props.storage) === -1)\n          console.warn('Ivalid Storage storage!')\n      }\n    }\n\n    if (props.storage === undefined) props.storage = 'local'\n    if (nodes[props.storage].has(props.key)) {\n      return nodes[props.storage].get(props.key)!\n    } else {\n      let def: any\n      // TODO: test!\n      let constructor: AnyConstructor | undefined\n      if (typeof props.value === 'object' && props.value !== null) {\n        constructor = props.value.constructor as AnyConstructor\n        def = JSON.stringify(props.value)\n      } else {\n        def = props.value\n      }\n\n      let storedValue: string | null = null\n      switch (props.storage) {\n        case 'hash':\n          storedValue = getValueFromHash(props.key)\n          break\n        case 'local':\n          storedValue = localStorage.getItem('Storage:' + props.key)\n          break\n      }\n      if (storedValue !== null) {\n        try {\n          const value = JSON.parse(storedValue)\n          props.value = constructor ? new constructor(value) : value\n        } catch {\n          props.value = storedValue\n        }\n      }\n\n      super(props)\n\n      this.valueMutatedDebounced = this.valueMutatedDebounced.bind(this)\n\n      this.default = def\n\n      this.binding = this.bind('value')\n      this.binding.dispose = () => {\n        this.clearStorage()\n      }\n\n      if (props.key !== '__proto__') { // TODO: Why is this here ffs?\n        nodes[props.storage].set(props.key, this)\n      }\n\n      return this\n    }\n  }\n  dispose() {\n    this.clearStorage()\n    super.dispose()\n  }\n  clearStorage() {\n    switch (this.storage) {\n      case 'hash': {\n        this.removeValueToHash()\n        break\n      }\n      case 'local': {\n        localStorage.removeItem('Storage:' + this.key)\n        break\n      }\n    }\n    const s = (this.storage) as keyof StorageNodes\n    nodes[s].delete(this.key)\n  }\n  valueMutated() {\n    this.debounce(this.valueMutatedDebounced)\n  }\n  valueMutatedDebounced() {\n    this.valueChanged()\n  }\n  valueChanged() {\n    switch (this.storage) {\n      case 'hash': {\n        this.saveValueToHash()\n        break\n      }\n      case 'local': {\n        if (this.value === null || this.value === undefined || (this.value === this.default && typeof this.value !== 'object')) {\n          localStorage.removeItem('Storage:' + this.key)\n        } else {\n          localStorage.setItem('Storage:' + this.key, JSON.stringify(this.value))\n        }\n        break\n      }\n    }\n  }\n  removeValueToHash() {\n    hashValues = parseHash(self.location.hash)\n    delete hashValues[this.key]\n\n    let hashString = ''\n    for (const h in hashValues) {\n      hashString += h + '=' + hashValues[h] + '&'\n    }\n    if (hashString) {\n      hashString = hashString.slice(0, -1)\n      self.location.hash = hashString\n    } else {\n      history.replaceState('', document.title, self.location.pathname + self.location.search)\n    }\n  }\n  saveValueToHash() {\n    hashValues = parseHash(self.location.hash)\n\n    const value = this.value\n    if (value !== undefined && value !== '' && value !== this.default) {\n      if (typeof value === 'string') {\n        if (isNaN(value as unknown as number)) {\n          hashValues[this.key] = value\n        } else {\n          hashValues[this.key] = '\"' + value + '\"'\n        }\n      } else {\n        hashValues[this.key] = JSON.stringify(value)\n      }\n    } else {\n      delete hashValues[this.key]\n    }\n\n    let hashString = ''\n    for (const h in hashValues) {\n      hashString += h + '=' + hashValues[h] + '&'\n    }\n    if (hashString) {\n      hashString = hashString.slice(0, -1)\n      self.location.hash = hashString\n    } else {\n      history.replaceState('', document.title, self.location.pathname + self.location.search)\n    }\n  }\n}\n\n\nexport const Storage = Object.assign(\n  (props: StorageProps) => {\n    const storageNode = new StorageNode(props)\n    return storageNode.binding\n  }, {\n    permit() {\n      localStorage.permitted = true\n    },\n    unpermit() {\n      localStorage.permitted = false\n    }\n  }\n)\n\n// TODO: unhack and test\nfunction parseHash(hash: string) {\n  return hash.substring(1).split('&').reduce(function (result: Record<string, string>, item) {\n    const parts = item.split('=')\n    if (parts[0] && parts[1]) {\n      result[parts[0]] = parts[1].replace(/%22/g, '\"').replace(/%20/g, ' ')\n    }\n    return result\n  }, {})\n}\n\nfunction getValueFromHash(key: string) {\n  hashValues = parseHash(self.location.hash)\n  return hashValues[key] || null\n}\n\nfunction updateAllFromHash() {\n  hashValues = parseHash(self.location.hash)\n  for (const h in hashValues) {\n    if (nodes.hash.has(h)) {\n      const node = nodes.hash.get(h) as StorageNode\n      try {\n        node.value = JSON.parse(hashValues[h])\n      } catch {\n        node.value = hashValues[h]\n      }\n    }\n  }\n\n  for (const [key, node] of nodes.hash.entries()) {\n    if (hashValues[key] === undefined) {\n      node.value = node.default\n    }\n  }\n}\n\nself.addEventListener('hashchange', updateAllFromHash, false)\nupdateAllFromHash()\n"]}