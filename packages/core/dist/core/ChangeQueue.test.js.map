{"version":3,"file":"ChangeQueue.test.js","sourceRoot":"","sources":["../../src/core/ChangeQueue.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, it, expect, vi } from 'vitest'\nimport { ChangeQueue, Change, Node, Register } from '@io-gui/core'\n\n@Register\nclass MockNode extends Node {\n  eventStack: string[] = []\n  changeStack: string[] = []\n  prop1Changed(change: Change) {\n    this.changeStack.push(`prop1Changed ${change.property} ${change.value} ${change.oldValue}`)\n  }\n  prop2Changed(change: Change) {\n    this.changeStack.push(`prop2Changed ${change.property} ${change.value} ${change.oldValue}`)\n  }\n  dispatch(eventName: string, change?: Change) {\n    if (change && change.property) {\n      this.eventStack.push(`${eventName} ${change.property} ${change.value} ${change.oldValue}`)\n    } else {\n      this.eventStack.push(`${eventName}`)\n    }\n  }\n  changed() {\n    this.changeStack.push('changed')\n  }\n}\n\n@Register\nclass MockNodeWithThrowingHandler extends Node {\n  changeStack: string[] = []\n  prop1Changed() {\n    throw new Error('Intentional error in prop1Changed')\n  }\n  prop2Changed(change: Change) {\n    this.changeStack.push(`prop2Changed ${change.property} ${change.value} ${change.oldValue}`)\n  }\n  dispatch() {}\n  changed() {\n    this.changeStack.push('changed')\n  }\n}\n\n@Register\nclass MockNodeWithThrowingChanged extends Node {\n  changeStack: string[] = []\n  prop1Changed(change: Change) {\n    this.changeStack.push(`prop1Changed ${change.property} ${change.value} ${change.oldValue}`)\n  }\n  dispatch() {}\n  changed() {\n    throw new Error('Intentional error in changed')\n  }\n}\n\n@Register\nclass MockNodeWithCascadingChanges extends Node {\n  changeStack: string[] = []\n  prop1Changed(change: Change) {\n    this.changeStack.push(`prop1Changed ${change.value}`)\n    // Cascading change: prop1 changing triggers prop2 change\n    if (change.value === 1) {\n      this._changeQueue.queue('prop2', 'cascaded', '')\n    }\n  }\n  prop2Changed(change: Change) {\n    this.changeStack.push(`prop2Changed ${change.value}`)\n    // Further cascade: prop2 changing triggers prop3 change\n    if (change.value === 'cascaded') {\n      this._changeQueue.queue('prop3', 'final', '')\n    }\n  }\n  prop3Changed(change: Change) {\n    this.changeStack.push(`prop3Changed ${change.value}`)\n  }\n  dispatch() {}\n  changed() {\n    this.changeStack.push('changed')\n  }\n}\n\ndescribe('ChangeQueue', () => {\n  it('Should initialize with correct default values', () => {\n    const node = new MockNode()\n    const changeQueue = new ChangeQueue(node)\n    expect(changeQueue.node).toBe(node)\n    expect(JSON.stringify(changeQueue.changes)).toBe('[]')\n    expect(changeQueue.changes.length).toBe(0)\n    expect(changeQueue.dispatching).toBe(false)\n  })\n  it('Should keep track of changes correctly', () => {\n    const node = new MockNode()\n    const changeQueue = new ChangeQueue(node)\n    changeQueue.queue('prop1', 1, 0)\n    changeQueue.queue('prop1', 2, 1)\n    expect(JSON.stringify(changeQueue.changes)).toBe('[{\"property\":\"prop1\",\"value\":2,\"oldValue\":0}]')\n    changeQueue.dispatch()\n    expect(JSON.stringify(changeQueue.changes)).toBe('[]')\n  })\n  it('Should dispatch change events with correct payloads', () => {\n    const node = new MockNode()\n    const changeQueue = new ChangeQueue(node)\n    changeQueue.queue('prop1', 1, 0)\n    changeQueue.queue('prop1', 2, 1)\n    changeQueue.dispatch()\n    expect(JSON.stringify(node.eventStack)).toBe('[\"prop1-changed prop1 2 0\",\"io-object-mutation\"]')\n  })\n  it('Should invoke handler functions with correct payloads', () => {\n    const node = new MockNode()\n    const changeQueue = new ChangeQueue(node)\n    changeQueue.queue('prop1', 1, 0)\n    changeQueue.queue('prop1', 2, 1)\n    changeQueue.dispatch()\n    expect(JSON.stringify(node.changeStack)).toBe('[\"prop1Changed prop1 2 0\",\"changed\"]')\n  })\n  it('Should handle changes in first-in, first-out (FIFO) order', () => {\n    const node = new MockNode()\n    const changeQueue = new ChangeQueue(node)\n    changeQueue.queue('prop1', 1, 0)\n    changeQueue.queue('prop1', 3, 1)\n    changeQueue.queue('prop2', 2, 0)\n    changeQueue.dispatch()\n    expect(JSON.stringify(node.changeStack)).toBe('[\"prop1Changed prop1 3 0\",\"prop2Changed prop2 2 0\",\"changed\"]')\n    expect(JSON.stringify(node.eventStack)).toBe('[\"prop1-changed prop1 3 0\",\"prop2-changed prop2 2 0\",\"io-object-mutation\"]')\n  })\n  it('Setting new value to the same value as oldValue should not trigger change event', () => {\n    const node = new MockNode()\n    const changeQueue = new ChangeQueue(node)\n    changeQueue.queue('prop1', 1, 0)\n    expect(JSON.stringify(changeQueue.changes)).toBe('[{\"property\":\"prop1\",\"value\":1,\"oldValue\":0}]')\n    changeQueue.queue('prop1', 0, 1)\n    expect(JSON.stringify(changeQueue.changes)).toBe('[]')\n    changeQueue.dispatch()\n    expect(JSON.stringify(node.changeStack)).toBe('[]')\n    expect(JSON.stringify(node.eventStack)).toBe('[]')\n  })\n  it('Should skip dispatch if value is same as oldValue', () => {\n    const node = new MockNode()\n    const changeQueue = new ChangeQueue(node)\n    changeQueue.queue('prop1', 0, 0)\n    changeQueue.dispatch()\n    expect(node.changeStack).toEqual([])\n    expect(node.eventStack).toEqual([])\n  })\n  it('Should dispose correctly', () => {\n    const node = new MockNode()\n    const changeQueue = new ChangeQueue(node)\n    changeQueue.dispose()\n    expect(changeQueue.node).toBe(undefined)\n    expect(changeQueue.changes).toBe(undefined)\n  })\n  it('Should continue processing when a property handler throws an error', () => {\n    const node = new MockNodeWithThrowingHandler()\n    const changeQueue = new ChangeQueue(node)\n    const consoleSpy = vi.spyOn(console, 'error').mockImplementation(() => {})\n\n    changeQueue.queue('prop1', 1, 0)\n    changeQueue.queue('prop2', 2, 0)\n    changeQueue.dispatch()\n\n    // prop1Changed throws, but prop2Changed and changed() should still run\n    expect(node.changeStack).toEqual(['prop2Changed prop2 2 0', 'changed'])\n    // dispatching flag should be reset\n    expect(changeQueue.dispatching).toBe(false)\n    // Error should have been logged\n    expect(consoleSpy).toHaveBeenCalledWith(\n      'Error in MockNodeWithThrowingHandler.prop1Changed():',\n      expect.any(Error)\n    )\n\n    consoleSpy.mockRestore()\n  })\n  it('Should reset dispatching flag when changed() throws an error', () => {\n    const node = new MockNodeWithThrowingChanged()\n    const changeQueue = new ChangeQueue(node)\n    const consoleSpy = vi.spyOn(console, 'error').mockImplementation(() => {})\n\n    changeQueue.queue('prop1', 1, 0)\n    changeQueue.dispatch()\n\n    // prop1Changed should have run\n    expect(node.changeStack).toEqual(['prop1Changed prop1 1 0'])\n    // dispatching flag should be reset even though changed() threw\n    expect(changeQueue.dispatching).toBe(false)\n    // Error should have been logged\n    expect(consoleSpy).toHaveBeenCalledWith(\n      'Error in MockNodeWithThrowingChanged.changed():',\n      expect.any(Error)\n    )\n\n    consoleSpy.mockRestore()\n  })\n  it('Should allow subsequent dispatches after a handler error', () => {\n    const node = new MockNodeWithThrowingHandler()\n    const changeQueue = new ChangeQueue(node)\n    const consoleSpy = vi.spyOn(console, 'error').mockImplementation(() => {})\n\n    // First dispatch with error\n    changeQueue.queue('prop1', 1, 0)\n    changeQueue.dispatch()\n\n    // Reset for next test\n    node.changeStack = []\n\n    // Second dispatch should work normally\n    changeQueue.queue('prop2', 3, 0)\n    changeQueue.dispatch()\n\n    expect(node.changeStack).toEqual(['prop2Changed prop2 3 0', 'changed'])\n\n    consoleSpy.mockRestore()\n  })\n  it('Should process cascading changes added during dispatch in the same cycle', () => {\n    const node = new MockNodeWithCascadingChanges()\n    // Use the node's own _changeQueue so cascading queue() calls go to the same queue\n    const changeQueue = node._changeQueue\n\n    // Queue initial change\n    changeQueue.queue('prop1', 1, 0)\n    changeQueue.dispatch()\n\n    // All cascading changes should have been processed in the same dispatch cycle:\n    // 1. prop1Changed(1) → queues prop2\n    // 2. prop2Changed('cascaded') → queues prop3\n    // 3. prop3Changed('final')\n    // 4. changed() called once at the end\n    expect(node.changeStack).toEqual([\n      'prop1Changed 1',\n      'prop2Changed cascaded',\n      'prop3Changed final',\n      'changed'\n    ])\n\n    // Queue should be empty after dispatch\n    expect(changeQueue.changes.length).toBe(0)\n  })\n})\n"]}