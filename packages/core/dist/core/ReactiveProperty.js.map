{"version":3,"file":"ReactiveProperty.js","sourceRoot":"","sources":["../../src/core/ReactiveProperty.ts"],"names":[],"mappings":"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","sourcesContent":["import { Binding } from './Binding.js'\nimport { AnyConstructor, Node } from '../nodes/Node.js'\nimport { IoElement } from '../elements/IoElement.js'\nimport { NodeArray } from '../core/NodeArray.js'\n\n/**\n * Configuration for a property of an Node class.\n * @typedef {Object} ReactivePropertyDefinition\n * @property {*} [value] The property's value. Can be any type unless `type` is specified.\n * @property {AnyConstructor} [type] Constructor function defining the property's type.\n * @property {Binding} [binding] Binding object for two-way data synchronization.\n * @property {boolean} [reflect] Whether to reflect the property to an HTML attribute.\n * @property {*} [init] Initialization arguments for constructing initial value.\n */\nexport type ReactivePropertyDefinition= {\n  value?: any\n  type?: AnyConstructor\n  binding?: Binding\n  reflect?: boolean\n  init?: any\n}\n\n/**\n * Allows loose definition of properties by specifying only partial definitions, such as default value, type or a binding object.\n * @typedef {(string|number|boolean|Array<*>|null|undefined|AnyConstructor|Binding|ReactivePropertyDefinition)} ReactivePropertyDefinitionLoose\n */\nexport type ReactivePropertyDefinitionLoose = string | number | boolean | Array<any> | null | undefined | AnyConstructor | Binding | ReactivePropertyDefinition\n\n/**\n * Instantiates a property definition object from a loosely or strongly typed property definition.\n * It facilitates merging of inherited property definitions from the prototype chain.\n * @class\n * @property {*} [value] The property's value. Can be any type.\n * @property {AnyConstructor} [type] Constructor function defining the property's type.\n * @property {Binding} [binding] Binding object for two-way data synchronization.\n * @property {boolean} [reflect] Whether to reflect the property to an HTML attribute.\n * @property {*} [init] Initialization arguments for constructing initial values.\n */\nexport class ReactiveProtoProperty {\n  declare value?: any\n  declare type?: AnyConstructor\n  declare binding?: Binding\n  declare reflect?: boolean\n  declare init?: any\n  /**\n   * Creates a property definition from various input types.\n   * @param {ReactivePropertyDefinitionLoose} def Input definition which can be:\n   * - `undefined` or `null`: Sets as value\n   * - `AnyConstructor`: Sets as type\n   * - `Binding`: Sets value from binding and stores binding reference\n   * - `ReactivePropertyDefinition`: Copies all defined fields\n   * - Other values: Sets as value\n   * @example\n   * new ReactiveProtoProperty(String) // {type: String}\n   * new ReactiveProtoProperty('hello') // {value: 'hello'}\n   * new ReactiveProtoProperty({value: 42, type: Number}) // {value: 42, type: Number}\n   * new ReactiveProtoProperty(new Binding(node, 'value')) // {value: node.value, binding: ...}\n   */\n  constructor(def: ReactivePropertyDefinitionLoose) {\n    if (def === undefined || def === null) {\n      this.value = def\n    } else if (typeof def === 'function') {\n      this.type = def as AnyConstructor\n    } else if (def instanceof Binding) {\n      this.value = def.value\n      this.binding = def\n    } else if (def && def.constructor === Object) {\n      const d = def as ReactivePropertyDefinition\n      if (Object.hasOwn(d, 'value')) this.value = d.value\n      if (Object.hasOwn(d, 'type')) this.type = d.type\n      if (d.binding instanceof Binding) {\n        this.binding = d.binding\n        this.value = this.binding.value\n      }\n      if (Object.hasOwn(d, 'reflect')) this.reflect = d.reflect\n      if (Object.hasOwn(d, 'init')) this.init = d.init\n    } else if (!(def && def.constructor === Object)) {\n      this.value = def\n    }\n  }\n  /**\n   * Assigns values of another ReactiveProtoProperty to itself, unless they are default values.\n   * @param {ReactiveProtoProperty} protoProp Source ReactiveProtoProperty\n   */\n  assign(protoProp: ReactiveProtoProperty) {\n    if (Object.hasOwn(protoProp, 'value')) this.value = protoProp.value\n    if (Object.hasOwn(protoProp, 'type')) this.type = protoProp.type\n    if (Object.hasOwn(protoProp, 'reflect')) this.reflect = protoProp.reflect\n    if (Object.hasOwn(protoProp, 'init')) this.init = protoProp.init\n    if (Object.hasOwn(protoProp, 'binding')) this.binding = protoProp.binding\n  }\n  /**\n   * Creates a serializable representation of the property definition.\n   * Handles special cases for better JSON serialization:\n   * - Converts object values to their constructor names\n   * - Converts function types to their names\n   * - Only includes defined fields\n   * @returns {object} A plain object suitable for JSON serialization\n   */\n  toJSON() {\n    const json: any = {\n      value: this.value,\n      type: this.type,\n      reflect: this.reflect,\n      init: this.init,\n      binding: this.binding,\n    }\n    if (json.value && typeof json.value === 'object') {\n      json.value = json.value.constructor.name\n    }\n    if (json.type && typeof json.type === 'function') {\n      json.type = json.type.name\n    }\n    return json\n  }\n}\n\nfunction decodeInitArgument(item: any, node: Node | IoElement) {\n  if (item === 'this') {\n    return node\n  } else if (typeof item === 'string' && item.startsWith('this.')) {\n    const keys = item.split('.')\n    let target: any = node\n    for (let i = 1; i < keys.length; i++) {\n      target = target[keys[i]]\n    }\n    if (target) return target\n    console.error(`ReactivePropertyInstance: Invalid path ${item}`)\n  } else return item\n}\n\n/**\n * ReactivePropertyInstance object constructed from `ReactiveProtoProperty`.\n */\nexport class ReactivePropertyInstance {\n  // Property value.\n  value?: any\n  // Constructor of the property value.\n  type?: AnyConstructor\n  // Binding object.\n  binding?: Binding\n  // Reflects to HTML attribute.\n  reflect = false\n  // Initialize property with provided constructor arguments. `null` prevents initialization.\n  init?: any = undefined\n  /**\n   * Creates the property configuration object and copies values from `ReactiveProtoProperty`.\n   * @param node owner Node instance\n   * @param propDef ReactiveProtoProperty object\n   */\n  constructor(node: Node | IoElement, propDef: ReactiveProtoProperty) {\n    debug: {\n      Object.keys(propDef).forEach(key => {\n        if (['value', 'type', 'reflect', 'init', 'binding'].indexOf(key) === -1) {\n          console.warn(`ReactiveProtoProperty: Invalid field ${key}`)\n        }\n      })\n      if (propDef.type !== undefined) {\n        if (typeof propDef.type !== 'function') console.warn('Incorrect type for \"type\" field')\n      }\n      if (propDef.type === NodeArray && propDef.init !== 'this') {\n        console.warn('NodeArray property should be initialized with \"this\"')\n      }\n      if (propDef.binding !== undefined && propDef.binding.constructor !== Binding) console.warn('Incorrect type for \"binding\" field')\n      if (propDef.reflect !== undefined && typeof propDef.reflect !== 'boolean') console.error(`Invalid reflect field ${propDef.reflect}!`)\n    }\n\n    this.value = propDef.value\n    this.type = propDef.type\n    this.binding = propDef.binding\n    if (typeof propDef.reflect === 'boolean') this.reflect = propDef.reflect\n    if (propDef.init !== undefined) this.init = propDef.init\n\n    if (this.binding instanceof Binding) {\n      this.value = this.binding.value\n    } else if (this.value === undefined) {\n      if (this.type === Boolean) this.value = false\n      else if (this.type === String) this.value = ''\n      else if (this.type === Number) this.value = 0\n      else if (typeof this.type === 'function') {\n        if (this.init !== undefined) {\n          if (this.init instanceof Array) {\n            const args = this.init.map(item => decodeInitArgument(item, node))\n            this.value = new this.type(...args)\n          } else if (this.init instanceof Object) {\n            const args: any = {}\n            Object.keys(this.init).forEach(key => {\n              args[key] = decodeInitArgument(this.init[key], node)\n            })\n            this.value = new this.type(args)\n          } else if (this.init === null) {\n            this.value = new this.type()\n          } else {\n            const argument = decodeInitArgument(this.init, node)\n            this.value = new this.type(argument)\n          }\n        }\n      }\n    }\n\n    debug: {\n      if (this.value !== undefined && this.init !== undefined) {\n        if ([String, Number, Boolean].indexOf(this.type as any) !== -1) {\n          if (this.type === Boolean && typeof this.value !== 'boolean' ||\n              this.type === Number && typeof this.value !== 'number' ||\n              this.type === String && typeof this.value !== 'string') {\n            console.warn(`Property: Uninitialized value for type \"${this.type.name}\"!`)\n          }\n        } else {\n          if (typeof this.type === 'function' && !(this.value instanceof this.type)) {\n            console.warn(`Property: Incorrect value \"${this.value}\" for type \"${this.type.name}\"!`)\n          }\n        }\n      }\n    }\n  }\n}"]}