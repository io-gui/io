{"version":3,"file":"NodeArray.js","sourceRoot":"","sources":["../../src/core/NodeArray.ts"],"names":[],"mappings":"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","sourcesContent":["import { ReactiveNode } from '../nodes/ReactiveNode.js'\nimport { IoElement } from '../elements/IoElement.js'\n\n// TODO: test!!!\nexport class NodeArray<N extends ReactiveNode> extends Array<N> {\n  declare private proxy: typeof Proxy\n  private _isInternalOperation = false\n  private _observers = new Set<ReactiveNode | IoElement>()\n\n  static get [Symbol.species]() { return Array }\n\n  constructor(public node: ReactiveNode | IoElement, ...args: any[]) {\n    super(...args)\n    // TODO: Avoid creating empty NodeArrays in models!\n    // TODO: Test thoroughly! Check initializations with items!\n    // console.log('NodeArray constructor', args);\n    this.itemMutated = this.itemMutated.bind(this)\n    this.dispatchMutation = this.dispatchMutation.bind(this)\n\n    // Owner is the primary observer\n    this._observers.add(node)\n\n    debug: if (!(node as ReactiveNode)._isNode && !(node as IoElement)._isIoElement) {\n      console.error('NodeArray constructor called with non-node!')\n    }\n\n    // eslint-disable-next-line @typescript-eslint/no-this-alias\n    const self = this\n    const proxy = new Proxy(this, {\n      get(target: NodeArray<N>, property: string | symbol) {\n        if (typeof property === 'symbol') {\n          return target[property as any]\n        }\n        const index = Number(property)\n        if (!isNaN(index) && index >= 0) {\n          return target[index]\n        }\n        return target[property as any]\n      },\n      set(target: NodeArray<N>, property: string | symbol, value: any) {\n        if (property === 'length') {\n          if (!self._isInternalOperation) {\n            const oldLength = target.length\n            const newLength = Number(value)\n            if (newLength < oldLength) {\n              for (let i = newLength; i < oldLength; i++) {\n                const item = target[i]\n                if (item._isNode) {\n                  item.removeEventListener('io-object-mutation', self.itemMutated)\n                  item.removeParent(self.node as ReactiveNode)\n                }\n              }\n            } else if (newLength > oldLength) {\n              console.warn('NodeArray: cannot extend array with empty slots')\n              return true\n            }\n          }\n          target[property] = value\n          if (!self._isInternalOperation) self.dispatchMutation()\n          return true\n        }\n        const index = Number(property)\n        if (!isNaN(index) && index >= 0) {\n          // TODO Prevent adding to index greater than length?\n          const oldValue = target[index]\n          if (oldValue !== undefined && oldValue._isNode && !self._isInternalOperation) {\n            oldValue.removeEventListener('io-object-mutation', self.itemMutated)\n            oldValue.removeParent(self.node as ReactiveNode)\n          }\n          target[property as any] = value\n          if (value._isNode && !self._isInternalOperation) {\n            value.addEventListener('io-object-mutation', self.itemMutated)\n            value.addParent(self.node as ReactiveNode)\n          }\n          if (!self._isInternalOperation) self.dispatchMutation()\n          return true\n        }\n        target[property as any] = value\n        return true\n      }\n    })\n    Object.defineProperty(this, 'proxy', {value: proxy, enumerable: false, configurable: false})\n    return proxy\n  }\n  // TODO: test!\n  withInternalOperation<T>(operation: () => T): T {\n    this._isInternalOperation = true\n    try {\n      return operation()\n    } finally {\n      this._isInternalOperation = false\n    }\n  }\n  splice(start: number, deleteCount: number, ...items: N[]): N[] {\n    return this.withInternalOperation(() => {\n      for (let i = start; i < start + deleteCount; i++) {\n        const item = this[i]\n        if (item._isNode) {\n          item.removeEventListener('io-object-mutation', this.itemMutated)\n          item.removeParent(this.node as ReactiveNode)\n        }\n      }\n      const result = super.splice(start, deleteCount, ...items)\n      for (let i = start; i < start + items.length; i++) {\n        const item = this[i]\n        if (item._isNode) {\n          item.addEventListener('io-object-mutation', this.itemMutated)\n          item.addParent(this.node as ReactiveNode)\n        }\n      }\n      if (deleteCount || items.length) this.dispatchMutation()\n      return result\n    })\n  }\n  push(...items: N[]): number {\n    return this.withInternalOperation(() => {\n      const result = super.push(...items)\n      for (const item of items) {\n        if (item._isNode) {\n          item.addEventListener('io-object-mutation', this.itemMutated)\n          item.addParent(this.node as ReactiveNode)\n        }\n      }\n      if (items.length) this.dispatchMutation()\n      return result\n    })\n  }\n  unshift(...items: N[]): number {\n    return this.withInternalOperation(() => {\n      const result = super.unshift(...items)\n      for (const item of items) {\n        if (item._isNode) {\n          item.addEventListener('io-object-mutation', this.itemMutated)\n          item.addParent(this.node as ReactiveNode)\n        }\n      }\n      if (items.length) this.dispatchMutation()\n      return result\n    })\n  }\n  pop(): N | undefined {\n    return this.withInternalOperation(() => {\n      const item = super.pop()\n      if (item !== undefined && item._isNode) {\n        item.removeEventListener('io-object-mutation', this.itemMutated)\n        item.removeParent(this.node as ReactiveNode)\n      }\n      if (item !== undefined) this.dispatchMutation()\n      return item\n    })\n  }\n  shift(): N | undefined {\n    return this.withInternalOperation(() => {\n      const item = super.shift()\n      if (item !== undefined && item._isNode) {\n        item.removeEventListener('io-object-mutation', this.itemMutated)\n        item.removeParent(this.node as ReactiveNode)\n      }\n      if (item !== undefined) this.dispatchMutation()\n      return item\n    })\n  }\n  reverse() {\n    return this.withInternalOperation(() => {\n      const result = super.reverse()\n      if (result.length) this.dispatchMutation()\n      return result\n    })\n  }\n  sort(compareFn?: (a: N, b: N) => number) {\n    return this.withInternalOperation(() => {\n      const result = super.sort(compareFn)\n      if (result.length) this.dispatchMutation()\n      return result\n    })\n  }\n  fill(value: N, start?: number, end?: number): this {\n    return this.withInternalOperation(() => {\n      const len = this.length\n      const relativeStart = start ?? 0\n      const relativeEnd = end ?? len\n\n      const actualStart = relativeStart < 0\n        ? Math.max(len + relativeStart, 0)\n        : Math.min(relativeStart, len)\n      const actualEnd = relativeEnd < 0\n        ? Math.max(len + relativeEnd, 0)\n        : Math.min(relativeEnd, len)\n\n      for (let i = actualStart; i < actualEnd; i++) {\n        const oldItem = this[i]\n        if (oldItem !== undefined && oldItem._isNode) {\n          oldItem.removeEventListener('io-object-mutation', this.itemMutated)\n          oldItem.removeParent(this.node as ReactiveNode)\n        }\n      }\n\n      super.fill(value, actualStart, actualEnd)\n\n      for (let i = actualStart; i < actualEnd; i++) {\n        if (value._isNode) {\n          value.addEventListener('io-object-mutation', this.itemMutated)\n          value.addParent(this.node as ReactiveNode)\n        }\n      }\n\n      if (actualEnd > actualStart) this.dispatchMutation()\n      return this\n    })\n  }\n  copyWithin(target: number, start?: number, end?: number): this {\n    return this.withInternalOperation(() => {\n      const len = this.length\n      const relativeTarget = target\n      const relativeStart = start ?? 0\n      const relativeEnd = end ?? len\n\n      const actualTarget = relativeTarget < 0\n        ? Math.max(len + relativeTarget, 0)\n        : Math.min(relativeTarget, len)\n      const actualStart = relativeStart < 0\n        ? Math.max(len + relativeStart, 0)\n        : Math.min(relativeStart, len)\n      const actualEnd = relativeEnd < 0\n        ? Math.max(len + relativeEnd, 0)\n        : Math.min(relativeEnd, len)\n\n      const count = Math.min(actualEnd - actualStart, len - actualTarget)\n      if (count <= 0) return this\n\n      for (let i = actualTarget; i < actualTarget + count; i++) {\n        const oldItem = this[i]\n        if (oldItem !== undefined && oldItem._isNode) {\n          oldItem.removeEventListener('io-object-mutation', this.itemMutated)\n          oldItem.removeParent(this.node as ReactiveNode)\n        }\n      }\n\n      super.copyWithin(actualTarget, actualStart, actualEnd)\n\n      for (let i = actualTarget; i < actualTarget + count; i++) {\n        const item = this[i]\n        if (item._isNode) {\n          item.addEventListener('io-object-mutation', this.itemMutated)\n          item.addParent(this.node as ReactiveNode)\n        }\n      }\n\n      this.dispatchMutation()\n      return this\n    })\n  }\n  addObserver(node: ReactiveNode | IoElement) {\n    this._observers.add(node)\n  }\n  removeObserver(node: ReactiveNode | IoElement) {\n    this._observers.delete(node)\n  }\n  itemMutated(event: CustomEvent) {\n    for (const observer of this._observers) {\n      observer.dispatch('io-object-mutation', {object: this.proxy, property: event.detail.index})\n    }\n  }\n  dispatchMutation() {\n    for (const observer of this._observers) {\n      observer.dispatch('io-object-mutation', {object: this.proxy})\n    }\n  }\n}"]}