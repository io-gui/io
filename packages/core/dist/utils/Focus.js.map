{"version":3,"file":"Focus.js","sourceRoot":"","sources":["../../src/utils/Focus.ts"],"names":[],"mappings":"AACA,OAAO,EAAE,cAAc,EAAE,MAAM,mBAAmB,CAAA;AAClD,OAAO,EAAE,kBAAkB,IAAI,OAAO,EAAE,MAAM,0BAA0B,CAAA;AAExE,gCAAgC;AAChC,wGAAwG;AAExG,qCAAqC;AAErC,MAAM,cAAc,GAAG,IAAI,OAAO,EAAE,CAAA;AAEpC,MAAM,YAAY,GAAiC;IACjD,SAAS,EAAE,YAAY;IACvB,UAAU,EAAE,WAAW;IACvB,SAAS,EAAE,SAAS;IACpB,OAAO,EAAE,WAAW;CACrB,CAAA;AAED,SAAS,iBAAiB,CAAC,OAAgC,EAAE,GAAc,EAAE,MAA+B;IAC1G,cAAc,CAAC,GAAG,CAAC,OAAO,EAAE;QAC1B,GAAG,EAAE,YAAY,CAAC,GAAG,CAAC;QACtB,MAAM,EAAE,MAAM;KACf,CAAC,CAAA;AACJ,CAAC;AAED,SAAS,eAAe,CAAC,KAAc,EAAE,KAAc,EAAE,UAAkB,CAAC;IAC1E,IAAI,KAAK,CAAC,KAAK,GAAG,KAAK,CAAC,IAAI,IAAI,KAAK,CAAC,KAAK,GAAG,KAAK,CAAC,IAAI,IAAI,KAAK,CAAC,MAAM,GAAG,KAAK,CAAC,GAAG,IAAI,KAAK,CAAC,MAAM,GAAG,KAAK,CAAC,GAAG,EAAE,CAAC;QACjH,OAAO,CAAC,CAAA;IACV,CAAC;IACD,IAAI,EAAE,GAAG,CAAC,EAAE,EAAE,GAAG,CAAC,CAAA;IAClB,MAAM,YAAY,GAAG,cAAc,CAAC,WAAW,GAAG,CAAC,CAAA;IAEnD,IAAI,KAAK,CAAC,KAAK,GAAG,KAAK,CAAC,IAAI;QAAE,EAAE,GAAG,IAAI,CAAC,GAAG,CAAC,YAAY,EAAE,KAAK,CAAC,IAAI,GAAG,KAAK,CAAC,KAAK,CAAC,CAAA;SAC9E,IAAI,KAAK,CAAC,KAAK,GAAG,KAAK,CAAC,IAAI;QAAE,EAAE,GAAG,IAAI,CAAC,GAAG,CAAC,YAAY,EAAE,KAAK,CAAC,IAAI,GAAG,KAAK,CAAC,KAAK,CAAC,CAAA;IACxF,IAAI,KAAK,CAAC,MAAM,GAAG,KAAK,CAAC,GAAG;QAAE,EAAE,GAAG,IAAI,CAAC,GAAG,CAAC,YAAY,EAAE,KAAK,CAAC,GAAG,GAAG,KAAK,CAAC,MAAM,CAAC,CAAA;SAC9E,IAAI,KAAK,CAAC,MAAM,GAAG,KAAK,CAAC,GAAG;QAAE,EAAE,GAAG,IAAI,CAAC,GAAG,CAAC,YAAY,EAAE,KAAK,CAAC,GAAG,GAAG,KAAK,CAAC,MAAM,CAAC,CAAA;IACxF,EAAE,GAAG,EAAE,GAAG,OAAO,CAAA;IACjB,EAAE,GAAG,EAAE,GAAG,OAAO,CAAA;IACjB,OAAO,CAAC,EAAE,IAAE,CAAC,GAAG,EAAE,IAAE,CAAC,CAAC,IAAE,GAAG,CAAA;AAC7B,CAAC;AAED,SAAS,iBAAiB,CAAC,KAAc,EAAE,KAAc,EAAE,UAAkB,CAAC;IAC5E,MAAM,EAAE,GAAG,EAAC,CAAC,EAAE,KAAK,CAAC,CAAC,GAAG,KAAK,CAAC,KAAK,GAAG,CAAC,EAAE,CAAC,EAAE,KAAK,CAAC,CAAC,GAAG,KAAK,CAAC,MAAM,GAAG,CAAC,EAAC,CAAA;IACxE,MAAM,EAAE,GAAG,EAAC,CAAC,EAAE,KAAK,CAAC,CAAC,GAAG,KAAK,CAAC,KAAK,GAAG,CAAC,EAAE,CAAC,EAAE,KAAK,CAAC,CAAC,GAAG,KAAK,CAAC,MAAM,GAAG,CAAC,EAAC,CAAA;IACxE,IAAI,EAAE,GAAG,EAAE,CAAC,CAAC,GAAG,EAAE,CAAC,CAAC,CAAA;IACpB,IAAI,EAAE,GAAG,EAAE,CAAC,CAAC,GAAG,EAAE,CAAC,CAAC,CAAA;IACpB,EAAE,GAAG,EAAE,GAAG,OAAO,CAAA;IACjB,EAAE,GAAG,EAAE,GAAG,OAAO,CAAA;IACjB,OAAO,CAAC,EAAE,IAAE,CAAC,GAAG,EAAE,IAAE,CAAC,CAAC,IAAE,GAAG,CAAA;AAC7B,CAAC;AAED,SAAS,WAAW,CAAC,KAAkB;IACrC,MAAM,GAAG,GAAG,KAAK,CAAC,MAAM,CAAC,MAAM,CAAA;IAC/B,MAAM,OAAO,GAAG,GAAG,CAAC,qBAAqB,EAAE,CAAA;IAC3C,MAAM,GAAG,GAAG,KAAK,CAAC,MAAM,CAAC,OAAO,CAAA;IAEhC,MAAM,SAAS,GAAG,OAAO,CAAC,QAAQ,CAAC,GAAG,CAAC,CAAA;IAEvC,IAAI,cAAc,GAAG,GAAG,CAAA;IACxB,IAAI,eAAe,GAAG,QAAQ,CAAA;IAC9B,IAAI,qBAAqB,GAAG,QAAQ,CAAA;IAEpC,MAAM,SAAS,GAAG,cAAc,CAAC,GAAG,CAAC,GAAG,CAAC,CAAA;IAEzC,IAAI,SAAS,IAAI,SAAS,CAAC,GAAG,KAAK,GAAG,EAAE,CAAC;QACvC,MAAM,MAAM,GAAG,SAAS,CAAC,MAAM,CAAA;QAC/B,IAAI,OAAO,GAAG,IAAI,CAAA;QAClB,IAAI,CAAC,MAAM,CAAC,YAAY,IAAI,MAAM,KAAK,GAAG,EAAE,CAAC;YAC3C,OAAO,GAAG,KAAK,CAAA;QACjB,CAAC;aAAM,CAAC;YACN,MAAM,MAAM,GAAG,MAAM,CAAC,gBAAgB,CAAC,MAAM,CAAC,CAAA;YAC9C,IAAI,MAAM,CAAC,UAAU,KAAK,SAAS,IAAI,MAAM,CAAC,OAAO,KAAK,MAAM,EAAE,CAAC;gBACjE,OAAO,GAAG,KAAK,CAAA;YACjB,CAAC;QACH,CAAC;QACD,IAAI,OAAO,EAAE,CAAC;YACZ,MAAM,CAAC,KAAK,EAAE,CAAA;YACd,iBAAiB,CAAC,MAAM,EAAE,GAAG,EAAE,GAAG,CAAC,CAAA;YACnC,OAAM;QACR,CAAC;IACH,CAAC;IAED,MAAM,IAAI,GAAG,SAAS,CAAC,CAAC,CAAC,OAAsB,CAAC,CAAC,CAAC,QAAQ,CAAA;IAC1D,IAAI,mBAAmB,GAAG,KAAK,CAAC,IAAI,CAAC,IAAI,CAAC,gBAAgB,CAAC,cAAc,GAAG,CAAC,QAAQ,IAAI,CAAC,+CAA+C,CAAC,CAAkB,CAAA;IAC5J,MAAM,0BAA0B,GAAG,KAAK,CAAC,IAAI,CAAC,GAAG,CAAC,aAAa,CAAC,gBAAgB,CAAC,cAAc,GAAG,CAAC,QAAQ,IAAI,CAAC,+CAA+C,CAAC,CAAkB,CAAA;IAClL,mBAAmB,GAAG,mBAAmB,CAAC,MAAM,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,YAAY,KAAK,IAAI,CAAC,CAAA;IAChF,mBAAmB,GAAG,mBAAmB,CAAC,MAAM,CAAC,EAAE,CAAC,EAAE;QACpD,MAAM,KAAK,GAAG,MAAM,CAAC,gBAAgB,CAAC,EAAE,CAAC,CAAA;QACzC,OAAO,KAAK,CAAC,OAAO,KAAK,MAAM,IAAI,KAAK,CAAC,UAAU,KAAK,QAAQ,IAAI,KAAK,CAAC,OAAO,KAAK,GAAG,CAAA;IAC3F,CAAC,CAAC,CAAA;IAEF,IAAI,GAAG,KAAK,KAAK,EAAE,CAAC;QAClB,MAAM,KAAK,GAAG,mBAAmB,CAAC,OAAO,CAAC,GAAG,CAAC,CAAA;QAC9C,IAAI,KAAK,KAAK,CAAC,CAAC,EAAE,CAAC;YACjB,mBAAmB,CAAC,CAAC,KAAK,GAAG,CAAC,CAAC,GAAG,mBAAmB,CAAC,MAAM,CAAC,CAAC,KAAK,EAAE,CAAA;QACvE,CAAC;QACD,OAAM;IACR,CAAC;SAAM,IAAI,GAAG,KAAK,MAAM,EAAE,CAAC;QAC1B,mBAAmB,CAAC,CAAC,CAAC,CAAC,KAAK,EAAE,CAAA;QAC9B,OAAM;IACR,CAAC;SAAM,IAAI,GAAG,KAAK,KAAK,EAAE,CAAC;QACzB,mBAAmB,CAAC,mBAAmB,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC,KAAK,EAAE,CAAA;QAC3D,OAAM;IACR,CAAC;SAAM,IAAI,GAAG,KAAK,QAAQ,EAAE,CAAC;QAC5B,0BAA0B,CAAC,CAAC,CAAC,CAAC,KAAK,EAAE,CAAA;QACrC,OAAM;IACR,CAAC;SAAM,IAAI,GAAG,KAAK,UAAU,EAAE,CAAC;QAC9B,0BAA0B,CAAC,0BAA0B,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC,KAAK,EAAE,CAAA;QACzE,OAAM;IACR,CAAC;SAAM,IAAI,CAAC,WAAW,EAAE,YAAY,EAAE,WAAW,EAAE,SAAS,CAAC,CAAC,QAAQ,CAAC,GAAG,CAAC,EAAE,CAAC;QAC7E,KAAK,IAAI,CAAC,GAAG,mBAAmB,CAAC,MAAM,EAAE,CAAC,EAAE,GAAG,CAAC;YAC9C,MAAM,SAAS,GAAG,mBAAmB,CAAC,CAAC,CAAC,CAAA;YACxC,IAAI,CAAC,SAAS,CAAC,YAAY,IAAI,SAAS,KAAK,GAAG,EAAE,CAAC;gBACjD,SAAQ;YACV,CAAC;YACD,MAAM,MAAM,GAAG,MAAM,CAAC,gBAAgB,CAAC,SAAS,CAAC,CAAA;YACjD,IAAI,MAAM,CAAC,UAAU,KAAK,SAAS,IAAI,MAAM,CAAC,OAAO,KAAK,MAAM,EAAE,CAAC;gBACjE,SAAQ;YACV,CAAC;YACD,MAAM,IAAI,GAAG,SAAS,CAAC,qBAAqB,EAAE,CAAA;YAC9C,IAAI,GAAG,KAAK,YAAY,IAAI,IAAI,CAAC,IAAI,GAAG,OAAO,CAAC,KAAK;gBAAE,SAAQ;YAC/D,IAAI,GAAG,KAAK,WAAW,IAAI,IAAI,CAAC,KAAK,GAAG,OAAO,CAAC,IAAI;gBAAE,SAAQ;YAC9D,IAAI,GAAG,KAAK,WAAW,IAAI,IAAI,CAAC,GAAG,GAAG,OAAO,CAAC,MAAM;gBAAE,SAAQ;YAC9D,IAAI,GAAG,KAAK,SAAS,IAAI,IAAI,CAAC,MAAM,GAAG,OAAO,CAAC,GAAG;gBAAE,SAAQ;YAE5D,MAAM,aAAa,GAAG,CAAC,CAAA;YACvB,MAAM,OAAO,GAAG,GAAG,KAAK,WAAW,IAAI,GAAG,KAAK,YAAY,CAAC,CAAC,CAAC,CAAC,GAAG,aAAa,CAAC,CAAC,CAAC,aAAa,CAAA;YAE/F,MAAM,QAAQ,GAAG,eAAe,CAAC,OAAO,EAAE,IAAI,EAAE,OAAO,CAAC,CAAA;YACxD,MAAM,cAAc,GAAG,iBAAiB,CAAC,OAAO,EAAE,IAAI,EAAE,OAAO,CAAC,CAAA;YAChE,IAAI,QAAQ,GAAG,eAAe,EAAE,CAAC;gBAC/B,eAAe,GAAG,QAAQ,CAAA;gBAC1B,qBAAqB,GAAG,cAAc,CAAA;gBACtC,cAAc,GAAG,SAAS,CAAA;YAC5B,CAAC;iBAAM,IAAI,QAAQ,KAAK,eAAe,IAAI,cAAc,GAAG,qBAAqB,EAAE,CAAC;gBAClF,qBAAqB,GAAG,cAAc,CAAA;gBACtC,cAAc,GAAG,SAAS,CAAA;YAC5B,CAAC;QACH,CAAC;QACD,IAAI,cAAc,KAAK,GAAG,EAAE,CAAC;YAC1B,cAAsB,CAAC,KAAK,EAAE,CAAA;YAC/B,iBAAiB,CAAC,cAAc,EAAE,GAAG,EAAE,GAAG,CAAC,CAAA;QAC7C,CAAC;IACH,CAAC;AACH,CAAC;AAED,QAAQ,CAAC,gBAAgB,CAAC,aAAa,EAAE,WAA4B,CAAC,CAAA","sourcesContent":["import { IoElement } from '../elements/IoElement.js'\nimport { ThemeSingleton } from '../nodes/Theme.js'\nimport { IoOverlaySingleton as Overlay } from '../elements/IoOverlay.js'\n\n// TODO: improve focus algorithm\n// Note: focus string field in IoInspector demo and use arrowleft - notice focus shift is not intuitive.\n\n// TODO: Home, End, PageUp, PageDown?\n\nconst focusBacktrack = new WeakMap()\ntype Direction = 'ArrowLeft' | 'ArrowRight' | 'ArrowDown' | 'ArrowUp'\nconst backtrackDir: Record<Direction, Direction> = {\n  ArrowLeft: 'ArrowRight',\n  ArrowRight: 'ArrowLeft',\n  ArrowDown: 'ArrowUp',\n  ArrowUp: 'ArrowDown'\n}\n\nfunction setFocusBacktrack(element: HTMLElement | IoElement, dir: Direction, source: HTMLElement | IoElement) {\n  focusBacktrack.set(element, {\n    dir: backtrackDir[dir],\n    source: source\n  })\n}\n\nfunction getRectDistance(rect1: DOMRect, rect2: DOMRect, dirBias: number = 1) {\n  if (rect1.right > rect2.left && rect2.right > rect1.left && rect1.bottom > rect2.top && rect2.bottom > rect1.top) {\n    return 0\n  }\n  let dx = 0, dy = 0\n  const MIN_DISTANCE = ThemeSingleton.fieldHeight / 2\n\n  if (rect1.right < rect2.left) dx = Math.max(MIN_DISTANCE, rect2.left - rect1.right)\n  else if (rect2.right < rect1.left) dx = Math.max(MIN_DISTANCE, rect1.left - rect2.right)\n  if (rect1.bottom < rect2.top) dy = Math.max(MIN_DISTANCE, rect2.top - rect1.bottom)\n  else if (rect2.bottom < rect1.top) dy = Math.max(MIN_DISTANCE, rect1.top - rect2.bottom)\n  dx = dx * dirBias\n  dy = dy / dirBias\n  return (dx**2 + dy**2)**0.5\n}\n\nfunction getCenterDistance(rect1: DOMRect, rect2: DOMRect, dirBias: number = 1) {\n  const c1 = {x: rect1.x + rect1.width / 2, y: rect1.y + rect1.height / 2}\n  const c2 = {x: rect2.x + rect2.width / 2, y: rect2.y + rect2.height / 2}\n  let dx = c1.x - c2.x\n  let dy = c1.y - c2.y\n  dx = dx * dirBias\n  dy = dy / dirBias\n  return (dx**2 + dy**2)**0.5\n}\n\nfunction onIoFocusTo(event: CustomEvent) {\n  const src = event.detail.source\n  const srcRect = src.getBoundingClientRect()\n  const cmd = event.detail.command\n\n  const inoverlay = Overlay.contains(src)\n\n  let closestElement = src\n  let closestDistance = Infinity\n  let closestCenterDistance = Infinity\n\n  const backtrack = focusBacktrack.get(src)\n\n  if (backtrack && backtrack.dir === cmd) {\n    const source = backtrack.source\n    let visible = true\n    if (!source.offsetParent || source === src) {\n      visible = false\n    } else {\n      const sStyle = window.getComputedStyle(source)\n      if (sStyle.visibility !== 'visible' || sStyle.display === 'none') {\n        visible = false\n      }\n    }\n    if (visible) {\n      source.focus()\n      setFocusBacktrack(source, cmd, src)\n      return\n    }\n  }\n\n  const root = inoverlay ? Overlay as HTMLElement : document\n  let focusableCandidates = Array.from(root.querySelectorAll(`[tabIndex=\"${src.tabIndex || 0}\"]:not([disabled]):not([inert]):not([hidden])`)) as HTMLElement[]\n  const focusableSiblingCandidates = Array.from(src.parentElement.querySelectorAll(`[tabIndex=\"${src.tabIndex || 0}\"]:not([disabled]):not([inert]):not([hidden])`)) as HTMLElement[]\n  focusableCandidates = focusableCandidates.filter(el => el.offsetParent !== null)\n  focusableCandidates = focusableCandidates.filter(el => {\n    const style = window.getComputedStyle(el)\n    return style.display !== 'none' && style.visibility !== 'hidden' && style.opacity !== '0'\n  })\n\n  if (cmd === 'Tab') {\n    const index = focusableCandidates.indexOf(src)\n    if (index !== -1) {\n      focusableCandidates[(index + 1) % focusableCandidates.length].focus()\n    }\n    return\n  } else if (cmd === 'Home') {\n    focusableCandidates[0].focus()\n    return\n  } else if (cmd === 'End') {\n    focusableCandidates[focusableCandidates.length - 1].focus()\n    return\n  } else if (cmd === 'PageUp') {\n    focusableSiblingCandidates[0].focus()\n    return\n  } else if (cmd === 'PageDown') {\n    focusableSiblingCandidates[focusableSiblingCandidates.length - 1].focus()\n    return\n  } else if (['ArrowLeft', 'ArrowRight', 'ArrowDown', 'ArrowUp'].includes(cmd)) {\n    for (let i = focusableCandidates.length; i--;) {\n      const candidate = focusableCandidates[i]\n      if (!candidate.offsetParent || candidate === src) {\n        continue\n      }\n      const sStyle = window.getComputedStyle(candidate)\n      if (sStyle.visibility !== 'visible' || sStyle.display === 'none') {\n        continue\n      }\n      const rect = candidate.getBoundingClientRect()\n      if (cmd === 'ArrowRight' && rect.left < srcRect.right) continue\n      if (cmd === 'ArrowLeft' && rect.right > srcRect.left) continue\n      if (cmd === 'ArrowDown' && rect.top < srcRect.bottom) continue\n      if (cmd === 'ArrowUp' && rect.bottom > srcRect.top) continue\n\n      const biasMagnitude = 4\n      const dirBias = cmd === 'ArrowLeft' || cmd === 'ArrowRight' ? 1 / biasMagnitude : biasMagnitude\n\n      const distance = getRectDistance(srcRect, rect, dirBias)\n      const centerDistance = getCenterDistance(srcRect, rect, dirBias)\n      if (distance < closestDistance) {\n        closestDistance = distance\n        closestCenterDistance = centerDistance\n        closestElement = candidate\n      } else if (distance === closestDistance && centerDistance < closestCenterDistance) {\n        closestCenterDistance = centerDistance\n        closestElement = candidate\n      }\n    }\n    if (closestElement !== src) {\n      (closestElement as any).focus()\n      setFocusBacktrack(closestElement, cmd, src)\n    }\n  }\n}\n\ndocument.addEventListener('io-focus-to', onIoFocusTo as EventListener)\n"]}